<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Support Dashboard - Pet Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" rel="stylesheet">
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        #messagesContainer {
            flex: 1;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .unread .session-name,
        .unread .session-preview {
            font-weight: 700;
            color: #03594D;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        #ticketPopup ::-webkit-scrollbar {
            width: 8px;
        }

        #ticketPopup ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #ticketPopup ::-webkit-scrollbar-thumb {
            background: #03594D;
            border-radius: 10px;
        }

        #ticketPopup ::-webkit-scrollbar-thumb:hover {
            background: #026B5E;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-[#F8F9FA] font-sans">
<div class="grid grid-cols-[220px_1fr] h-screen">

    <div th:replace="staff/layout/layout-staff :: sidebar(${staff}, ${mySessions}, ${openTickets}, 'chat')"></div>

    <!-- Main Content Area -->
    <main class="flex flex-col overflow-hidden">
        <!-- Top bar -->
        <div class="bg-white border-b border-[#E3E5D2] px-8 py-5 flex justify-between items-center shadow-sm">
            <div>
                <h1 class="text-[#03594D] text-3xl font-black leading-tight tracking-tight">H·ªó Tr·ª£ Tr√≤ Chuy·ªán</h1>
                <p class="text-sm text-gray-500 mt-1">Qu·∫£n l√Ω c√°c cu·ªôc tr√≤ chuy·ªán v√† h·ªó tr·ª£ kh√°ch h√†ng</p>
            </div>
            <div class="flex gap-3">
                <div class="bg-emerald-50 rounded-lg px-5 py-3 text-center border border-emerald-200">
                    <div class="text-2xl font-black text-emerald-600" th:text="${#lists.size(mySessions)}"></div>
                    <div class="text-xs text-emerald-700 font-bold">ƒêang x·ª≠ l√Ω</div>
                </div>
                <div class="bg-orange-50 rounded-lg px-5 py-3 text-center border border-orange-200">
                    <div class="text-2xl font-black text-orange-600" th:text="${#lists.size(waitingSessions)}"></div>
                    <div class="text-xs text-orange-700 font-bold">Ch·ªù ph·∫£n h·ªìi</div>
                </div>
                <div class="bg-blue-50 rounded-lg px-5 py-3 text-center border border-blue-200">
                    <div class="text-2xl font-black text-blue-600" th:text="${#lists.size(openTickets)}"></div>
                    <div class="text-xs text-blue-700 font-bold">Tickets</div>
                </div>
            </div>
        </div>

        <!-- Chat area -->
        <div class="grid grid-cols-[280px_1fr_320px] flex-1 overflow-hidden min-h-0">
            <!-- Left panel: Sessions List -->
            <div class="bg-white border-r border-[#E3E5D2] flex flex-col flex-1 min-h-0 overflow-hidden">
            <!-- Waiting customers -->
                <div class="border-b border-[#E3E5D2] flex flex-col min-h-0" >
                    <div class="p-3 bg-orange-50 border-b border-orange-200
            cursor-pointer select-none flex items-center justify-between"
                         onclick="toggleAccordion('waitingContent','waitingArrow')">
                        <div class="text-xs font-black text-orange-800 uppercase flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">notifications_active</span>
                            ƒêang ch·ªù (<span id="waitingCount" th:text="${#lists.size(waitingSessions)}"></span>)
                        </div>
                        <span id="waitingArrow"
                              class="material-symbols-outlined text-orange-600
               transition-transform duration-300 rotate-180">
                expand_more
                    </span>
                    </div>
                    <div id="waitingContent"
                         class="space-y-2 flex-1 min-h-0 overflow-y-auto bg-orange-50/30 transition-all duration-300">
                        <div th:if="${#lists.isEmpty(waitingSessions)}" class="text-center text-gray-400 py-14 text-sm">
                            Kh√¥ng c√≥ kh√°ch h√†ng ƒëang ch·ªù
                        </div>
                        <div th:each="chatSession : ${waitingSessions}"
                             class="bg-white border-2 border-orange-300 rounded-lg p-3 hover:shadow-md transition cursor-pointer">
                            <div class="font-bold text-sm text-[#03594D]"
                                 th:text="${chatSession.customer.fullName}"></div>
                            <div class="text-xs text-gray-500 font-mono"
                                 th:text="${'ƒê·ª£i t·ª´ ' + #temporals.format(chatSession.startedAt, 'HH:mm')}"></div>
                            <button class="w-full mt-2 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-md text-sm font-bold shadow-sm"
                                    th:onclick="'acceptSession(' + ${chatSession.id} + ')'">
                                Nh·∫≠n chat
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active sessions -->
                <div class="overflow-hidden flex flex-col min-h-0">
                    <div class="p-3 border-b border-[#E3E5D2] bg-[#F8F9FA]
            cursor-pointer select-none flex items-center justify-between"
                         onclick="toggleAccordion('activeContent','activeArrow')">

                        <div class="text-xs font-black text-gray-600 uppercase flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">chat</span>
                            ƒêang x·ª≠ l√Ω (<span th:text="${#lists.size(mySessions)}"></span>)
                        </div>

                        <span id="activeArrow"
                              class="material-symbols-outlined text-gray-500
               transition-transform duration-300 rotate-180">
    expand_more
  </span>
                    </div>

                    <!-- CONTENT -->
                    <div id="activeContent"
                         class="space-y-2 flex-1 min-h-0 overflow-y-auto transition-all duration-300">

                        <!-- Empty state -->
                        <div th:if="${#lists.isEmpty(mySessions)}"
                             class="flex flex-col items-center justify-center text-gray-400 py-14">
                            <div class="text-4xl mb-2">üí¨</div>
                            <div class="text-sm">Ch∆∞a c√≥ chat n√†o</div>
                        </div>

                        <!-- Session list -->
                        <div th:each="chatSession, iterStat : ${mySessions}"
                             th:id="'session-' + ${chatSession.id}"
                             th:data-session-id="${chatSession.id}"
                             th:data-customer-full-name="${chatSession.customer.fullName}"
                             th:data-customer-phone="${chatSession.customer.phone}"
                             th:data-customer-email="${chatSession.customer.email}"
                             th:data-customer-username="${chatSession.customer.username}"
                             th:data-customer-id="${chatSession.customer.userId}"
                             class="p-4 border-b border-[#E3E5D2] hover:bg-[#F8F9FA] cursor-pointer"
                             th:classappend="
       (${iterStat.first} ? ' border-l-4 border-l-[#D8E268] bg-[#F8F9FA]' : '')
       + (${chatSession.unreadCount > 0} ? ' unread' : '')
     "
                             onclick="handleLoadSession(this)">

                            <div class="flex justify-between items-start mb-1">
                                <div class="font-bold text-[#03594D] session-name"
                                     th:text="${chatSession.customer.fullName}">
                                </div>

                                <span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5
                     rounded border border-emerald-200 font-bold">
            ONLINE
        </span>
                            </div>

                            <div class="flex justify-between items-center gap-2">
                                <div class="text-sm text-gray-600 truncate max-w-[170px] session-preview"
                                     th:text="${chatSession.lastMessagePreview}">
                                </div>

                                <span th:if="${chatSession.unreadCount > 0}"
                                      class="unread-badge min-w-[20px] h-[20px] text-[11px]
                     bg-red-500 text-white font-bold
                     rounded-full flex items-center justify-center">
            <span th:text="${chatSession.unreadCount}"></span>
        </span>
                            </div>

                            <div class="text-xs text-gray-400 mt-1 font-mono"
                                 th:text="${#temporals.format(chatSession.startedAt, 'HH:mm')}">
                            </div>
                        </div>


                    </div>
                </div>

                <!-- Open Tickets -->
                <div class="border-t border-[#E3E5D2] flex flex-col min-h-0">
                    <div class="p-3 border-b border-[#E3E5D2] bg-blue-50
            cursor-pointer select-none flex items-center justify-between"
                         onclick="toggleAccordion('ticketsContent','ticketsArrow')">
                        <div class="text-xs font-black text-blue-800 uppercase flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">confirmation_number</span>
                            Tickets ƒëang m·ªü (<span id="openTicketsCount"  th:text="${#lists.size(openTickets)}"></span>)
                        </div>
                        <span id="ticketsArrow"
                              class="material-symbols-outlined text-blue-600
               transition-transform duration-300 rotate-180">
    expand_more
  </span>
                    </div>
                    <div id="ticketsContent"
                         class="space-y-2 flex-1 min-h-0 overflow-y-auto  transition-all duration-300">

                        <div th:if="${#lists.isEmpty(openTickets)}"
                             class="text-center text-gray-400 py-14 text-sm">
                            Kh√¥ng c√≥ ticket ƒëang m·ªü
                        </div>

                        <div th:each="ticket : ${openTickets}"
                             th:id="'ticket-' + ${ticket.id}"
                             th:onclick="'window.location.href=\'/support/tickets/' + ${ticket.id} + '\''"
                             class="bg-white border border-blue-200 rounded-lg p-3 hover:shadow-md transition cursor-pointer">

                            <div class="flex justify-between items-center mb-1">
                                <div class="font-bold text-sm text-[#03594D]"
                                     th:text="${ticket.subject}">
                                    L·ªói thanh to√°n
                                </div>

                                <span class="text-[10px] px-2 py-0.5 rounded font-bold"
                                      th:classappend="
                ${ticket.priority.name() == 'HIGH'} ? 'bg-red-100 text-red-700' :
                (${ticket.priority.name() == 'MEDIUM'} ? 'bg-orange-100 text-orange-700' :
                'bg-gray-100 text-gray-600')"
                                      th:text="${ticket.priority}">
        </span>
                            </div>

                            <div class="text-xs text-gray-500 truncate"
                                 th:text="${ticket.description}">
                                M√¥ t·∫£ ticket...
                            </div>

                            <div class="flex justify-between items-center mt-2 text-xs text-gray-400 font-mono">
                                <span th:text="${ticket.customer.fullName}">Nguy·ªÖn VƒÉn A</span>
                                <span th:text="${#temporals.format(ticket.createdAt,'HH:mm')}">10:20</span>
                            </div>
                        </div>

                    </div>
                </div>


                <!-- Assigned Tickets -->
                <div class="border-t border-[#E3E5D2]">
                    <div class="p-3 border-b border-[#E3E5D2] bg-blue-50
            cursor-pointer select-none flex items-center justify-between"
                         onclick="toggleAccordion('assignedTicketsContent','assignedTicketsArrow')">
                        <div class="text-xs font-black text-blue-800 uppercase flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">confirmation_number</span>
                            Tickets c·ªßa b·∫°n (<span id="assignedTicketsCount" th:text="${#lists.size(assignedOpenTickets)}"></span>)
                        </div>
                        <span id="assignedTicketsArrow"
                              class="material-symbols-outlined text-blue-600
               transition-transform duration-300 rotate-180">
    expand_more
  </span>
                    </div>
                    <div id="assignedTicketsContent"
                         class="space-y-2 flex-1 overflow-y-auto  transition-all duration-300">

                        <div th:if="${#lists.isEmpty(assignedOpenTickets)}"
                             class="text-center text-gray-400 py-14 text-sm">
                            Kh√¥ng c√≥ ticket n√†o ƒë∆∞·ªõc g√°n cho b·∫°n
                        </div>

                        <div th:each="ticket : ${assignedOpenTickets}"
                             th:id="'ticket-' + ${ticket.id}"
                             th:onclick="'window.location.href=\'/support/tickets/' + ${ticket.id} + '\''"
                             class="bg-white border border-blue-200 rounded-lg p-3 hover:shadow-md transition cursor-pointer">

                            <div class="flex justify-between items-center mb-1">
                                <div class="font-bold text-sm text-[#03594D]"
                                     th:text="${ticket.subject}">
                                    L·ªói thanh to√°n
                                </div>

                                <span class="text-[10px] px-2 py-0.5 rounded font-bold"
                                      th:classappend="
                ${ticket.priority.name() == 'HIGH'} ? 'bg-red-100 text-red-700' :
                (${ticket.priority.name() == 'MEDIUM'} ? 'bg-orange-100 text-orange-700' :
                'bg-gray-100 text-gray-600')"
                                      th:text="${ticket.priority}">
        </span>
                            </div>

                            <div class="text-xs text-gray-500 truncate"
                                 th:text="${ticket.description}">
                                M√¥ t·∫£ ticket...
                            </div>

                            <div class="flex justify-between items-center mt-2 text-xs text-gray-400 font-mono">
                                <span th:text="${ticket.customer.fullName}"></span>
                                <span th:text="${#temporals.format(ticket.createdAt,'HH:mm')}">10:20</span>
                            </div>
                        </div>

                    </div>
                </div>


            </div>

            <!-- Banner khi ch∆∞a ch·ªçn chat -->
            <div id="selectChatBanner"
                 class="flex flex-col items-center justify-center flex-1 bg-gradient-to-br from-[#F8F9FA] to-[#EEF1F4]">

                <div class="flex flex-col items-center text-center animate-fadeIn">
                    <!-- Icon l·ªõn -->
                    <div class="w-28 h-28 rounded-full bg-gradient-to-br from-[#03594D] to-[#D8E268]
                flex items-center justify-center shadow-xl mb-6 animate-float">
      <span class="material-symbols-outlined text-white text-[64px]">
        forum
      </span>
                    </div>

                    <h2 class="text-3xl font-black text-[#03594D] mb-2">
                        Ch·ªçn chat ƒë·ªÉ b·∫Øt ƒë·∫ßu
                    </h2>

                    <p class="text-gray-500 max-w-md text-sm leading-relaxed">
                        Vui l√≤ng ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ·ªü danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªó tr·ª£ kh√°ch h√†ng
                    </p>
                </div>
            </div>


            <!-- Center: Chat window -->
            <div id="chatPanel" class="flex flex-col bg-[#F8F9FA] min-h-0 hidden">
                <!-- Chat header -->
                <div class="bg-white border-b border-[#E3E5D2] p-4 flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-[#03594D] to-[#D8E268] rounded-full flex items-center justify-center text-white font-black text-lg shadow-md"
                             id="chatHeaderAvatar">
                            N
                        </div>
                        <div>
                            <div class="font-bold text-[#03594D]" id="chatHeaderName"></div>
                            <div class="text-xs text-emerald-600 flex items-center gap-1 font-semibold">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                ƒêang online
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openTicketPopup()"
                                class="px-3 py-2 border border-[#E3E5D2] rounded-lg hover:bg-blue-50 hover:border-blue-300 text-sm font-bold text-[#03594D] flex items-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">confirmation_number</span>
                            T·∫°o ticket
                        </button>
                        <button onclick="closeSession()"
                                class="px-3 py-2 border border-[#E3E5D2] rounded-lg hover:bg-gray-50 text-sm font-bold text-[#03594D] flex items-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">check_circle</span>
                            ƒê√≥ng
                        </button>
                    </div>
                </div>

                <!-- Messages area -->
                <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 min-h-0">
                    <!-- Messages will be loaded here dynamically -->
                    <div class="text-center text-gray-400 py-10 mt-28">
                        <span class="material-symbols-outlined text-5xl">chat_bubble_outline</span>
                        <p class="mt-2">Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                    </div>
                </div>

                <!-- Input area -->
                <div class="bg-white border-t border-[#E3E5D2] p-4 shadow-sm">
                    <div class="flex gap-2">
                        <input type="text"
                               id="messageInput"
                               placeholder="Nh·∫≠p tin nh·∫Øn..."
                               class="flex-1 border border-[#E3E5D2] rounded-lg px-4 py-2 focus:outline-none focus:border-[#03594D] focus:ring-1 focus:ring-[#03594D]"
                               onkeypress="handleMessageKeyPress(event)"/>
                        <button onclick="sendMessage()"
                                class="px-5 py-2 bg-[#D8E268] hover:bg-[#c5cf5a] text-[#03594D] rounded-lg font-bold shadow-md hover:-translate-y-0.5 transition-all">
                            G·ª≠i
                        </button>
                    </div>
<!--                    <div class="flex gap-2 mt-2">-->
<!--                        <button class="text-xs px-3 py-1.5 border border-[#E3E5D2] rounded-md hover:bg-gray-50 font-semibold text-gray-600 flex items-center gap-1">-->
<!--                            <span class="material-symbols-outlined text-[14px]">attach_file</span>-->
<!--                            File-->
<!--                        </button>-->
<!--                        <button class="text-xs px-3 py-1.5 border border-[#E3E5D2] rounded-md hover:bg-gray-50 font-semibold text-gray-600 flex items-center gap-1">-->
<!--                            <span class="material-symbols-outlined text-[14px]">sentiment_satisfied</span>-->
<!--                            Emoji-->
<!--                        </button>-->
<!--                        <button class="text-xs px-3 py-1.5 border border-[#E3E5D2] rounded-md hover:bg-gray-50 font-semibold text-gray-600 flex items-center gap-1">-->
<!--                            <span class="material-symbols-outlined text-[14px]">description</span>-->
<!--                            M·∫´u-->
<!--                        </button>-->
<!--                    </div>-->
                </div>
            </div>

            <!-- Right panel: Customer info & Quick actions -->
            <div id="customerPanel" class="bg-white border-l border-[#E3E5D2] overflow-y-auto hidden">
                <div class="p-5 border-b border-[#E3E5D2]">
                    <h3 class="font-black text-[#03594D] mb-3 flex items-center gap-2 text-sm uppercase">
                        <span class="material-symbols-outlined text-[18px]">pets</span>
                        Th√¥ng tin kh√°ch h√†ng
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between py-1">
                            <span class="text-gray-500 font-semibold">T√™n Ng∆∞·ªùi D√πng:</span>
                            <span class="font-bold text-[#03594D]" id="infoUsername"></span>
                        </div>
                        <div class="flex justify-between py-1">
                            <span class="text-gray-500 font-semibold">H·ªç v√† T√™n:</span>
                            <span class="font-bold text-[#03594D]" id="infoFullName"></span>
                        </div>
                        <div class="flex justify-between py-1">
                            <span class="text-gray-500 font-semibold">SƒêT:</span>
                            <span class="font-bold text-[#03594D]" id="infoPhone"></span>
                        </div>
                        <div class="flex justify-between py-1">
                            <span class="text-gray-500 font-semibold">Email:</span>
                            <span class="font-bold text-[#03594D] " id="infoEmail"></span>
                        </div>
                    </div>
                </div>

                <div class="p-5 border-b border-[#E3E5D2]">
                    <h3 class="font-black text-[#03594D] mb-3 flex items-center gap-2 text-sm uppercase">
                        <span class="material-symbols-outlined text-[18px]">bolt</span>
                        Thao t√°c nhanh
                    </h3>
                    <div class="grid grid-cols-2 gap-2"  id="quickActionsContainer">
                        <button class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">payments</span>
                            B√°o gi√°
                        </button>
                        <button class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
                        <button class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">calendar_month</span>
                            ƒê·∫∑t l·ªãch
                        </button>
                        <button class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">shopping_bag</span>
                            ƒê∆°n h√†ng
                        </button>
                        <button class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">event</span>
                            L·ªãch l√†m vi·ªác
                        </button>

                        <button class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">pets</span>
                            Th√∫ c∆∞ng
                        </button>
                        <button class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">note_add</span>
                            Ghi ch√∫
                        </button>
                    </div>
                </div>

                <div class="p-5">
                    <h3 class="font-black text-[#03594D] mb-3 flex items-center gap-2 text-sm uppercase">
                        <span class="material-symbols-outlined text-[18px]">history</span>
                        L·ªãch s·ª≠ booking
                    </h3>
                    <div id="customerHistory" class="space-y-2">
                        <div class="text-center text-gray-400 py-5 text-sm">
                            Ch·ªçn chat ƒë·ªÉ xem l·ªãch s·ª≠
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Popup Overlay -->
<div id="ticketPopup" class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-slideIn">

        <!-- Popup Header -->
        <div class="bg-gradient-to-r from-[#03594D] to-[#026B5E] p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-[#D8E268] rounded-xl flex items-center justify-center shadow-lg">
                        <span class="material-symbols-outlined text-2xl text-[#03594D]">confirmation_number</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-white">T·∫°o Ticket M·ªõi</h2>
                        <p class="text-xs text-white/80 font-medium">Chuy·ªÉn v·∫•n ƒë·ªÅ ph·ª©c t·∫°p ƒë·∫øn chuy√™n gia</p>
                    </div>
                </div>
                <button onclick="closeTicketPopup()" class="text-white/80 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
        </div>

        <!-- Popup Content - Scrollable -->
        <div class="flex-1 overflow-y-auto p-6" style="scrollbar-width: thin;">

            <!-- Info Banner -->
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-l-4 border-blue-500 p-4 rounded-lg mb-6 shadow-sm">
                <p class="font-bold text-blue-800 text-sm mb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">lightbulb</span>
                    Khi n√†o n√™n t·∫°o ticket?
                </p>
                <div class="text-blue-700 text-xs leading-relaxed space-y-1 ml-7">
                    <p>‚Ä¢ V·∫•n ƒë·ªÅ y√™u c·∫ßu ki·∫øn th·ª©c chuy√™n s√¢u ho·∫∑c k·ªπ thu·∫≠t</p>
                    <p>‚Ä¢ C·∫ßn x·ª≠ l√Ω k·ªπ thu·∫≠t ho·∫∑c ph√™ duy·ªát ƒë·∫∑c bi·ªát</p>
                    <p>‚Ä¢ Kh√°ch h√†ng y√™u c·∫ßu follow-up d√†i h·∫°n</p>
                </div>
            </div>

            <!-- Customer Info Display -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
                <h3 class="font-bold text-sm text-[#03594D] mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">person</span>
                    Th√¥ng tin kh√°ch h√†ng
                </h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-gray-500 font-semibold">H·ªç t√™n:</span>
                        <span id="ticketCustomerName" class="font-bold text-[#03594D] ml-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-500 font-semibold">SƒêT:</span>
                        <span id="ticketCustomerPhone" class="font-bold text-[#03594D] ml-2">-</span>
                    </div>
                    <div class="col-span-2">
                        <span class="text-gray-500 font-semibold">Email:</span>
                        <span id="ticketCustomerEmail" class="font-bold text-[#03594D] ml-2 text-xs">-</span>
                    </div>
                </div>
            </div>

            <!-- Ticket Form -->
            <form id="ticketForm" class="space-y-5">
                <input type="hidden" id="ticketSessionId" name="sessionId">

                <!-- Category Selection -->
                <div>
                    <label class="block font-bold text-sm text-[#03594D] mb-3">
                        Danh m·ª•c <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center gap-2 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#03594D] hover:bg-[#03594D]/5 transition-all group">
                            <input type="radio" name="category" value="SERVICE" required class="accent-[#03594D]">
                            <span class="font-semibold text-gray-700 group-hover:text-[#03594D] text-xs">üíº D·ªãch v·ª•</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#03594D] hover:bg-[#03594D]/5 transition-all group">
                            <input type="radio" name="category" value="PRICE" class="accent-[#03594D]">
                            <span class="font-semibold text-gray-700 group-hover:text-[#03594D] text-xs">üí∞ Gi√° c·∫£</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#03594D] hover:bg-[#03594D]/5 transition-all group">
                            <input type="radio" name="category" value="BOOKING" class="accent-[#03594D]">
                            <span class="font-semibold text-gray-700 group-hover:text-[#03594D] text-xs">üìÖ ƒê·∫∑t l·ªãch</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#03594D] hover:bg-[#03594D]/5 transition-all group">
                            <input type="radio" name="category" value="ORDER" class="accent-[#03594D]">
                            <span class="font-semibold text-gray-700 group-hover:text-[#03594D] text-xs">üì¶ ƒê∆°n h√†ng</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#03594D] hover:bg-[#03594D]/5 transition-all group">
                            <input type="radio" name="category" value="PET_STATUS" class="accent-[#03594D]">
                            <span class="font-semibold text-gray-700 group-hover:text-[#03594D] text-xs">üê∂ Th√∫ c∆∞ng</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#03594D] hover:bg-[#03594D]/5 transition-all group">
                            <input type="radio" name="category" value="OTHER" class="accent-[#03594D]">
                            <span class="font-semibold text-gray-700 group-hover:text-[#03594D] text-xs">üîß Kh√°c</span>
                        </label>
                    </div>
                </div>

                <!-- Priority Selection -->
                <div>
                    <label class="block font-bold text-sm text-[#03594D] mb-3">
                        ƒê·ªô ∆∞u ti√™n <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="text-center p-3 rounded-lg border-2 border-gray-200 cursor-pointer hover:scale-105 transition-all relative overflow-hidden">
                            <input type="radio" name="priority" value="LOW" required class="hidden peer">
                            <span class="peer-checked:font-bold font-semibold text-xs text-gray-600 peer-checked:text-emerald-600 relative z-10">Th·∫•p</span>
                            <div class="absolute inset-0 bg-emerald-100 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                        </label>
                        <label class="text-center p-3 rounded-lg border-2 border-gray-200 cursor-pointer hover:scale-105 transition-all relative overflow-hidden">
                            <input type="radio" name="priority" value="MEDIUM" class="hidden peer">
                            <span class="peer-checked:font-bold font-semibold text-xs text-gray-600 peer-checked:text-yellow-600 relative z-10">Trung b√¨nh</span>
                            <div class="absolute inset-0 bg-yellow-100 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                        </label>
                        <label class="text-center p-3 rounded-lg border-2 border-gray-200 cursor-pointer hover:scale-105 transition-all relative overflow-hidden">
                            <input type="radio" name="priority" value="HIGH" class="hidden peer">
                            <span class="peer-checked:font-bold font-semibold text-xs text-gray-600 peer-checked:text-orange-600 relative z-10">Cao</span>
                            <div class="absolute inset-0 bg-orange-100 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                        </label>
                        <label class="text-center p-3 rounded-lg border-2 border-gray-200 cursor-pointer hover:scale-105 transition-all relative overflow-hidden">
                            <input type="radio" name="priority" value="URGENT" class="hidden peer">
                            <span class="peer-checked:font-bold font-semibold text-xs text-gray-600 peer-checked:text-red-600 relative z-10">Kh·∫©n c·∫•p</span>
                            <div class="absolute inset-0 bg-red-100 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                        </label>
                    </div>
                </div>

                <!-- Subject Input -->
                <div>
                    <label for="ticketSubject" class="block font-bold text-sm text-[#03594D] mb-2">
                        Ti√™u ƒë·ªÅ <span class="text-red-500">*</span>
                    </label>
                    <input id="ticketSubject" name="subject" required
                           class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#03594D] focus:border-[#03594D] outline-none transition-all text-sm font-medium"
                           placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·∫•n ƒë·ªÅ...">
                </div>

                <!-- Description Textarea -->
                <div>
                    <label for="ticketDescription" class="block font-bold text-sm text-[#03594D] mb-2">
                        M√¥ t·∫£ chi ti·∫øt <span class="text-red-500">*</span>
                    </label>
                    <textarea id="ticketDescription" name="description" required rows="4"
                              class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#03594D] focus:border-[#03594D] outline-none transition-all text-sm font-medium resize-none"
                              placeholder="M√¥ t·∫£ ƒë·∫ßy ƒë·ªß v·∫•n ƒë·ªÅ, bao g·ªìm c√°c th√¥ng tin li√™n quan..."></textarea>
                </div>

                <!-- Assign To Select -->
                <div>
                    <label for="ticketAssignTo" class="block font-bold text-sm text-[#03594D] mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">person_add</span>
                        Chuy·ªÉn ƒë·∫øn
                    </label>
                    <select id="ticketAssignTo" name="assignToId"
                            class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#03594D] focus:border-[#03594D] outline-none transition-all text-sm font-medium bg-white">
                        <option value="">-- T·ª± ƒë·ªông ph√¢n c√¥ng --</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-4 sticky bottom-0 bg-white pb-2">
                    <button type="button" onclick="closeTicketPopup()"
                            class="flex-1 p-3 rounded-lg bg-white border-2 border-gray-200 hover:bg-gray-50 font-bold text-gray-700 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-lg">close</span>
                        H·ªßy b·ªè
                    </button>
                    <button type="submit"
                            class="flex-1 p-3 rounded-lg text-white font-bold bg-gradient-to-r from-[#03594D] to-[#026B5E] hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-lg">check_circle</span>
                        T·∫°o Ticket
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>


<!-- MODAL B√ÅO GI√Å  -->
<div id="pricingModal" class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-slideIn">
        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-3xl">üí∞</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-white">B√°o Gi√° D·ªãch V·ª•</h2>
                        <p class="text-xs text-white/80 font-medium">Tra c·ª©u v√† g·ª≠i b√°o gi√° nhanh</p>
                    </div>
                </div>
                <button onclick="closeModal('pricingModal')" class="text-white/80 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block font-bold text-sm text-[#03594D] mb-2">Th√∫ c∆∞ng</label>
                    <select id="pricingPetSelect" onchange="loadServicePricing()"
                            class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                        <option value="">-- T·∫•t c·∫£ th√∫ c∆∞ng --</option>
                    </select>
                </div>
                <div>
                    <label class="block font-bold text-sm text-[#03594D] mb-2">Lo·∫°i d·ªãch v·ª•</label>
                    <select id="pricingServiceType"
                            onchange="loadServicePricing()"
                            class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                        <option value="">-- T·∫•t c·∫£ --</option>
                    </select>

                </div>
            </div>

            <div id="pricingResults" class="grid grid-cols-2 gap-4">
                <div class="col-span-2 text-center text-gray-400 py-10">
                    Ch·ªçn th√∫ c∆∞ng v√† lo·∫°i d·ªãch v·ª• ƒë·ªÉ xem b·∫£ng gi√°
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ƒê·∫∂T L·ªäCH -->
<div id="bookingModal" class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-slideIn">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-3xl">üìÖ</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-white">ƒê·∫∑t L·ªãch Nhanh</h2>
                        <p class="text-xs text-white/80 font-medium">Ch·ªët l·ªãch tr·ª±c ti·∫øp trong chat</p>
                    </div>
                </div>
                <button onclick="closeModal('bookingModal')" class="text-white/80 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block font-bold text-sm text-[#03594D] mb-2">Th√∫ c∆∞ng <span class="text-red-500">*</span></label>
                    <select id="bookingPetSelect" required
                            class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">-- Ch·ªçn th√∫ c∆∞ng --</option>
                    </select>
                </div>
                <div>
                    <label class="block font-bold text-sm text-[#03594D] mb-2">D·ªãch v·ª• <span class="text-red-500">*</span></label>
                    <select id="bookingServiceSelect" required onchange="loadAvailableSlots()"
                            class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">-- Ch·ªçn d·ªãch v·ª• --</option>
                    </select>
                </div>
            </div>

            <div class="mb-6">
                <label class="block font-bold text-sm text-[#03594D] mb-2">Ng√†y <span class="text-red-500">*</span></label>
                <input type="date" id="bookingDateInput" required onchange="loadAvailableSlots()"
                       class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>

            <div class="mb-6">
                <label class="block font-bold text-sm text-[#03594D] mb-3">Ch·ªçn khung gi·ªù</label>
                <div id="bookingSlotsContainer" class="grid grid-cols-3 gap-3 max-h-60 overflow-y-auto">
                    <div class="col-span-3 text-center text-gray-400 py-6 text-sm">
                        Ch·ªçn d·ªãch v·ª• v√† ng√†y ƒë·ªÉ xem slot tr·ªëng
                    </div>
                </div>
                <input type="hidden" id="selectedSlotData">
            </div>

            <div class="mb-6">
                <label class="block font-bold text-sm text-[#03594D] mb-2">Ghi ch√∫</label>
                <textarea id="bookingNotes" rows="2"
                          class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                          placeholder="Y√™u c·∫ßu ƒë·∫∑c bi·ªát..."></textarea>
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal('bookingModal')"
                        class="flex-1 p-3 rounded-lg bg-white border-2 border-gray-200 hover:bg-gray-50 font-bold text-gray-700 transition-all">
                    H·ªßy b·ªè
                </button>
                <button onclick="confirmQuickBooking()"
                        class="flex-1 p-3 rounded-lg text-white font-bold bg-gradient-to-r from-blue-600 to-indigo-600 hover:shadow-xl hover:-translate-y-0.5 transition-all">
                    ‚úÖ X√°c nh·∫≠n ƒë·∫∑t l·ªãch
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ƒê∆†N H√ÄNG -->
<div id="orderModal" class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-slideIn">
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-3xl">üõçÔ∏è</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-white">L·ªãch S·ª≠ ƒê∆°n H√†ng</h2>
                        <p class="text-xs text-white/80 font-medium">Xem v√† tra c·ª©u ƒë∆°n h√†ng</p>
                    </div>
                </div>
                <button onclick="closeModal('orderModal')" class="text-white/80 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <div id="orderListContainer" class="space-y-3">
                <div class="text-center text-gray-400 py-10">
                    ƒêang t·∫£i...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL L·ªäCH L√ÄM VI·ªÜC  -->
<div id="scheduleModal" class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-slideIn">
        <div class="bg-gradient-to-r from-orange-600 to-red-600 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-3xl">üìÜ</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-white">L·ªãch L√†m Vi·ªác</h2>
                        <p class="text-xs text-white/80 font-medium">Xem l·ªãch nh√¢n vi√™n v√† slot tr·ªëng</p>
                    </div>
                </div>
                <button onclick="closeModal('scheduleModal')" class="text-white/80 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
        </div>

        <div class="p-6 border-b">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block font-bold text-sm text-[#03594D] mb-2">Ng√†y</label>
                    <input type="date" id="scheduleDate" onchange="loadStaffSchedule()"
                           class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block font-bold text-sm text-[#03594D] mb-2">Lo·∫°i nh√¢n vi√™n</label>
                    <select id="scheduleStaffType"
                            onchange="loadStaffSchedule()"
                            class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
                        <option value="">-- T·∫•t c·∫£ --</option>
                    </select>

                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <div id="scheduleContainer">
                <div class="text-center text-gray-400 py-10">
                    Ch·ªçn ng√†y ƒë·ªÉ xem l·ªãch l√†m vi·ªác
                </div>
            </div>
        </div>
    </div>
</div>

<!--  MODAL TH√ö C∆ØNG -->
<div id="petModal" class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-slideIn">
        <div class="bg-gradient-to-r from-pink-600 to-rose-600 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-3xl">üêæ</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-white">Th√¥ng Tin Th√∫ C∆∞ng</h2>
                        <p class="text-xs text-white/80 font-medium">Xem chi ti·∫øt v√† l·ªãch s·ª≠ th√∫ c∆∞ng</p>
                    </div>
                </div>
                <button onclick="closeModal('petModal')" class="text-white/80 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <div id="petListContainer" class="grid grid-cols-2 gap-4">
                <div class="col-span-2 text-center text-gray-400 py-10">
                    ƒêang t·∫£i...
                </div>
            </div>
        </div>
    </div>
</div>

<!--  MODAL GHI CH√ö -->
<div id="noteModal" class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-slideIn">
        <div class="bg-gradient-to-r from-cyan-600 to-blue-600 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-3xl">üìù</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-white">Ghi Ch√∫ Kh√°ch H√†ng</h2>
                        <p class="text-xs text-white/80 font-medium">L∆∞u th√¥ng tin quan tr·ªçng</p>
                    </div>
                </div>
                <button onclick="closeModal('noteModal')" class="text-white/80 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-3xl">close</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <div class="mb-6">
                <label class="block font-bold text-sm text-[#03594D] mb-2">Lo·∫°i ghi ch√∫</label>
                <select id="noteType"
                        class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none">
                    <option value="INFO">‚ÑπÔ∏è Th√¥ng tin chung</option>
                    <option value="PREFERENCE">‚≠ê S·ªü th√≠ch / Y√™u c·∫ßu</option>
                    <option value="WARNING">‚ö†Ô∏è C·∫£nh b√°o</option>
                </select>
            </div>

            <div class="mb-6">
                <label class="block font-bold text-sm text-[#03594D] mb-2">N·ªôi dung ghi ch√∫</label>
                <textarea id="noteText" rows="4" required
                          class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none resize-none"
                          placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ kh√°ch h√†ng..."></textarea>
            </div>

            <button onclick="saveCustomerNote()"
                    class="w-full p-3 rounded-lg text-white font-bold bg-gradient-to-r from-cyan-600 to-blue-600 hover:shadow-xl hover:-translate-y-0.5 transition-all mb-6">
                üíæ L∆∞u ghi ch√∫
            </button>

            <div class="border-t pt-6">
                <h3 class="font-bold text-[#03594D] mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">history</span>
                    Ghi ch√∫ tr∆∞·ªõc ƒë√≥
                </h3>
                <div id="noteListContainer" class="space-y-2 max-h-60 overflow-y-auto">
                    <div class="text-center text-gray-400 py-6 text-sm">
                        ƒêang t·∫£i...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const staffId = /*[[${staff.userId}]]*/ 0;
    let stompClient = null;
    let currentSessionId = null;
    let currentCustomer = null;
    let displayedMessageIds = new Set();
    let currentSubscription = null;

    let currentQuickActionCustomerId = null;
    let currentQuickActionSessionId = null;


    function renderPriorityBadge(priority) {
        if (priority === 'HIGH') {
            return `<span class="text-[10px] px-2 py-0.5 rounded font-bold bg-red-100 text-red-700">HIGH</span>`;
        }
        if (priority === 'MEDIUM') {
            return `<span class="text-[10px] px-2 py-0.5 rounded font-bold bg-orange-100 text-orange-700">MEDIUM</span>`;
        }
        return `<span class="text-[10px] px-2 py-0.5 rounded font-bold bg-gray-100 text-gray-600">LOW</span>`;
    }


    function renderTicketCard(ticket) {
        return `
        <div id="ticket-${ticket.id}"
             onclick="window.location.href='/support/tickets/${ticket.id}'"
             class="bg-white border border-blue-200 rounded-lg p-3 hover:shadow-md transition cursor-pointer">

            <div class="flex justify-between items-center mb-1">
                <div class="font-bold text-sm text-[#03594D]">
                    ${ticket.subject}
                </div>
                ${renderPriorityBadge(ticket.priority)}
            </div>

            <div class="text-xs text-gray-500 truncate">
                ${ticket.description || ''}
            </div>

            <div class="flex justify-between items-center mt-2 text-xs text-gray-400 font-mono">
                <span>${ticket.customer?.fullName || ''}</span>
                <span>${ticket.createdAt?.substring(11, 16) || ''}</span>
            </div>
        </div>
    `;
    }


    function updateTicketInUI(ticket) {
        const ticketEl = document.getElementById(`ticket-${ticket.id}`);

        if (ticket.status === 'CLOSED' || ticket.status === 'RESOLVED') {
            moveTicketOut(ticket.id);
            return;
        }

        if (ticketEl) {
            ticketEl.outerHTML = renderTicketCard(ticket);
            return;
        }

        const container = ticket.assignedTo?.isMe
            ? document.getElementById('assignedTicketsContent')
            : document.getElementById('ticketsContent');

        container.insertAdjacentHTML('afterbegin', renderTicketCard(ticket));

        updateTicketCounts();
    }


    function moveTicketOut(ticketId) {
        const el = document.getElementById(`ticket-${ticketId}`);
        if (!el) return;

        el.remove();
        updateTicketCounts();

    }


    function updateTicketCounts() {
        const openCount = document.querySelectorAll('#ticketsContent > div[id^="ticket-"]').length;
        const assignedCount = document.querySelectorAll('#assignedTicketsContent > div[id^="ticket-"]').length;

        document.getElementById('openTicketsCount').innerText = openCount;
        document.getElementById('assignedTicketsCount').innerText = assignedCount;
    }









    async function loadStaffRoles() {
        try {
            const res = await fetch('/support/api/quick-actions/staff-roles');
            const roles = await res.json();

            const select = document.getElementById('scheduleStaffType');
            select.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';

            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                select.appendChild(option);
            });
        } catch (e) {
            console.error('Kh√¥ng load ƒë∆∞·ª£c staff roles', e);
        }
    }



    async function loadServiceCategories() {
        try {
            const res = await fetch('/support/api/quick-actions/pricing/service-categories');
            const categories = await res.json();

            const select = document.getElementById('pricingServiceType');

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.categoryType;   // SPA, MEDICAL, BOARDING
                option.textContent = cat.name;     // Spa & Grooming
                select.appendChild(option);
            });

        } catch (e) {
            console.error('Load service categories failed', e);
        }
    }


    function openPricingQuote() {
        if (!currentSessionId) {
            alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn chat tr∆∞·ªõc!');
            return;
        }

        const sessionEl = document.getElementById('session-' + currentSessionId);

        currentQuickActionCustomerId = sessionEl.dataset.customerId;
        currentQuickActionSessionId = currentSessionId;

        document.getElementById('pricingModal').classList.remove('hidden');
        loadServiceCategories();
        loadCustomerPets(currentQuickActionCustomerId, 'pricingPetSelect');
    }

    async function loadServicePricing() {
        const petId = document.getElementById('pricingPetSelect').value;
        const serviceType = document.getElementById('pricingServiceType').value;

        try {
            const res = await fetch(`/support/api/quick-actions/pricing?petId=${petId || ''}`);
            const services = await res.json();

            const container = document.getElementById('pricingResults');
            container.innerHTML = '';

            const filtered = serviceType ? services.filter(s => s.category === serviceType) : services;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">Kh√¥ng c√≥ d·ªãch v·ª• ph√π h·ª£p</div>';
                return;
            }

            filtered.forEach(service => {
                const card = createServicePricingCard(service);
                container.appendChild(card);
            });
        } catch (err) {
            console.error(err);
            alert('Kh√¥ng th·ªÉ t·∫£i b·∫£ng gi√°');
        }
    }

    function createServicePricingCard(service) {
        const div = document.createElement('div');
        div.className = 'border-2 border-gray-200 rounded-lg p-4 hover:border-emerald-500 transition-all cursor-pointer';

        const discount = service.discountPercent ?
            `<span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded font-bold">-${service.discountPercent}%</span>` : '';

        const priceDisplay = service.priceModel === 'FIXED' ?
            `<div class="text-2xl font-black text-emerald-600">${formatMoney(service.discountedPrice || service.basePrice)}</div>` :
            `<div class="text-sm text-gray-500">Gi√° theo c√¢n n·∫∑ng</div>`;

        div.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <div>
                <div class="font-bold text-[#03594D]">${service.serviceName}</div>
                <div class="text-xs text-gray-500">${service.durationMinutes} ph√∫t</div>
            </div>
            ${discount}
        </div>

        ${priceDisplay}

        ${service.discountPercent ?
            `<div class="text-xs text-gray-400 line-through">${formatMoney(service.basePrice)}</div>` : ''}

        <div class="mt-3 flex gap-2">
            <button onclick="sendPricingToChat(${service.serviceId})"
                    class="flex-1 py-2 bg-emerald-500 text-white rounded font-bold text-sm hover:bg-emerald-600">
                üì§ G·ª≠i v√†o chat
            </button>
            <button onclick="createBookingFromPricing(${service.serviceId})"
                    class="px-3 py-2 border-2 border-emerald-500 text-emerald-600 rounded font-bold text-sm hover:bg-emerald-50">
                üìÖ
            </button>
        </div>
    `;

        return div;
    }

    async function sendPricingToChat(serviceId) {
        const petId = document.getElementById('pricingPetSelect').value;

        try {
            const res = await fetch(`/support/api/quick-actions/pricing/send-to-chat?sessionId=${currentQuickActionSessionId}&serviceId=${serviceId}&petId=${petId || ''}`, {
                method: 'POST'
            });

            if (res.ok) {
                document.getElementById('pricingModal').classList.add('hidden');
                alert('‚úÖ ƒê√£ g·ª≠i b√°o gi√° v√†o chat');
            }
        } catch (err) {
            console.error(err);
            alert('Kh√¥ng th·ªÉ g·ª≠i b√°o gi√°');
        }
    }

    // ƒê·∫∂T L·ªäCH
    function openQuickBooking(preSelectedServiceId = null) {

        if (!currentSessionId) {
            alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn chat tr∆∞·ªõc!');
            return;
        }

        const sessionEl = document.getElementById('session-' + currentSessionId);

        currentQuickActionCustomerId = sessionEl.dataset.customerId;
        currentQuickActionSessionId = currentSessionId;

        document.getElementById('bookingModal').classList.remove('hidden');

        loadCustomerPets(currentQuickActionCustomerId, 'bookingPetSelect');
        loadBookingServices();

        if (preSelectedServiceId) {
            setTimeout(() => {
                document.getElementById('bookingServiceSelect').value = preSelectedServiceId;
                loadAvailableSlots();
            }, 500);
        }
    }

    function createBookingFromPricing(serviceId) {
        document.getElementById('pricingModal').classList.add('hidden');
        openQuickBooking(serviceId);
    }

    async function loadBookingServices() {

        try {
            const res = await fetch('/support/api/quick-actions/all');
            const services = await res.json();

            const select = document.getElementById('bookingServiceSelect');
            select.innerHTML = '<option value="">-- Ch·ªçn d·ªãch v·ª• --</option>';

            services.forEach(s => {
                select.innerHTML += `<option value="${s.serviceId}">${s.serviceName} - ${formatMoney(s.fixedPrice)}</option>`;
            });
        } catch (err) {
            console.error(err);
        }
    }

    async function loadAvailableSlots() {
        const serviceId = document.getElementById('bookingServiceSelect').value;
        const date = document.getElementById('bookingDateInput').value;

        if (!serviceId || !date) return;

        try {
            const res = await fetch(`/support/api/quick-actions/booking/available-slots?serviceId=${serviceId}&date=${date}`);
            const slots = await res.json();

            const container = document.getElementById('bookingSlotsContainer');
            container.innerHTML = '';

            if (slots.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-6">Kh√¥ng c√≥ slot tr·ªëng</div>';
                return;
            }

            slots.forEach(slot => {
                const div = document.createElement('div');
                div.className = slot.available ?
                    'border-2 border-emerald-200 bg-emerald-50 rounded-lg p-3 cursor-pointer hover:border-emerald-500' :
                    'border border-gray-200 bg-gray-50 rounded-lg p-3 opacity-50 cursor-not-allowed';

                div.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-bold text-[#03594D]">${slot.startTime.slice(0, 5)} - ${slot.endTime.slice(0, 5)}</div>
                    <div class="text-xs ${slot.available ? 'text-emerald-600' : 'text-red-600'}">
                        ${slot.currentBookings}/${slot.maxBookings}
                    </div>
                </div>
                ${slot.staffName ? `<div class="text-xs text-gray-500 mt-1">üë§ ${slot.staffName}</div>` : ''}
            `;

                if (slot.available) {
                    div.onclick = () => selectBookingSlot(slot);
                }

                container.appendChild(div);
            });
        } catch (err) {
            console.error(err);
            alert('Kh√¥ng th·ªÉ t·∫£i slot');
        }
    }

    function selectBookingSlot(slot) {
        document.querySelectorAll('#bookingSlotsContainer > div').forEach(el => {
            el.classList.remove('ring-2', 'ring-emerald-500');
        });

        event.target.closest('div').classList.add('ring-2', 'ring-emerald-500');

        document.getElementById('selectedSlotData').value = JSON.stringify(slot);
    }

    async function confirmQuickBooking() {
        const petId = document.getElementById('bookingPetSelect').value;
        const serviceId = document.getElementById('bookingServiceSelect').value;
        const date = document.getElementById('bookingDateInput').value;
        const slotData = document.getElementById('selectedSlotData').value;
        const notes = document.getElementById('bookingNotes').value;

        if (!petId || !serviceId || !date || !slotData) {
            alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
            return;
        }

        const slot = JSON.parse(slotData);

        const request = {
            sessionId: currentQuickActionSessionId,
            customerId: currentQuickActionCustomerId,
            petId: parseInt(petId),
            serviceId: parseInt(serviceId),
            bookingDate: date,
            startTime: slot.startTime,
            staffId: slot.staffId,
            notes: notes
        };

        try {
            const res = await fetch('/support/api/quick-actions/booking/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            if (res.ok) {
                const booking = await res.json();
                document.getElementById('bookingModal').classList.add('hidden');
                alert(`‚úÖ ƒê·∫∑t l·ªãch th√†nh c√¥ng!\n\nM√£ booking: #${booking.bookingId}\nNg√†y: ${date}\nGi·ªù: ${slot.startTime}`);
            } else {
                alert('Kh√¥ng th·ªÉ ƒë·∫∑t l·ªãch');
            }
        } catch (err) {
            console.error(err);
            alert('L·ªói khi ƒë·∫∑t l·ªãch');
        }
    }

    // ƒê∆†N H√ÄNG

    async function openOrderHistory() {
        if (!currentSessionId) {
            alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn chat tr∆∞·ªõc!');
            return;
        }

        let  customerId ;

        const sessionEl = document.getElementById('session-' + currentSessionId);

        customerId = sessionEl.dataset.customerId;


        document.getElementById('orderModal').classList.remove('hidden');

        try {
            const res = await fetch(`/support/api/quick-actions/orders?customerId=${customerId}`);
            const orders = await res.json();

            const container = document.getElementById('orderListContainer');
            container.innerHTML = '';

            if (orders.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</div>';
                return;
            }

            orders.forEach(order => {
                const div = document.createElement('div');
                div.className = 'border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition cursor-pointer';
                div.onclick = () => showOrderDetail(order.orderId);

                const statusClass = {
                    'PENDING': 'bg-yellow-100 text-yellow-700',
                    'PROCESSING': 'bg-blue-100 text-blue-700',
                    'COMPLETED': 'bg-green-100 text-green-700',
                    'CANCELLED': 'bg-red-100 text-red-700'
                }[order.status] || 'bg-gray-100 text-gray-700';

                div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold text-[#03594D]">ƒê∆°n h√†ng #${order.orderId}</div>
                    <span class="text-xs px-2 py-1 rounded font-bold ${statusClass}">
                        ${order.status}
                    </span>
                </div>
                <div class="text-sm text-gray-600 mb-2">${order.itemCount} s·∫£n ph·∫©m</div>
                <div class="flex justify-between items-center">
                    <div class="text-lg font-black text-emerald-600">${formatMoney(order.totalAmount)}</div>
                    <div class="text-xs text-gray-400">${formatDateTime(order.orderDate)}</div>
                </div>
            `;

                container.appendChild(div);
            });
        } catch (err) {
            console.error(err);
            alert('Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng');
        }
    }

    async function showOrderDetail(orderId) {
        try {
            const res = await fetch(`/support/api/quick-actions/orders/${orderId}`);
            const detail = await res.json();

            let itemsHtml = '';
            detail.items.forEach(item => {
                itemsHtml += `
                <div class="flex justify-between py-2 border-b">
                    <div>
                        <div class="font-bold text-sm">${item.productName}</div>
                        <div class="text-xs text-gray-500">SL: ${item.quantity} x ${formatMoney(item.unitPrice)}</div>
                    </div>
                    <div class="font-bold text-emerald-600">${formatMoney(item.lineTotal)}</div>
                </div>
            `;
            });

            alert(`üì¶ CHI TI·∫æT ƒê∆†N H√ÄNG #${orderId}\n\n${itemsHtml}\n\nT·ªïng: ${formatMoney(detail.totalAmount)}\nƒê·ªãa ch·ªâ: ${detail.shippingAddress}`);
        } catch (err) {
            console.error(err);
        }
    }

    //  L·ªäCH L√ÄM VI·ªÜC
    async function openStaffSchedule() {
        document.getElementById('scheduleModal').classList.remove('hidden');

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('scheduleDate').value = today;

        await loadStaffRoles();
        loadStaffSchedule();
    }

    async function loadStaffSchedule() {
        const date = document.getElementById('scheduleDate').value;
        const staffType = document.getElementById('scheduleStaffType').value;

        try {
            const res = await fetch(`/support/api/quick-actions/schedule?date=${date}&staffType=${staffType}`);
            const scheduleMap = await res.json();

            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';

            Object.entries(scheduleMap).forEach(([staffName, slots]) => {
                const staffSection = document.createElement('div');
                staffSection.className = 'mb-6';

                staffSection.innerHTML = `
                <h3 class="font-bold text-[#03594D] mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">person</span>
                    ${staffName}
                </h3>
                <div class="grid grid-cols-4 gap-2" id="slots-${staffName}"></div>
            `;

                container.appendChild(staffSection);

                const slotContainer = document.getElementById(`slots-${staffName}`);
                slots.forEach(slot => {
                    const div = document.createElement('div');

                    div.className = `
                        rounded-lg p-3 text-center transition
                        ${slot.available
                                        ? 'bg-emerald-50 border border-emerald-300 hover:bg-emerald-100'
                                        : 'bg-gray-100 border border-gray-300 opacity-60'}
                    `;

                                    div.innerHTML = `
                        <div class="text-sm font-semibold text-gray-800 mb-1">
                            ${slot.startTime.slice(0, 5)}
                        </div>

                        <div class="text-xs flex items-center justify-center gap-1
                            ${slot.available ? 'text-emerald-700' : 'text-red-600'}">
                            <span class="material-symbols-outlined text-sm">
                                ${slot.available ? 'check_circle' : 'block'}
                            </span>
                            ${slot.currentBookings}/${slot.maxBookings}
                        </div>
                    `;

                    slotContainer.appendChild(div);
                });

            });
        } catch (err) {
            console.error(err);
            alert('Kh√¥ng th·ªÉ t·∫£i l·ªãch l√†m vi·ªác');
        }
    }






    // TH√ö C∆ØNG
    async function openPetInfo() {
        if (!currentSessionId) {
            alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn chat tr∆∞·ªõc!');
            return;
        }

        let  customerId;
        const sessionEl = document.getElementById('session-' + currentSessionId);

        customerId = sessionEl.dataset.customerId;

        document.getElementById('petModal').classList.remove('hidden');

        try {
            const res = await fetch(`/support/api/quick-actions/pets?customerId=${customerId}`);
            const pets = await res.json();

            const container = document.getElementById('petListContainer');
            container.innerHTML = '';

            if (pets.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">Ch∆∞a c√≥ th√∫ c∆∞ng n√†o</div>';
                return;
            }

            pets.forEach(pet => {
                const card = createPetCard(pet);
                container.appendChild(card);
            });
        } catch (err) {
            console.error(err);
            alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin th√∫ c∆∞ng');
        }
    }

    function createPetCard(pet) {
        const div = document.createElement('div');
        div.className = 'border-2 border-gray-200 rounded-lg p-4 hover:border-[#D8E268] transition cursor-pointer';
        div.onclick = () => showPetDetail(pet.petId);

        div.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-pink-400 rounded-full flex items-center justify-center text-white text-2xl">
                üêæ
            </div>
            <div class="flex-1">
                <div class="font-bold text-[#03594D]">${pet.name}</div>
                <div class="text-sm text-gray-600">${pet.species} ‚Ä¢ ${pet.breed}</div>
                <div class="text-xs text-gray-400 mt-1">
                    ${pet.weightKg ? pet.weightKg + 'kg' : ''} ‚Ä¢
                    ${pet.gender === 'MALE' ? '‚ôÇÔ∏è ƒê·ª±c' : '‚ôÄÔ∏è C√°i'}
                </div>
                <div class="text-xs text-emerald-600 mt-2 font-bold">
                    ${pet.totalVisits || 0} l·∫ßn s·ª≠ d·ª•ng d·ªãch v·ª•
                </div>
            </div>
        </div>
    `;

        return div;
    }

    async function showPetDetail(petId) {
        try {
            const res = await fetch(`/support/api/quick-actions/pets/${petId}/history`);
            const data = await res.json();

            let historyHtml = '';
            data.serviceHistory.forEach(h => {
                historyHtml += `‚Ä¢ ${h.serviceName} - ${h.bookingDate} (${h.status})\n`;
            });

            alert(`üêæ ${data.pet.name}\n\nGi·ªëng: ${data.pet.breed}\nC√¢n n·∫∑ng: ${data.pet.weightKg}kg\nGhi ch√∫: ${data.pet.notes || 'Kh√¥ng c√≥'}\n\nL·ªãch s·ª≠:\n${historyHtml}`);
        } catch (err) {
            console.error(err);
        }
    }

    // GHI CH√ö
    function openNoteModal() {
        if (!currentSessionId) {
            alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn chat tr∆∞·ªõc!');
            return;
        }

        let  customerId;
        const sessionEl = document.getElementById('session-' + currentSessionId);

        customerId = sessionEl.dataset.customerId;

        document.getElementById('noteModal').classList.remove('hidden');
        loadCustomerNotes(customerId);
    }

    async function loadCustomerNotes(customerId) {
        try {
            const res = await fetch(`/support/api/quick-actions/notes?customerId=${customerId}`);
            const notes = await res.json();

            const container = document.getElementById('noteListContainer');
            container.innerHTML = '';

            if (notes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-6 text-sm">Ch∆∞a c√≥ ghi ch√∫ n√†o</div>';
                return;
            }

            notes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'border-l-4 border-blue-500 bg-blue-50 rounded p-3 mb-2';

                const typeIcon = {
                    'PREFERENCE': '‚≠ê',
                    'WARNING': '‚ö†Ô∏è',
                    'INFO': '‚ÑπÔ∏è'
                }[note.noteType] || 'üìù';

                div.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="text-lg">${typeIcon}</span>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-gray-800">${note.noteText}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${note.createdBy} ‚Ä¢ ${formatDateTime(note.createdAt)}
                        </div>
                    </div>
                </div>
            `;

                container.appendChild(div);
            });
        } catch (err) {
            console.error(err);
        }
    }

    async function saveCustomerNote() {
        let  customerId;
        const sessionEl = document.getElementById('session-' + currentSessionId);

        customerId = sessionEl.dataset.customerId;
        const noteText = document.getElementById('noteText').value;
        const noteType = document.getElementById('noteType').value;

        if (!noteText.trim()) {
            alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫');
            return;
        }

        const request = {
            customerId: parseInt(customerId),
            sessionId: currentSessionId,
            noteText: noteText,
            noteType: noteType
        };

        try {
            const res = await fetch('/support/api/quick-actions/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            if (res.ok) {
                document.getElementById('noteText').value = '';
                loadCustomerNotes(customerId);
                alert('‚úÖ ƒê√£ l∆∞u ghi ch√∫');
            }
        } catch (err) {
            console.error(err);
            alert('Kh√¥ng th·ªÉ l∆∞u ghi ch√∫');
        }
    }


    async function loadCustomerPets(customerId, selectId) {
        try {
            const res = await fetch(`/support/api/quick-actions/pets?customerId=${customerId}`);
            const pets = await res.json();

            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- T·∫•t c·∫£ th√∫ c∆∞ng --</option>';

            pets.forEach(pet => {
                select.innerHTML += `<option value="${pet.petId}">${pet.name} (${pet.species})</option>`;
            });
        } catch (err) {
            console.error(err);
        }
    }

    function formatMoney(amount) {
        if (!amount) return '0‚Ç´';
        return Number(amount).toLocaleString('vi-VN') + '‚Ç´';
    }


    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return '';
        const dt = new Date(dateTimeStr);
        return dt.toLocaleDateString('vi-VN') + ' ' + dt.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }


    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('quickActionsContainer');
        if (!container) return;

        container.innerHTML = `
        <button onclick="openPricingQuote()" class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
            <span class="material-symbols-outlined text-[16px]">payments</span>
            B√°o gi√°
        </button>

        <button onclick="openQuickBooking()" class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
            <span class="material-symbols-outlined text-[16px]">calendar_month</span>
            ƒê·∫∑t l·ªãch
        </button>

        <button onclick="openOrderHistory()" class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
            <span class="material-symbols-outlined text-[16px]">shopping_bag</span>
            ƒê∆°n h√†ng
        </button>

        <button onclick="openStaffSchedule()" class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
            <span class="material-symbols-outlined text-[16px]">event</span>
            L·ªãch l√†m vi·ªác
        </button>

        <button onclick="openPetInfo()" class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
            <span class="material-symbols-outlined text-[16px]">pets</span>
            Th√∫ c∆∞ng
        </button>

        <button onclick="openNoteModal()" class="border border-[#E3E5D2] rounded-lg py-2.5 text-sm hover:bg-[#D8E268] hover:text-[#03594D] hover:border-[#D8E268] transition-all font-bold text-gray-600 flex items-center justify-center gap-1">
            <span class="material-symbols-outlined text-[16px]">note_add</span>
            Ghi ch√∫
        </button>
    `;
    });

    async function loadCustomerBookingHistory(customerId) {
        const historyEl = document.getElementById("customerHistory");

        // UI loading
        historyEl.innerHTML = `
        <div class="text-center text-gray-400 py-4 text-sm">
            ƒêang t·∫£i l·ªãch s·ª≠ ƒë·∫∑t l·ªãch...
        </div>
    `;

        try {
            const res = await fetch(`/support/api/bookings/customer/${customerId}`);
            if (!res.ok) throw new Error("Fetch failed");

            const bookings = await res.json();

            if (!bookings || bookings.length === 0) {
                historyEl.innerHTML = `
                <div class="text-center text-gray-400 py-4 text-sm">
                    Kh√°ch h√†ng ch∆∞a c√≥ l·ªãch ƒë·∫∑t n√†o
                </div>
            `;
                return;
            }

            historyEl.innerHTML = "";

            bookings.forEach(b => {
                const item = document.createElement("div");
                item.className =
                    "border rounded-lg p-3 text-sm bg-white hover:bg-gray-50 transition";

                item.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-semibold text-[#03594D]">
                        ${b.serviceName || "D·ªãch v·ª•"}
                    </div>
                    <span class="px-2 py-0.5 rounded text-xs font-medium
                        ${statusClass(b.status)}">
                        ${formatStatus(b.status)}
                    </span>
                </div>

                <div class="text-gray-500 mt-1">
                    üêæ ${b.petName || "Th√∫ c∆∞ng"} ¬∑ üìÖ ${formatDate(b.bookingDate)}
                </div>


<div class="flex items-center justify-between">
                     <div class="text-gray-400 text-xs mt-1">
                    T·ªïng ti·ªÅn: ${formatMoney(b.totalAmount)}
                </div>
                <div class="text-gray-400 text-xs mt-1">
                    Code: ${b.bookingId}
                </div>
                </div>

            `;

                historyEl.appendChild(item);
            });

        } catch (err) {
            console.error(err);
            historyEl.innerHTML = `
            <div class="text-center text-red-400 py-4 text-sm">
                Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠
            </div>
        `;
        }
    }


    function formatDate(dateStr) {
        if (!dateStr) return "";
        return new Date(dateStr).toLocaleDateString("vi-VN");
    }


    function formatStatus(status) {
        const map = {
            PENDING_CONFIRMATION: "Ch·ªù x√°c nh·∫≠n",
            CONFIRMED: "ƒê√£ x√°c nh·∫≠n",
            IN_PROGRESS: "ƒêang th·ª±c hi·ªán",
            COMPLETED: "Ho√†n th√†nh",
            CANCELLED: "ƒê√£ h·ªßy"
        };
        return map[status] || status;
    }

    function statusClass(status) {
        switch (status) {
            case "COMPLETED":
                return "bg-green-100 text-green-700";
            case "CONFIRMED":
                return "bg-blue-100 text-blue-700";
            case "CANCELLED":
                return "bg-red-100 text-red-700";
            default:
                return "bg-yellow-100 text-yellow-700";
        }
    }


    function updateSessionPreview(message) {
        const sessionId = message.session.id;
        const sessionEl = document.getElementById('session-' + sessionId);
        if (!sessionEl) return;

        const previewEl = sessionEl.querySelector('.session-preview');

        const isMine = message.sender.userId === staffId;
        const isCurrentOpenSession = (currentSessionId === sessionId);

        const prefix = isMine ? 'B·∫°n: ' : message.sender.username + ': ';
        const shortText = message.messageText.length > 40
            ? message.messageText.substring(0, 40) + '...'
            : message.messageText;
        previewEl.textContent = prefix + shortText;

        if (!isMine && !isCurrentOpenSession) {
            sessionEl.classList.add('unread');

            let badge = sessionEl.querySelector('.unread-badge');
            if (!badge) {
                const wrapper = previewEl.parentElement;
                badge = document.createElement('span');
                badge.className = 'unread-badge min-w-[20px] h-[20px] text-[11px] ' +
                    'bg-red-500 text-white font-bold rounded-full ' +
                    'flex items-center justify-center';
                badge.textContent = '1';
                wrapper.appendChild(badge);
            } else {
                const currentCount = parseInt(badge.textContent) || 0;
                badge.textContent = currentCount + 1;
            }
        }
    }


    function toggleAccordion(contentId, arrowId) {
        const content = document.getElementById(contentId);
        const arrow = document.getElementById(arrowId);
        if (!content) return;

        content.classList.toggle('hidden');
        arrow?.classList.toggle('rotate-180');
    }




    function addWaitingCustomer(session) {
        const waitingContent = document.getElementById('waitingContent');
        if (!waitingContent) return;

        if (document.getElementById('waiting-session-' + session.id)) {
            console.log('Session ƒëang ch·ªù ƒë√£ t·ªìn t·∫°i:', session.id);
            return;
        }

        const emptyState = waitingContent.querySelector('.text-center.text-gray-400');
        if (emptyState) {
            emptyState.remove();
        }

        const waitingDiv = document.createElement('div');
        waitingDiv.id = 'waiting-session-' + session.id;
        waitingDiv.className = 'bg-white border-2 border-orange-300 rounded-lg p-3 hover:shadow-md transition cursor-pointer animate-fadeIn';

        const startTime = formatTime(session.startedAt);

        waitingDiv.innerHTML = `
        <div class="font-bold text-sm text-[#03594D]">
            ${escapeHtml(session.customer.fullName)}
        </div>
        <div class="text-xs text-gray-500 font-mono">
            ƒê·ª£i t·ª´ ${startTime}
        </div>
        <button class="w-full mt-2 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-md text-sm font-bold shadow-sm"
                onclick="acceptSession(${session.id})">
            Nh·∫≠n chat
        </button>
    `;

        waitingContent.insertBefore(waitingDiv, waitingContent.firstChild);

        updateWaitingCount();

        waitingDiv.style.animation = 'fadeIn 0.4s ease-out, float 3s ease-in-out infinite';

    }


    function updateWaitingCount() {
        const count = document.querySelectorAll('[id^="waiting-session-"]').length;

        const countSpan = document.getElementById('waitingCount');
        if (countSpan) {
            countSpan.textContent = count;
        }

        const statsCard = document.querySelector('.bg-orange-50 .text-2xl');
        if (statsCard) {
            statsCard.textContent = count;
        }
    }



    function removeWaitingSession(sessionId) {
        const waitingDiv = document.getElementById('waiting-session-' + sessionId);
        if (waitingDiv) {
            waitingDiv.style.transition = 'opacity 0.3s, transform 0.3s';
            waitingDiv.style.opacity = '0';
            waitingDiv.style.transform = 'translateX(-20px)';

            setTimeout(() => {
                waitingDiv.remove();
                updateWaitingCount();


                const waitingContent = document.getElementById('waitingContent');
                if (waitingContent && waitingContent.querySelectorAll('[id^="waiting-session-"]').length === 0) {
                    waitingContent.innerHTML = `
                    <div class="text-center text-gray-400 py-14 text-sm">
                        Kh√¥ng c√≥ kh√°ch h√†ng ƒëang ch·ªù
                    </div>
                `;
                }
            }, 300);
        }
    }


    function playNotificationSound() {
        try {
            const audio = new Audio('/sounds/notification.mp3');
            audio.volume = 0.5;
            audio.play().catch(e => console.log('Audio play failed:', e));
        } catch (e) {
            console.log('Notification sound not available');
        }
    }


    function showBrowserNotification(session) {
        if (!("Notification" in window)) {
            return;
        }

        if (Notification.permission === "granted") {
            new Notification("üêæ Kh√°ch h√†ng m·ªõi ƒëang ch·ªù!", {
                body: `${session.customer.fullName} c·∫ßn h·ªó tr·ª£`,
                icon: "/images/logo.png",
                badge: "/images/badge.png",
                tag: 'waiting-customer-' + session.id
            });
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showBrowserNotification(session);
                }
            });
        }
    }

    function acceptSession(sessionId) {
        fetch('/support/api/sessions/' + sessionId + '/accept', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(session => {
                removeWaitingSession(sessionId);

                setTimeout(() => {
                    location.reload();
                }, 500);
            })
            .catch(error => {
                console.error('Error accepting session:', error);
                alert('Kh√¥ng th·ªÉ nh·∫≠n chat. Vui l√≤ng th·ª≠ l·∫°i!');
            });
    }


    function connect() {
        const socket = new SockJS('/ws-chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            stompClient.subscribe('/topic/waiting-customers', function (message) {
                const session = JSON.parse(message.body);
                addWaitingCustomer(session);
            });


            stompClient.subscribe('/user/queue/tickets/opened', function(message) {
                const ticket = JSON.parse(message.body);
                console.log('üì® Received ticket opened:', ticket);
                addOrUpdateTicket(ticket);
            });

            stompClient.subscribe('/user/queue/tickets/removed', function(message) {
                const ticketId = JSON.parse(message.body);
                console.log('üóëÔ∏è Received ticket removed:', ticketId);
                removeTicketFromAllLists(ticketId);
            });

            stompClient.subscribe('/user/queue/tickets/updated', (msg) => {
                const ticket = JSON.parse(msg.body);

                updateTicketInUI(ticket);

                if (ticket.status === 'CLOSED' || ticket.status === 'RESOLVED') {
                    moveTicketOut(ticket.id);
                }
            });


            function addOrUpdateTicket(ticket) {
                const isCreator = ticket.createdBy && ticket.createdBy.userId === staffId;
                const isAssignee = ticket.assignedTo && ticket.assignedTo.userId === staffId;

                console.log('üîç Ticket roles:', {
                    ticketId: ticket.id,
                    isCreator,
                    isAssignee,
                    status: ticket.status
                });

                if (!isCreator && !isAssignee) {
                    console.log('Ticket kh√¥ng thu·ªôc v·ªÅ m√¨nh, b·ªè qua:', ticket.id);
                    return;
                }

                if (ticket.status !== 'OPEN') {
                    console.log('Ticket kh√¥ng ·ªü tr·∫°ng th√°i OPEN, x√≥a kh·ªèi UI:', ticket.id);
                    removeTicketFromAllLists(ticket.id);
                    return;
                }

                removeTicketFromAllLists(ticket.id);

                if (isCreator) {
                    addTicketToContainer('ticketsContent', ticket, 'open');
                    updateTicketCount('ticketsContent', 'openTicketsCount');
                }

                if (isAssignee) {
                    addTicketToContainer('assignedTicketsContent', ticket, 'assigned');
                    updateTicketCount('assignedTicketsContent', 'assignedTicketsCount');
                }
            }

            function addTicketToContainer(containerId, ticket, type) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error('Container not found:', containerId);
                    return;
                }

                const emptyState = container.querySelector('.text-center.text-gray-400');
                if (emptyState) {
                    emptyState.remove();
                }

                const ticketEl = createTicketElement(ticket);

                container.insertBefore(ticketEl, container.firstChild);

                ticketEl.style.opacity = '0';
                ticketEl.style.transform = 'translateY(-10px)';

                setTimeout(() => {
                    ticketEl.style.transition = 'all 0.3s ease-out';
                    ticketEl.style.opacity = '1';
                    ticketEl.style.transform = 'translateY(0)';
                }, 10);

                console.log(`Added ticket ${ticket.id} to ${containerId}`);
            }



            function createTicketElement(ticket) {
                const ticketEl = document.createElement('div');
                ticketEl.id = 'ticket-' + ticket.id;
                ticketEl.className = 'bg-white border border-blue-200 rounded-lg p-3 hover:shadow-md transition cursor-pointer';
                ticketEl.onclick = function() {
                    window.location.href = '/support/tickets/' + ticket.id;
                };

                let priorityClass = 'bg-gray-100 text-gray-600';
                switch(ticket.priority) {
                    case 'URGENT':
                        priorityClass = 'bg-red-200 text-red-800';
                        break;
                    case 'HIGH':
                        priorityClass = 'bg-red-100 text-red-700';
                        break;
                    case 'MEDIUM':
                        priorityClass = 'bg-orange-100 text-orange-700';
                        break;
                    case 'LOW':
                        priorityClass = 'bg-gray-100 text-gray-600';
                        break;
                }

                ticketEl.innerHTML = `
        <div class="flex justify-between items-center mb-1">
            <div class="font-bold text-sm text-[#03594D]">
                ${escapeHtml(ticket.subject)}
            </div>
            <span class="text-[10px] px-2 py-0.5 rounded font-bold ${priorityClass}">
                ${ticket.priority}
            </span>
        </div>
        <div class="text-xs text-gray-500 truncate">
            ${escapeHtml(ticket.description || 'Kh√¥ng c√≥ m√¥ t·∫£')}
        </div>
        <div class="flex justify-between items-center mt-2 text-xs text-gray-400 font-mono">
            <span>${escapeHtml(ticket.customer ? ticket.customer.fullName : 'N/A')}</span>
            <span>${formatTime(ticket.createdAt)}</span>
        </div>
    `;

                return ticketEl;
            }


            function removeTicketFromAllLists(ticketId) {
                const ticketEl = document.getElementById('ticket-' + ticketId);

                if (ticketEl) {
                    ticketEl.style.transition = 'opacity 0.3s, transform 0.3s';
                    ticketEl.style.opacity = '0';
                    ticketEl.style.transform = 'translateX(-20px)';

                    setTimeout(() => {
                        ticketEl.remove();

                        updateTicketCount('ticketsContent', 'openTicketsCount');
                        updateTicketCount('assignedTicketsContent', 'assignedTicketsCount');

                        checkAndShowEmptyState('ticketsContent', 'Kh√¥ng c√≥ ticket ƒëang m·ªü');
                        checkAndShowEmptyState('assignedTicketsContent', 'Kh√¥ng c√≥ ticket n√†o ƒë∆∞·ª£c g√°n cho b·∫°n');

                        console.log(`‚úÖ Removed ticket ${ticketId}`);
                    }, 300);
                }
            }





            function updateTicketCount(containerId, countElementId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const count = container.querySelectorAll('[id^="ticket-"]').length;



                if (countElementId) {
                    const countEl = document.getElementById(countElementId);
                    if (countEl) {
                        countEl.textContent = count;
                    }
                }

                console.log(`üìä Updated count for ${containerId}: ${count}`);
            }


            function checkAndShowEmptyState(containerId, message) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const ticketCount = container.querySelectorAll('[id^="ticket-"]').length;
                const emptyState = container.querySelector('.text-center.text-gray-400');

                if (ticketCount === 0 && !emptyState) {
                    container.innerHTML = `
            <div class="text-center text-gray-400 py-14 text-sm">
                ${message}
            </div>
        `;
                }
            }


            stompClient.subscribe(
                '/topic/staff/' + staffId + '/session-messages',
                function (message) {
                    const newMessage = JSON.parse(message.body);

                    updateSessionPreview(newMessage);

                    if (currentSessionId === newMessage.session.id) {
                        if (!displayedMessageIds.has(newMessage.id)) {
                            appendMessage(newMessage);
                            displayedMessageIds.add(newMessage.id);
                        }
                    }
                }
            );

            if (currentSessionId) {
                subscribeToSession(currentSessionId);
            }
        });
    }


    function subscribeToSession(sessionId) {
        if (currentSubscription) {
            currentSubscription.unsubscribe();
            currentSubscription = null;
        }

        if (stompClient && stompClient.connected) {
            currentSubscription = stompClient.subscribe('/topic/session/' + sessionId + '/messages', function (message) {
                const newMessage = JSON.parse(message.body);
                if (!displayedMessageIds.has(newMessage.id)) {
                    appendMessage(newMessage);
                    displayedMessageIds.add(newMessage.id);
                }
                updateSessionPreview(newMessage);

            });
        }
    }




    function handleLoadSession(el) {
        const sessionId = el.dataset.sessionId;
        const customerFullName = el.dataset.customerFullName;
        const customerPhone = el.dataset.customerPhone;
        const customerEmail = el.dataset.customerEmail;
        const customerUsername = el.dataset.customerUsername;
        const customerId = el.dataset.customerId;

        loadSession(sessionId, customerFullName, customerPhone, customerEmail, customerUsername,customerId);
    }


    function loadSession(sessionId, customerFullName, customerPhone, customerEmail, customerUsername,customerId) {

        document.getElementById('selectChatBanner').classList.add('hidden');
        document.getElementById('chatPanel').classList.remove('hidden');
        document.getElementById('customerPanel').classList.remove('hidden');

        displayedMessageIds.clear();
        currentSessionId = sessionId;

        document.getElementById('chatHeaderName').textContent = customerUsername;
        document.getElementById('chatHeaderAvatar').textContent = getInitial(customerUsername);

        document.getElementById('infoUsername').textContent = customerUsername;
        document.getElementById('infoFullName').textContent = customerFullName;
        document.getElementById('infoPhone').textContent = customerPhone;
        document.getElementById('infoEmail').textContent = customerEmail;

        fetch('/customer/api/sessions/' + sessionId + '/messages')
            .then(response => response.json())
            .then(messages => {
                displayChatWindow(messages);

                subscribeToSession(sessionId);
                loadCustomerBookingHistory(customerId);

            })
            .catch(error => {
                console.error('Error loading messages:', error);
            });

        loadCustomerInfo(sessionId);


        const sessionEl = document.getElementById('session-' + sessionId);
        if (sessionEl) {
            sessionEl.classList.remove('unread');

            const badge = sessionEl.querySelector('.unread-badge');
            if (badge) badge.remove();
        }
        fetch('/support/api/sessions/' + sessionId + '/mark-read', {
            method: 'POST'
        });
    }

    function displayChatWindow(messages) {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';

        if (messages.length === 0) {
            container.innerHTML = `
                    <div class="text-center text-gray-400 py-10">
                        <span class="material-symbols-outlined text-5xl">chat_bubble_outline</span>
                        <p class="mt-2">Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
                    </div>
                `;
            return;
        }

        messages.forEach(message => {
            displayedMessageIds.add(message.id);
            appendMessageToContainer(container, message);
        });

        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    function appendMessage(message) {
        const container = document.getElementById('messagesContainer');
        appendMessageToContainer(container, message);

        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    function appendMessageToContainer(container, message) {
        const isStaff = message.sender && (message.sender.role === 'ROLE_STAFF' || message.sender.userId === staffId);
        const messageTime = formatTime(message.sentAt);
        const senderName = message.sender ? message.sender.fullName : 'Unknown';

        const messageDiv = document.createElement('div');

        if (isStaff) {
            messageDiv.className = 'flex gap-2 justify-end';
            messageDiv.innerHTML = `
                    <div>
                        <div class="bg-[#03594D] text-white rounded-lg rounded-tr-none p-3 shadow-sm max-w-md">
                            <p class="text-sm">${escapeHtml(message.messageText)}</p>
                        </div>
                        <div class="text-xs text-gray-400 mt-1 text-right font-mono">${messageTime}</div>
                    </div>
                    <div class="w-8 h-8 bg-[#D8E268] rounded-full flex items-center justify-center text-sm font-bold text-[#03594D] flex-shrink-0">
                        ${getInitial(senderName)}
                    </div>
                `;
        } else {
            messageDiv.className = 'flex gap-2';
            messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-sm font-bold text-blue-600 flex-shrink-0">
                        ${getInitial(senderName)}
                    </div>
                    <div>
                        <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm max-w-md border border-[#E3E5D2]">
                            <p class="text-sm text-gray-700">${escapeHtml(message.messageText)}</p>
                        </div>
                        <div class="text-xs text-gray-400 mt-1 font-mono">${messageTime}</div>
                    </div>
                `;
        }

        container.appendChild(messageDiv);
    }


    function sendMessage() {
        const input = document.getElementById('messageInput');
        const messageText = input.value.trim();

        if (!messageText || !currentSessionId) return;

        fetch('/customer/api/messages/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `sessionId=${currentSessionId}&messageText=${encodeURIComponent(messageText)}`
        })
            .then(response => response.json())
            .then(message => {
                input.value = '';

                if (!displayedMessageIds.has(message.id)) {
                    appendMessage(message);
                    displayedMessageIds.add(message.id);
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i.');
            });
    }

    function handleMessageKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }


    function loadCustomerInfo(sessionId) {
        fetch('/customer/api/sessions/' + sessionId)
            .then(response => response.json())
            .then(session => {
                currentCustomer = session.customer;
                updateCustomerDisplay(session.customer);

            })
            .catch(error => {
                console.error('Error loading customer info:', error);
            });
    }

    function updateCustomerDisplay(customer) {
        const infoHtml = `
                <div class="flex justify-between py-1">
                    <span class="text-gray-500 font-semibold">T√™n:</span>
                    <span class="font-bold text-[#03594D]">${customer.fullName || 'N/A'}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-500 font-semibold">SƒêT:</span>
                    <span class="font-bold text-[#03594D]">${customer.phone || 'N/A'}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-500 font-semibold">Email:</span>
                    <span class="font-bold text-[#03594D] text-xs">${customer.email || 'N/A'}</span>
                </div>
            `;
        document.getElementById('customerInfo').innerHTML = infoHtml;
    }

    // function createTicketFromSession() {
    //     if (!currentSessionId) {
    //         alert('Vui l√≤ng ch·ªçn m·ªôt chat session tr∆∞·ªõc!');
    //         return;
    //     }
    //     window.location.href = '/support/tickets/create?sessionId=' + currentSessionId;
    // }

    function getInitial(name) {
        return name ? name.charAt(0).toUpperCase() : '?';
    }

    function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function showServices() {
        fetch('/support/api/services/all')
            .then(response => response.json())
            .then(services => {
                let info = 'B·∫¢NG GI√Å D·ªäCH V·ª§:\n\n';
                services.forEach(s => {
                    info += `${s.serviceName}: ${s.price.toLocaleString('vi-VN')}ƒë (${s.durationMinutes} ph√∫t)\n`;
                });
                alert(info);
            });
    }

    function closeSession() {
        if (!currentSessionId) {
            alert('Ch∆∞a ch·ªçn chat n√†o');
            return;
        }

        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng chat n√†y?')) return;


        fetch('/support/api/sessions/' + currentSessionId + '/close', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(() => {
                alert('‚úÖ Chat ƒë√£ ƒë∆∞·ª£c ƒë√≥ng');
                document.getElementById('chatPanel').classList.add('hidden');
                document.getElementById('customerPanel').classList.add('hidden');
                document.getElementById('selectChatBanner').classList.remove('hidden');

                location.reload();
            })
            .catch(error => {
                console.error('Error closing session:', error);
                alert('C√≥ l·ªói x·∫£y ra');
            });
    }

    function showSchedule() {
        alert('GI·ªú L√ÄM VI·ªÜC:\n\nTh·ª© 2 - Th·ª© 6: 8:00 - 18:00\nTh·ª© 7: 8:00 - 17:00\nCh·ªß nh·∫≠t: 9:00 - 16:00');
    }

    connect();




    function openTicketPopup() {
        if (!currentSessionId) {
            alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt chat session tr∆∞·ªõc!');
            return;
        }

        loadManagers();

        document.getElementById('ticketSessionId').value = currentSessionId;

        document.getElementById('ticketCustomerName').textContent =
            document.getElementById('infoFullName').textContent || '-';
        document.getElementById('ticketCustomerPhone').textContent =
            document.getElementById('infoPhone').textContent || '-';
        document.getElementById('ticketCustomerEmail').textContent =
            document.getElementById('infoEmail').textContent || '-';

        document.getElementById('ticketPopup').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeTicketPopup() {
        document.getElementById('ticketPopup').classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('ticketForm').reset();
    }


    function loadManagers() {
        fetch('/support/tickets/api/managers')
            .then(response => response.json())
            .then(managers => {
                const select = document.getElementById('ticketAssignTo');
                select.innerHTML = '<option value="">-- T·ª± ƒë·ªông ph√¢n c√¥ng --</option>';

                managers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager.userId;
                    option.textContent = manager.fullName + ' (' + manager.username + ')';
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading managers:', error);
            });
    }


    document.getElementById('ticketForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalContent = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> ƒêang x·ª≠ l√Ω...';

        const formData = new URLSearchParams(new FormData(this));

        fetch('/support/tickets/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(ticket => {
                submitBtn.innerHTML = '<span class="material-symbols-outlined">check_circle</span> Th√†nh c√¥ng!';
                submitBtn.classList.remove('from-[#03594D]', 'to-[#026B5E]');
                submitBtn.classList.add('bg-emerald-500');

                // Show success message
                setTimeout(() => {
                    const assignedTo = ticket.assignedTo || 'ƒêang ch·ªù ph√¢n c√¥ng';
                    alert(` Ticket ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!

 M√£ ticket: #${ticket.id}
 Ti√™u ƒë·ªÅ: ${ticket.subject}
 ∆Øu ti√™n: ${ticket.priority}
 ƒê∆∞·ª£c g√°n cho: ${assignedTo}

Ticket s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong th·ªùi gian s·ªõm nh·∫•t.`);

                    closeTicketPopup();

                    location.reload();
                }, 800);
            })
            .catch(err => {
                console.error('Error creating ticket:', err);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
                submitBtn.classList.add('bg-red-500');

                alert('C√≥ l·ªói x·∫£y ra khi t·∫°o ticket!\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.');

                setTimeout(() => {
                    submitBtn.classList.remove('bg-red-500');
                    submitBtn.classList.add('from-[#03594D]', 'to-[#026B5E]');
                }, 2000);
            });
    });

    document.getElementById('ticketPopup').addEventListener('click', function(e) {
        if (e.target === this) {
            closeTicketPopup();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('ticketPopup').classList.contains('hidden')) {
            closeTicketPopup();
        }
    });




    /*]]>*/
</script>
</body>
</html>
