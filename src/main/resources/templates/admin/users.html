<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/layout :: adminHead">
    <title>ShenPCare - Users &amp; Roles</title>
</head>
<body class="font-display bg-background-light">

<div th:replace="admin/layout :: adminShell(~{::section}, ${activeMenu})">

    <section>
        <!-- Page heading -->
        <header class="flex flex-wrap justify-between items-center gap-4 mb-6">
            <h1 class="text-[#03594D] text-4xl font-black leading-tight tracking-tight">
                Quản lý Người dùng &amp; Quyền hạn
            </h1>

            <a th:href="@{/admin/users/new}"
               class="flex items-center justify-center gap-2 min-w-[84px] cursor-pointer rounded-full h-12 px-6
                      bg-[#D8E268] text-[#03594D] text-sm font-bold leading-normal tracking-[0.015em]
                      hover:brightness-95 active:scale-[0.98] transition-all">
                <span class="material-symbols-outlined">add</span>
                <span class="truncate">Thêm người dùng mới</span>
            </a>
        </header>

        <!-- Flash message -->
        <div th:if="${message}"
             class="mb-4 rounded-xl bg-emerald-50 text-emerald-800 px-4 py-3 text-sm">
            <span class="font-semibold">Thông báo:</span>
            <span th:text="${message}">Đã lưu.</span>
        </div>

        <!-- Toolbar & Filters -->
        <form class="flex flex-col md:flex-row gap-4 mb-4"
              method="get"
              th:action="@{/admin/users}">

            <!-- Search bar -->
            <div class="flex-grow">
                <label class="flex flex-col min-w-40 h-12 w-full">
                    <div class="flex w-full flex-1 items-stretch rounded-full h-full">
                        <div class="text-gray-500 flex bg-[#F0F2F5] items-center justify-center pl-4
                                    rounded-l-full border-r-0">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                        <input
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full
                                       text-[#03594D] focus:outline-0 focus:ring-0 border-none
                                       bg-[#F0F2F5] h-full placeholder:text-gray-500 px-4
                                       rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                                type="text"
                                name="keyword"
                                placeholder="Tìm kiếm theo tên, email, username..."
                                th:value="${keyword} ?: ''"/>
                    </div>
                </label>
            </div>

            <!-- Filters -->
            <div class="flex gap-3 items-center">
                <!-- Role filter -->
                <select name="role"
                        class="flex h-12 shrink-0 items-center justify-between gap-x-2 rounded-full
                               bg-[#F0F2F5] px-4 text-[#03594D] text-sm font-medium leading-normal border-none">
                    <option value="ALL"
                            th:selected="${selectedRole} == null or ${selectedRole} == 'ALL'">
                        Tất cả vai trò
                    </option>
                    <option th:each="r : ${roles}"
                            th:if="${r} != 'ALL'"
                            th:value="${r}"
                            th:text="${r}"
                            th:selected="${selectedRole} == ${r}">
                    </option>
                </select>

                <!-- Status filter -->
                <select name="status"
                        class="flex h-12 shrink-0 items-center justify-between gap-x-2 rounded-full
                               bg-[#F0F2F5] px-4 text-[#03594D] text-sm font-medium leading-normal border-none">
                    <option value="ALL"
                            th:selected="${selectedStatus} == null or ${selectedStatus} == 'ALL'">
                        Tất cả trạng thái
                    </option>
                    <option th:each="s : ${statuses}"
                            th:if="${s} != 'ALL'"
                            th:value="${s}"
                            th:text="${s == 'ACTIVE' ? 'Hoạt động' : 'Bị khóa'}"
                            th:selected="${selectedStatus} == ${s}">
                    </option>
                </select>

                <!-- Submit filter button -->
                <button type="submit"
                        class="flex h-12 shrink-0 items-center justify-center gap-x-2 rounded-full
                               bg-[#03594D] px-5 text-white text-sm font-semibold leading-normal
                               hover:brightness-110 active:scale-[0.97] transition-all">
                    <span class="material-symbols-outlined text-[18px]">tune</span>
                    <span>Lọc</span>
                </button>
            </div>
        </form>

        <!-- User Data Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-x-auto">
            <table class="w-full text-sm text-left text-[#03594D]">
                <thead class="text-xs uppercase bg-[#F0F2F5]">
                <tr>
                    <th scope="col" class="px-6 py-3">Người dùng</th>
                    <th scope="col" class="px-6 py-3">Vai trò</th>
                    <th scope="col" class="px-6 py-3">Trạng thái</th>
                    <th scope="col" class="px-6 py-3">Ngày tham gia</th>
                    <th scope="col" class="px-6 py-3 text-center">Hành động</th>
                </tr>
                </thead>
                <tbody>
                <!-- Nếu không có user -->
                <tr th:if="${#lists.isEmpty(users)}">
                    <td colspan="5" class="px-6 py-6 text-center text-gray-500">
                        Không có tài khoản nào phù hợp với bộ lọc hiện tại.
                    </td>
                </tr>

                <!-- Dòng user -->
                <tr th:each="user : ${users}"
                    class="bg-white border-b border-gray-100 hover:bg-[#F0F2F5]/60">
                    <th scope="row" class="flex items-center px-6 py-4 whitespace-nowrap">
                        <!-- Avatar chữ cái đầu -->
                        <div class="w-10 h-10 rounded-full bg-[#D8E268] flex items-center justify-center
                                    text-[#03594D] font-bold">
                            <span th:text="${(user.fullName != null && user.fullName != '') ?
                                            #strings.substring(user.fullName,0,1) : 'U'}">
                                U
                            </span>
                        </div>
                        <div class="pl-3">
                            <div class="text-base font-semibold"
                                 th:text="${user.fullName} ?: user.username">
                                Full Name
                            </div>
                            <div class="font-normal text-gray-500"
                                 th:text="${user.email} ?: 'No email'">
                                email@example.com
                            </div>
                        </div>
                    </th>

                    <!-- Role badge -->
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 text-xs font-medium rounded-full"
                              th:text="${user.role}"
                              th:classappend="${
                                  user.role != null && user.role.equalsIgnoreCase('DOCTOR') ? ' text-blue-800 bg-blue-100' :
                                  user.role != null && user.role.equalsIgnoreCase('GROOMER') ? ' text-pink-800 bg-pink-100' :
                                  user.role != null && user.role.equalsIgnoreCase('STORE') ? ' text-orange-800 bg-orange-100' :
                                  user.role != null && user.role.equalsIgnoreCase('SUPPORT') ? ' text-purple-800 bg-purple-100' :
                                  user.role != null && user.role.equalsIgnoreCase('ADMIN') ? ' text-gray-800 bg-gray-200' :
                                  ' text-gray-800 bg-gray-200'
                              }">
                        </span>
                    </td>

                    <!-- Status badge -->
                    <td class="px-6 py-4">
                        <span th:if="${user.active}"
                              class="px-3 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full">
                            Hoạt động
                        </span>
                        <span th:if="${!user.active}"
                              class="px-3 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full">
                            Bị khóa
                        </span>
                    </td>

                    <!-- Joined date -->
                    <td class="px-6 py-4"
                        th:text="${user.createdAt != null ?
                                 #temporals.format(user.createdAt, 'yyyy-MM-dd') :
                                 'N/A'}">
                        2024-01-05
                    </td>

                    <!-- Action buttons -->
                    <td class="px-6 py-4 text-center">
                        <div class="flex justify-center items-center gap-2">
                            <!-- Edit -->
                            <a th:href="@{'/admin/users/' + ${user.userId}}"
                               class="p-2 rounded-full hover:bg-gray-100 active:scale-95 inline-flex items-center justify-center">
                                <span class="material-symbols-outlined text-base">edit</span>
                            </a>

                            <!-- Toggle lock / unlock -->
                            <form th:action="@{'/admin/users/' + ${user.userId} + '/toggle-status'}"
                                  method="post"
                                  class="inline-flex">
                                <button type="submit"
                                        class="p-2 rounded-full hover:bg-gray-100 active:scale-95 inline-flex items-center justify-center">
                                    <span class="material-symbols-outlined text-base"
                                          th:text="${user.active} ? 'lock_open' : 'lock'">
                                        lock_open
                                    </span>
                                </button>
                            </form>
                        </div>
                    </td>

                </tr>
                </tbody>
            </table>
        </div>

        <!-- Summary -->
        <div class="flex items-center justify-between pt-4 text-sm text-gray-600">
            <span>
                Đang hiển thị
                <span class="font-semibold text-[#03594D]"
                      th:text="${displayedCount} ?: 0">0</span>
                trên tổng
                <span class="font-semibold text-[#03594D]"
                      th:text="${totalUsers} ?: 0">0</span>
                tài khoản.
            </span>
        </div>
    </section>
</div>

</body>
</html>
