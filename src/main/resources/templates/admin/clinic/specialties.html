<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{admin/layout :: adminHead}">
        <title>Quản lý Chuyên Khoa</title>
    </head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="no-referrer"></script>

    <body class="font-display bg-background-light">

        <div th:replace="~{admin/layout :: adminShell(~{::section}, ${activeMenu})}">
            <section>
                <div class="mb-8">
                    <a th:href="@{/admin/clinic/services}" class="inline-flex items-center gap-1 text-sm font-medium text-gray-500 hover:text-[#03594D] mb-3 transition-colors">
                        <span class="material-symbols-outlined text-lg">arrow_back</span> Quay lại Dịch vụ
                    </a>
                    <div class="flex flex-wrap items-end justify-between gap-4">
                        <div>
                            <h1 class="text-[#03594D] text-3xl font-black leading-tight tracking-tight">Danh Mục Chuyên Khoa</h1>
                            <p class="text-gray-500 mt-1">Quản lý các khoa phòng khám (Nội, Ngoại, X-Quang...).</p>
                        </div>

                        <div class="flex gap-3">
                            <form action="/admin/clinic/specialties" method="get" class="relative">
                                <input type="text" name="keyword" th:value="${keyword}" placeholder="Tìm chuyên khoa..." 
                                       class="h-11 pl-10 pr-4 rounded-xl border border-gray-200 focus:border-[#03594D] outline-none text-sm w-64 shadow-sm bg-white">
                                <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-400">search</span>
                            </form>

                            <button type="button" onclick="openModalCreate()"
                                    class="h-11 px-6 rounded-xl bg-[#D8E268] text-[#03594D] font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-[20px]">add_circle</span> Thêm Mới
                            </button>
                        </div>
                    </div>
                </div>

                <div th:if="${message}" class="mb-6 p-4 rounded-xl bg-emerald-50 border border-emerald-100 text-emerald-800 flex gap-3 shadow-sm">
                    <span class="material-symbols-outlined">check_circle</span> <span th:text="${message}"></span>
                </div>
                <div th:if="${error}" class="mb-6 p-4 rounded-xl bg-red-50 border border-red-100 text-red-800 flex gap-3 shadow-sm">
                    <span class="material-symbols-outlined">error</span> <span th:text="${error}"></span>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div th:each="s : ${specialties}" class="group relative bg-white rounded-2xl p-6 shadow-sm border border-[#E3E5D2] hover:shadow-md hover:border-[#03594D] transition-all">
                        <div class="absolute top-4 left-4">
                            <span th:if="${s.active}" class="px-2 py-1 bg-emerald-50 text-emerald-700 text-[10px] font-bold rounded border border-emerald-100">HIỆN</span>
                            <span th:unless="${s.active}" class="px-2 py-1 bg-gray-100 text-gray-500 text-[10px] font-bold rounded border border-gray-200">ẨN</span>
                        </div>

                        <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity translate-y-1 group-hover:translate-y-0 duration-200">
                            <button type="button" th:onclick="'openModalEdit(' + ${s.serviceCategoryId} + ')'" 
                                    class="w-8 h-8 bg-white border border-gray-200 text-blue-600 rounded-lg flex items-center justify-center hover:bg-blue-50 shadow-sm transition-colors" title="Chỉnh sửa">
                                <span class="material-symbols-outlined text-[18px]">edit</span>
                            </button>
                            <a th:href="@{'/admin/clinic/specialties/delete/' + ${s.serviceCategoryId}}" 
                               onclick="return confirm('CẢNH BÁO: Bạn có chắc chắn muốn xóa?')"
                               class="w-8 h-8 bg-white border border-gray-200 text-red-600 rounded-lg flex items-center justify-center hover:bg-red-50 shadow-sm transition-colors" title="Xóa">
                                <span class="material-symbols-outlined text-[18px]">delete</span>
                            </a>
                        </div>

                        <div class="text-center mt-6">
                            <div class="relative w-24 h-24 mx-auto mb-4 group-hover:scale-105 transition-transform duration-300">
                                <div class="absolute inset-0 bg-[#E0F2F1] rounded-full"></div>
                                <img th:if="${s.imageFileId != null}" th:src="@{'/api/files/' + ${s.imageFileId}}" class="w-full h-full object-cover rounded-full border-2 border-white shadow-sm relative z-10">
                                <img th:if="${s.imageFileId == null}" th:src="${s.iconUrl}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063822.png'" class="w-full h-full object-contain p-4 relative z-10">
                            </div>
                            <h3 class="text-[#03594D] text-lg font-black truncate px-2" th:text="${s.name}">Tên Khoa</h3>
                            <div class="text-xs text-gray-400 mt-1 line-clamp-2 h-8 px-2" th:utext="${s.description}"></div>

                            <div class="mt-4 flex justify-center">
                                <span class="bg-gray-50 text-gray-600 text-xs font-bold px-3 py-1 rounded-full border border-gray-200 flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                                    <span th:text="${serviceCounts != null && serviceCounts.containsKey(s.serviceCategoryId) ? serviceCounts.get(s.serviceCategoryId) : 0}">0</span> Dịch vụ                        </span>
                            </div>w
                        </div>
                    </div>

                    <div th:if="${#lists.isEmpty(specialties)}" class="col-span-full py-16 text-center text-gray-400 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                        <span class="material-symbols-outlined text-5xl mb-3 text-gray-300">search_off</span>
                        <p class="font-bold text-gray-500">Không tìm thấy chuyên khoa nào.</p>
                    </div>
                </div>

                <div id="specialtyModal" class="hidden fixed inset-0 z-[999] flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-[#03594D]/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto animate-fade-in-up transform scale-100 transition-all">

                        <form action="/admin/clinic/specialties/save" method="post" id="specialtyForm" enctype="multipart/form-data">
                            <input type="hidden" name="serviceCategoryId" id="catId">

                            <div class="border-b border-gray-100 px-6 py-4 bg-[#F8F9FA] flex justify-between items-center sticky top-0 bg-white z-10">
                                <h5 class="text-[#03594D] font-black text-xl" id="modalTitle">Thêm Khoa Mới</h5>
                                <button type="button" onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-200 text-gray-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-xl">close</span>
                                </button>
                            </div>

                            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-1 space-y-6">
                                    <div class="space-y-2">
                                        <label class="block text-xs font-bold text-gray-500 uppercase">Ảnh đại diện / Icon</label>
                                        <div class="relative w-full aspect-square bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 hover:border-[#03594D] cursor-pointer group overflow-hidden transition-all">
                                            <input type="file" name="imageFile" id="imageInput" accept="image/*" onchange="previewUpload(this)" 
                                                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                                            <img id="uploadPreview" class="hidden absolute inset-0 w-full h-full object-cover z-10 bg-white">
                                            <div id="uploadPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-0 group-hover:text-[#03594D]">
                                                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm mb-2 group-hover:scale-110 transition-transform">
                                                    <span class="material-symbols-outlined text-2xl">cloud_upload</span>
                                                </div>
                                                <span class="text-xs font-bold">Tải ảnh lên</span>
                                                <span class="text-[10px] opacity-60">(Max 2MB)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-4 bg-gray-50 rounded-xl border border-gray-100 flex items-center justify-between">
                                        <span class="text-sm font-bold text-gray-700">Hiển thị</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" name="active" id="catActive" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#03594D]"></div>
                                        </label>
                                    </div>
                                </div>

                                <div class="lg:col-span-2 space-y-5">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên Chuyên Khoa <span class="text-red-500">*</span></label>
                                        <input type="text" name="name" id="catName" required placeholder="VD: Khoa Nội, Cấp Cứu..."
                                               class="w-full h-11 px-4 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-[#03594D] focus:ring-0 font-bold text-[#03594D] outline-none transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mô tả chi tiết (Bài viết)</label>
                                        <textarea name="description" id="catEditor" class="w-full h-64"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t border-gray-100 px-6 py-4 bg-gray-50 flex justify-end gap-3 sticky bottom-0 z-10">
                                <button type="button" onclick="closeModal()" class="px-5 py-2.5 rounded-xl border border-gray-200 bg-white text-gray-600 font-bold text-sm hover:bg-gray-50 hover:text-gray-800 transition-all">Hủy bỏ</button>
                                <button type="submit" class="px-6 py-2.5 rounded-xl bg-[#03594D] text-white font-bold text-sm shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all">Lưu Chuyên Khoa</button>
                            </div>
                        </form>
                    </div>
                </div>

                <script>
                    const modalEl = document.getElementById('specialtyModal');

                    function openModalCreate() {
                        document.getElementById('specialtyForm').reset();
                        document.getElementById('catId').value = '';
                        document.getElementById('modalTitle').innerText = 'Thêm Khoa Mới';
                        document.getElementById('catActive').checked = true;

                        const imgPreview = document.getElementById('uploadPreview');
                        const placeholder = document.getElementById('uploadPlaceholder');
                        if (imgPreview)
                            imgPreview.classList.add('hidden');
                        if (placeholder)
                            placeholder.classList.remove('hidden');

                        if (typeof tinymce !== 'undefined' && tinymce.get('catEditor')) {
                            tinymce.get('catEditor').setContent('');
                        }
                        modalEl.classList.remove('hidden');
                    }

                    function openModalEdit(id) {
                        fetch(`/admin/clinic/api/specialty/${id}`)
                                .then(res => res.json())
                                .then(data => {
                                    document.getElementById('catId').value = data.serviceCategoryId;
                                    document.getElementById('catName').value = data.name;
                                    document.getElementById('catActive').checked = data.active;

                                    const imgPreview = document.getElementById('uploadPreview');
                                    const placeholder = document.getElementById('uploadPlaceholder');

                                    if (data.imageFileId) {
                                        imgPreview.src = '/api/files/' + data.imageFileId;
                                        imgPreview.classList.remove('hidden');
                                        placeholder.classList.add('hidden');
                                    } else if (data.iconUrl) {
                                        imgPreview.src = data.iconUrl;
                                        imgPreview.classList.remove('hidden');
                                        placeholder.classList.add('hidden');
                                    } else {
                                        imgPreview.classList.add('hidden');
                                        placeholder.classList.remove('hidden');
                                    }

                                    if (typeof tinymce !== 'undefined' && tinymce.get('catEditor')) {
                                        tinymce.get('catEditor').setContent(data.description || '');
                                    }

                                    document.getElementById('modalTitle').innerText = 'Chỉnh Sửa Chuyên Khoa';
                                    modalEl.classList.remove('hidden');
                                })
                                .catch(err => {
                                    console.error(err);
                                    alert('Lỗi tải dữ liệu.');
                                });
                    }

                    function closeModal() {
                        modalEl.classList.add('hidden');
                    }

                    function previewUpload(input) {
                        if (input.files && input.files[0]) {
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                var img = document.getElementById('uploadPreview');
                                var placeholder = document.getElementById('uploadPlaceholder');
                                img.src = e.target.result;
                                img.classList.remove('hidden');
                                placeholder.classList.add('hidden');
                            }
                            reader.readAsDataURL(input.files[0]);
                        }
                    }

                    document.addEventListener("DOMContentLoaded", function () {
                        if (typeof tinymce !== 'undefined') {
                            tinymce.init({
                                selector: '#catEditor',
                                height: 300,
                                menubar: false,
                                plugins: 'lists link image code',
                                toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link image | code',
                                content_style: 'body { font-family:Plus Jakarta Sans,sans-serif; font-size:14px }'
                            });
                        }
                    });
                </script>
            </section>
        </div>
    </body>
</html>