<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: adminHead}">
    <title>ShenPCare - ƒêi·ªÅu Ph·ªëi Booking</title>
</head>
<body class="font-display bg-background-light">

<style>
    .modal {
        position: fixed; top: 0; left: 0; z-index: 1055;
        display: none; width: 100%; height: 100%;
        overflow-x: hidden; overflow-y: auto; outline: 0;
    }
    .modal-dialog {
        position: relative; width: auto; margin: 0.5rem; pointer-events: none;
        transition: transform .3s ease-out;
        transform: translate(0,-50px);
    }
    @media (min-width: 576px) {
        .modal-dialog { max-width: 500px; margin: 1.75rem auto; }
        .modal-dialog-centered { min-height: calc(100% - 3.5rem); display: flex; align-items: center; }
    }
    .modal.show .modal-dialog { transform: none; }
    .modal.fade .modal-dialog { transition: transform .3s ease-out; transform: translate(0,-50px); }
    .modal-content {
        position: relative; display: flex; flex-direction: column; width: 100%; pointer-events: auto;
        background-color: #fff; background-clip: padding-box;
        border: 1px solid rgba(0,0,0,.2); border-radius: 1rem; outline: 0;
    }
    .modal-backdrop {
        position: fixed; top: 0; left: 0; z-index: 1050; width: 100vw; height: 100vh;
        background-color: #000;
    }
    .modal-backdrop.fade { opacity: 0; }
    .modal-backdrop.show { opacity: 0.5; }
</style>

<div th:replace="~{admin/layout :: adminShell(~{::section}, 'booking')}">
    <section>
        <div th:if="${message}" class="mb-4 p-4 bg-green-100 text-green-700 rounded-xl flex items-center gap-2">
            <span class="material-symbols-outlined">check_circle</span>
            <span th:text="${message}"></span>
        </div>
        <div th:if="${error}" class="mb-4 p-4 bg-red-100 text-red-700 rounded-xl flex items-center gap-2">
            <span class="material-symbols-outlined">error</span>
            <span th:text="${error}"></span>
        </div>

        <header class="flex flex-wrap justify-between items-center gap-4 mb-6">
            <div>
                <h1 class="text-[#03594D] text-3xl font-black leading-tight tracking-tight">Gi√°m S√°t & ƒêi·ªÅu Ph·ªëi</h1>
                <p class="text-sm text-gray-500 mt-1">Qu·∫£n l√Ω l·ªãch h·∫πn v√† x·ª≠ l√Ω s·ª± c·ªë.</p>
            </div>
            <div class="flex items-center gap-3 bg-white p-2 rounded-lg border border-[#E3E5D2] shadow-sm">
                <span class="text-sm font-bold text-[#03594D] pl-2">Ng√†y:</span>
                <form action="/admin/booking/monitor" method="get" class="flex gap-2">
                    <input type="date" name="date" th:value="${currentDate}" 
                           class="border-none bg-transparent font-bold text-[#03594D] focus:ring-0 p-0 h-auto cursor-pointer"
                           onchange="this.form.submit()">
                    <input type="hidden" name="species" th:value="${speciesFilter}">
                    <input type="hidden" name="keyword" th:value="${keyword}">
                </form>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-6 rounded-2xl border border-[#E3E5D2] shadow-sm flex flex-col justify-between relative group">
                <button type="button" 
                        class="absolute top-4 right-4 p-2 text-gray-400 hover:text-[#03594D] hover:bg-gray-100 rounded-full transition-all"
                        id="btnQuota"
                        title="ƒêi·ªÅu ch·ªânh gi·ªõi h·∫°n">
                    <span class="material-symbols-outlined">settings</span>
                </button>

                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Spa & Grooming</p>
                        <h3 class="text-2xl font-black text-[#03594D] mt-1">
                            <span th:text="${spaUsed}">0</span> / <span th:text="${spaTotal}">20</span>
                        </h3>
                    </div>
                    <div class="p-2 bg-blue-50 text-blue-600 rounded-lg mr-8">
                        <span class="material-symbols-outlined">content_cut</span>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs font-bold mb-1">
                        <span class="text-gray-500">C√¥ng su·∫•t</span>
                        <span class="text-blue-600" th:text="${spaProgress} + '%'">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" 
                             th:style="'width: ' + ${spaProgress} + '%'"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl border border-[#E3E5D2] shadow-sm flex flex-col justify-center gap-4">
                <form action="/admin/booking/monitor" method="get" class="w-full">
                    <input type="hidden" name="date" th:value="${currentDate}">
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                        <input type="text" name="keyword" th:value="${keyword}" 
                               class="w-full pl-10 pr-4 py-3 rounded-xl border border-[#E3E5D2] focus:border-[#03594D] focus:ring-0 text-sm font-medium"
                               placeholder="T√¨m kh√°ch h√†ng, SƒêT, t√™n Pet...">
                    </div>
                </form>
                <div class="flex gap-2">
                     <a th:href="@{/admin/booking/monitor(date=${currentDate}, species='ALL', keyword=${keyword})}"
                       class="flex-1 py-2 text-center rounded-lg text-sm font-bold border transition-all"
                       th:classappend="${speciesFilter == 'ALL'} ? 'bg-[#03594D] text-white border-[#03594D]' : 'bg-white text-gray-500 border-[#E3E5D2] hover:bg-gray-50'">All</a>
                    <a th:href="@{/admin/booking/monitor(date=${currentDate}, species='DOG', keyword=${keyword})}"
                       class="flex-1 py-2 text-center rounded-lg text-sm font-bold border transition-all"
                       th:classappend="${speciesFilter == 'DOG'} ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-gray-500 border-[#E3E5D2] hover:bg-gray-50'">Ch√≥ üê∂</a>
                    <a th:href="@{/admin/booking/monitor(date=${currentDate}, species='CAT', keyword=${keyword})}"
                       class="flex-1 py-2 text-center rounded-lg text-sm font-bold border transition-all"
                       th:classappend="${speciesFilter == 'CAT'} ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-500 border-[#E3E5D2] hover:bg-gray-50'">M√®o üê±</a>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-[#E3E5D2] min-h-[500px]">
            <table class="w-full text-sm text-left text-[#03594D]">
                <thead class="text-xs uppercase bg-[#F8F9FA] text-gray-500 font-bold border-b border-gray-100">
                    <tr>
                        <th class="px-6 py-4">Kh√°ch H√†ng</th>
                        <th class="px-6 py-4">Th√∫ C∆∞ng</th>
                        <th class="px-6 py-4">D·ªãch V·ª•</th>
                        <th class="px-6 py-4">Gi·ªù H·∫πn</th>
                        <th class="px-6 py-4">Nh√¢n Vi√™n</th>
                        <th class="px-6 py-4">Tr·∫°ng Th√°i</th>
                        <th class="px-6 py-4 text-right">T√°c v·ª•</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr th:each="b : ${bookings}" class="hover:bg-gray-50 transition-colors group" th:classappend="${b.isUrgent} ? 'bg-red-50' : ''">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center font-bold text-[#03594D] text-lg">
                                    <span th:text="${(b.customerName != null and b.customerName.length() > 0) ? #strings.substring(b.customerName,0,1) : '?'}"></span>
                                </div>
                                <div>
                                    <div class="font-bold text-[#03594D]" th:text="${b.customerName}"></div>
                                    <div class="text-xs text-gray-400 font-mono mt-0.5 cursor-pointer" 
                                         th:data-phone="${b.customerPhone}" onclick="copyToClipboard(this.dataset.phone)">
                                        <span class="material-symbols-outlined text-[12px] align-middle">call</span>
                                        <span th:text="${b.customerPhone}" class="align-middle"></span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span th:if="${b.petSpecies == 'DOG'}" class="material-symbols-outlined text-orange-500">pet_supplies</span>
                                <span th:if="${b.petSpecies == 'CAT'}" class="material-symbols-outlined text-blue-500">cruelty_free</span>
                                <div>
                                    <div class="font-bold text-[#03594D]" th:text="${b.petName}"></div>
                                    <div class="text-xs text-gray-400" th:text="${b.petBreed}"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-semibold text-[#03594D]" th:text="${b.serviceName}"></div>
                            <div th:if="${b.isUrgent}" class="mt-1 inline-flex items-center gap-1 bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold animate-pulse">
                                <span class="material-symbols-outlined text-[12px]">warning</span> KH·∫®N C·∫§P
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="inline-flex items-center gap-1 bg-gray-100 px-2 py-1 rounded text-xs font-bold text-gray-600">
                                <span class="material-symbols-outlined text-[14px]">schedule</span>
                                <span th:text="${b.timeSlot}"></span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600" th:text="${b.staffName}"></td>
                        <td class="px-6 py-4">
                            <span th:if="${b.status == 'PENDING_CONFIRMATION'}" class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded border border-yellow-200">CH·ªú X·ª¨ L√ù</span>
                            <span th:if="${b.status == 'CONFIRMED'}" class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded border border-green-200">ƒê√É CH·ªêT</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button th:if="${b.status == 'PENDING_CONFIRMATION'}"
                                    class="h-8 px-4 bg-[#D8E268] text-[#03594D] rounded-lg font-bold text-xs hover:shadow-md transition-all btn-confirm"
                                    th:data-id="${b.bookingId}"
                                    th:data-date="${b.bookingDate}">
                                X·ª≠ l√Ω
                            </button>
                            <button th:if="${b.status == 'CONFIRMED'}"
                                    type="button"
                                    class="h-8 w-8 inline-flex items-center justify-center bg-gray-100 text-gray-500 rounded-lg hover:bg-blue-100 hover:text-blue-600 transition-all btn-edit"
                                    th:data-id="${b.bookingId}"
                                    th:data-date="${b.bookingDate}"
                                    th:data-time="${b.startTime}"
                                    th:data-staff="${b.staffName}"
                                    th:data-type="${b.serviceType}" 
                                    title="ƒêi·ªÅu ch·ªânh / D·ªùi l·ªãch">
                                <span class="material-symbols-outlined text-[18px]">edit_calendar</span>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" style="z-index: 1055;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-2xl border-0 shadow-xl">
                <form action="/admin/booking/confirm" method="post">
                    <div class="modal-header border-b border-gray-100 px-6 py-4 bg-[#F0F8F7]">
                        <h5 class="text-[#03594D] font-bold text-lg">X√°c nh·∫≠n Booking</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body px-6 py-6 flex flex-col gap-4">
                        <input type="hidden" name="bookingId" id="modalBookingIdInput">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Gi·ªù ch·ªët:</label>
                            <input type="time" class="w-full rounded-lg border-gray-300 focus:border-[#03594D] focus:ring-0" name="confirmTime" required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Nh√¢n vi√™n th·ª±c hi·ªán:</label>
                            <select class="w-full rounded-lg border-gray-300 focus:border-[#03594D] focus:ring-0 staff-select" name="assignedStaffId" required>
                                <option value="">ƒêang t·∫£i...</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer border-t border-gray-100 px-6 py-4 bg-gray-50 rounded-b-2xl">
                        <button type="button" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-bold text-sm" data-bs-dismiss="modal">ƒê√≥ng</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-[#03594D] text-white font-bold text-sm">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-2xl border-0 shadow-xl">
                <form action="/admin/booking/update" method="post">
                    <div class="modal-header border-b border-gray-100 px-6 py-4 bg-orange-50">
                        <h5 class="text-orange-800 font-bold text-lg flex items-center gap-2">
                            <span class="material-symbols-outlined">edit_calendar</span> ƒêi·ªÅu ch·ªânh ƒê∆°n h√†ng
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body px-6 py-6 flex flex-col gap-4">
                        <input type="hidden" name="bookingId" id="editBookingId">
                        
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-yellow-800 mb-2">
                            <span class="font-bold">L∆∞u √Ω:</span> Thay ƒë·ªïi ng√†y/gi·ªù s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn l·ªãch tr√¨nh c·ªßa nh√¢n vi√™n v√† kh√°ch h√†ng.
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Ng√†y h·∫πn m·ªõi:</label>
                            <input type="date" class="w-full rounded-lg border-gray-300 focus:border-[#03594D] focus:ring-0" name="newDate" id="editDate" required>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Gi·ªù h·∫πn m·ªõi:</label>
                            <input type="time" class="w-full rounded-lg border-gray-300 focus:border-[#03594D] focus:ring-0" name="newTime" id="editTime" required>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">ƒêi·ªÅu ph·ªëi l·∫°i Nh√¢n vi√™n:</label>
                            <select class="w-full rounded-lg border-gray-300 focus:border-[#03594D] focus:ring-0 staff-select" name="newStaffId" required>
                                <option value="">Ch·ªçn nh√¢n vi√™n...</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer border-t border-gray-100 px-6 py-4 bg-gray-50 rounded-b-2xl">
                        <button type="button" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-bold text-sm" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-orange-600 text-white font-bold text-sm hover:bg-orange-700">C·∫≠p nh·∫≠t</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="quotaModal" tabindex="-1" aria-hidden="true" style="z-index: 1055;">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content rounded-2xl border-0 shadow-xl">
                <form action="/admin/booking/update-quota" method="post">
                    <div class="modal-header border-b border-gray-100 px-6 py-4">
                        <h5 class="text-[#03594D] font-bold text-lg">C·∫•u h√¨nh Slot</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body px-6 py-6">
                        <input type="hidden" name="date" th:value="${currentDate}">
                        <label class="block text-sm font-bold text-gray-700 mb-1">S·ªë l∆∞·ª£ng t·ªëi ƒëa:</label>
                        <input type="number" name="newLimit" class="w-full rounded-lg border-gray-300 font-bold text-center text-lg" th:value="${spaTotal}" min="1">
                    </div>
                    <div class="modal-footer border-t border-gray-100 px-6 py-4 bg-gray-50 rounded-b-2xl justify-center">
                        <button type="submit" class="px-6 py-2 rounded-lg bg-[#03594D] text-white font-bold text-sm w-full">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("Script ƒë√£ ch·∫°y! ƒêang kh·ªüi t·∫°o c√°c n√∫t b·∫•m...");

        // 1. Load Staff Function
        function loadStaff(date, selectElementId, serviceType) {
            const selects = document.querySelectorAll(selectElementId);
            let role = 'GROOMER';
            if (serviceType === 'VET' || serviceType === 'KHAM') role = 'DOCTOR';
            
            selects.forEach(select => {
                select.innerHTML = '<option>ƒêang t·∫£i...</option>';
                fetch(`/admin/booking/api/staff-on-duty?date=${date}&role=${role}`)
                    .then(res => res.json())
                    .then(data => {
                        select.innerHTML = '';
                        if (data.length === 0) select.innerHTML = `<option value="">Kh√¥ng c√≥ ${role} r·∫£nh!</option>`;
                        else {
                            data.forEach(staff => {
                                let option = document.createElement('option');
                                option.value = staff.staffId;
                                option.text = `${staff.fullName} (${staff.shift})`;
                                select.appendChild(option);
                            });
                        }
                    })
                    .catch(err => {
                        console.error("L·ªói API:", err);
                        select.innerHTML = '<option value="">L·ªói k·∫øt n·ªëi!</option>';
                    });
            });
        }

        // 2. Manual Trigger for Quota Modal
        const btnQuota = document.getElementById('btnQuota');
        if(btnQuota) {
            btnQuota.addEventListener('click', function() {
                console.log("ƒê√£ b·∫•m n√∫t C·∫•u h√¨nh Quota");
                const modal = new bootstrap.Modal(document.getElementById('quotaModal'));
                modal.show();
            });
        }

        // 3. Trigger for Edit Modal
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log("ƒê√£ b·∫•m n√∫t Edit");
                const id = this.dataset.id;
                const date = this.dataset.date;
                const timeFull = this.dataset.time;
                const type = this.dataset.type;

                let timeStr = "";
                if (timeFull) {
                    if (timeFull.includes('T')) timeStr = timeFull.split('T')[1].substring(0, 5);
                    else timeStr = timeFull.substring(0, 5);
                }

                document.getElementById('editBookingId').value = id;
                document.getElementById('editDate').value = date;
                document.getElementById('editTime').value = timeStr;

                loadStaff(date, '#editModal .staff-select', type);
                
                // Clone date input
                const dateInput = document.getElementById('editDate');
                const newDateInput = dateInput.cloneNode(true);
                dateInput.parentNode.replaceChild(newDateInput, dateInput);
                newDateInput.addEventListener('change', function() {
                    loadStaff(this.value, '#editModal .staff-select', type);
                });

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            });
        });

        // 4. Trigger for Confirm Modal
        document.querySelectorAll('.btn-confirm').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const date = this.dataset.date;
                document.getElementById('modalBookingIdInput').value = id;
                loadStaff(date, '#confirmModal .staff-select', 'SPA');
                
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();
            });
        });
    });

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        console.log("ƒê√£ copy: " + text);
    }
    </script>
</div>
</body>
</html>