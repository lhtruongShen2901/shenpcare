<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="admin/layout :: adminHead">
        <title>ShenPCare - Qu·∫£n l√Ω Booking</title>
    </head>
    <body class="font-display bg-background-light">

        <div th:replace="admin/layout :: adminShell(~{::section}, 'bookings')">
            <section>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <form th:action="@{/admin/bookings/list}" method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-3 text-gray-400">search</span>
                            <input type="text" name="keyword" th:value="${keyword}" 
                                   placeholder="M√£ ƒë∆°n, T√™n kh√°ch, SƒêT..." 
                                   class="w-full pl-10 pr-4 py-2.5 rounded-xl border-gray-200 focus:border-[#03594D] focus:ring-[#03594D]">
                        </div>

                        <input type="date" name="date" th:value="${selectedDate}" 
                               class="w-full px-4 py-2.5 rounded-xl border-gray-200 focus:border-[#03594D] focus:ring-[#03594D] text-gray-600">

                        <select name="status" class="w-full px-4 py-2.5 rounded-xl border-gray-200 focus:border-[#03594D] focus:ring-[#03594D] text-gray-600">
                            <option value="ALL">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="PENDING" th:selected="${selectedStatus == 'PENDING'}">üïí Ch·ªù x√°c nh·∫≠n</option>
                            <option value="CONFIRMED" th:selected="${selectedStatus == 'CONFIRMED'}">üîµ ƒê√£ x√°c nh·∫≠n</option>
                            <option value="COMPLETED" th:selected="${selectedStatus == 'COMPLETED'}">‚úÖ Ho√†n th√†nh</option>
                            <option value="CANCELLED" th:selected="${selectedStatus == 'CANCELLED'}">‚ùå ƒê√£ h·ªßy</option>
                        </select>

                        <button type="submit" class="w-full bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">filter_list</span> L·ªçc d·ªØ li·ªáu
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold border-b border-gray-100">
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr th:each="b : ${bookings}" class="hover:bg-gray-50 transition group">
                                    <td class="px-6 py-4 font-mono font-bold text-gray-500" th:text="'#' + ${b.bookingId}"></td>
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-[#03594D]" th:text="${b.customer != null ? b.customer.fullName : 'V√£ng lai'}"></div>
                                        <div class="text-xs text-gray-500 flex items-center gap-1">
                                            <span class="material-symbols-outlined text-[12px]">call</span>
                                            <span th:text="${b.customer != null ? b.customer.phone : '---'}"></span>
                                        </div>
                                        <div class="mt-1 inline-flex items-center gap-1 bg-orange-50 text-orange-700 px-2 py-0.5 rounded text-xs border border-orange-100" th:if="${b.pet != null}">
                                            <span class="material-symbols-outlined text-[12px]">pets</span> <span th:text="${b.pet.name}"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-gray-800" th:text="${b.service != null ? b.service.name : '---'}"></div>
                                        <span th:if="${b.isUrgent}" class="text-xs font-bold text-red-600 bg-red-50 px-1 rounded border border-red-100 flex w-fit items-center gap-1 mt-1">
                                            <span class="material-symbols-outlined text-[12px]">bolt</span> G·∫§P
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-gray-700" th:text="${#temporals.format(b.bookingDate, 'dd/MM/yyyy')}"></div>
                                        <div class="text-xs text-[#03594D] bg-[#03594D]/10 px-2 py-0.5 rounded w-fit mt-1 font-mono" 
                                             th:text="${b.startTime != null ? #temporals.format(b.startTime, 'HH:mm') : '--:--'}"></div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div th:if="${b.staff != null}" class="flex items-center gap-2">
                                            <div class="w-6 h-6 rounded-full bg-[#D8E268] text-[#03594D] flex items-center justify-center text-xs font-bold">
                                                <span th:text="${#strings.substring(b.staff.fullName,0,1)}"></span>
                                            </div>
                                            <span class="text-sm font-medium" th:text="${b.staff.fullName}"></span>
                                        </div>
                                        <span th:unless="${b.staff != null}" class="text-xs text-gray-400 italic bg-gray-100 px-2 py-1 rounded">Ch∆∞a g√°n</span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <span th:class="${'px-2.5 py-1 rounded-full text-xs font-bold border ' + 
                                              (b.status == 'PENDING' ? 'bg-yellow-50 text-yellow-700 border-yellow-200' : 
                                              (b.status == 'CONFIRMED' ? 'bg-blue-50 text-blue-700 border-blue-200' : 
                                              (b.status == 'COMPLETED' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200')))}"
                                              th:text="${b.status}"></span>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <button type="button" 
                                                th:onclick="openEditModal(
                                                [[${b.bookingId}]], 
                                                [[${b.bookingDate}]], 
                                                [[${b.startTime}]], 
                                                [[${b.staff != null ? b.staff.userId : ''}]],
                                                [[${b.status}]]
                                                )"
                                                class="inline-flex items-center justify-center px-3 py-1.5 rounded-lg bg-gray-50 text-gray-600 hover:bg-[#D8E268] hover:text-[#03594D] transition shadow-sm border border-gray-200 hover:border-[#D8E268] text-xs font-bold gap-1 ml-auto"
                                                title="Ch·ªânh s·ª≠a & Ph√¢n c√¥ng">
                                            <span class="material-symbols-outlined text-[16px]">edit_calendar</span>
                                            C·∫≠p nh·∫≠t
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="editModal" class="fixed inset-0 z-50 hidden">
                    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="closeEditModal()"></div>

                    <div class="absolute inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all animate-fade-in-up">

                            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                                <div>
                                    <h3 class="text-lg font-bold text-[#03594D]">C·∫≠p nh·∫≠t ƒê∆°n h√†ng</h3>
                                    <p class="text-xs text-gray-500">ƒêi·ªÅu ch·ªânh th·ªùi gian, nh√¢n s·ª± v√† tr·∫°ng th√°i</p>
                                </div>
                                <button onclick="closeEditModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>

                            <form th:action="@{/admin/bookings/update}" method="post" class="p-6 space-y-5">
                                <input type="hidden" id="modalBookingId" name="bookingId">

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ng√†y h·∫πn</label>
                                        <input type="date" id="modalDate" name="newDate" required
                                               class="w-full rounded-xl border-gray-200 focus:border-[#03594D] focus:ring-[#03594D] bg-gray-50">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gi·ªù h·∫πn</label>
                                        <input type="time" id="modalTime" name="newTime" required
                                               class="w-full rounded-xl border-gray-200 focus:border-[#03594D] focus:ring-[#03594D] bg-gray-50">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nh√¢n vi√™n ph·ª• tr√°ch</label>
                                    <div class="relative">
                                        <span class="material-symbols-outlined absolute left-3 top-3 text-gray-400 pointer-events-none">badge</span>
                                        <select id="modalStaff" name="newStaffId" class="w-full pl-10 pr-4 py-2.5 rounded-xl border-gray-200 focus:border-[#03594D] focus:ring-[#03594D]">
                                            <option value="">-- Ch∆∞a ph√¢n c√¥ng --</option>
                                            <option th:each="s : ${staffList}" 
                                                    th:value="${s.userId}" 
                                                    th:text="${s.fullName} + ' (' + ${s.role} + ')'">
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tr·∫°ng th√°i x·ª≠ l√Ω</label>
                                    <div class="relative">
                                        <span class="material-symbols-outlined absolute left-3 top-3 text-gray-400 pointer-events-none">flag</span>
                                        <select id="modalStatus" name="newStatus" class="w-full pl-10 pr-4 py-2.5 rounded-xl border-gray-200 focus:border-[#03594D] focus:ring-[#03594D]">
                                            <option value="PENDING">üïí Ch·ªù x√°c nh·∫≠n (M·ªõi)</option>
                                            <option value="CONFIRMED">üîµ ƒê√£ x√°c nh·∫≠n (S·∫µn s√†ng)</option>
                                            <option value="COMPLETED">‚úÖ Ho√†n th√†nh (ƒê√£ xong)</option>
                                            <option value="CANCELLED">‚ùå ƒê√£ h·ªßy</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="pt-4 flex gap-3">
                                    <button type="button" onclick="closeEditModal()" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition">H·ªßy b·ªè</button>
                                    <button type="submit" class="flex-1 py-3 rounded-xl bg-[#03594D] text-white font-bold hover:bg-[#024037] transition shadow-lg flex justify-center items-center gap-2">
                                        <span class="material-symbols-outlined text-[20px]">save</span> L∆∞u thay ƒë·ªïi
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <script>
                   
                    function openEditModal(id, date, startTime, staffId, status) {
                        document.getElementById('modalBookingId').value = id;
                        document.getElementById('modalDate').value = date;
                        if (startTime) {
                            let timeVal = startTime.toString();
                            if (timeVal.length > 5)
                                timeVal = timeVal.substring(0, 5);
                            document.getElementById('modalTime').value = timeVal;
                        }
                        document.getElementById('modalStaff').value = staffId || "";
                        document.getElementById('modalStatus').value = status;
                        document.getElementById('editModal').classList.remove('hidden');
                    }
                    function closeEditModal() {
                        document.getElementById('editModal').classList.add('hidden');
                    }
                </script>

            </section>
        </div>
    </body>
</html>