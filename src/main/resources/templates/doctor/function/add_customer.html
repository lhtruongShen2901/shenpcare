<!DOCTYPE html>
<html lang="vi"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Veterinary Management - Add Customer and Pet</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#03594D", // Deep Teal - Text & Lines
                        accent: "#D8E268", // Lime Green - General Buttons
                        dog: "#FF9124", // Dog Orange
                        cat: "#FCCDDC", // Cat Pink
                        "background-light": "#F8FAFC", 
                        "background-dark": "#0F172A", 
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1E293B", 
                    },
                    fontFamily: {
                        sans: ["Nunito", "sans-serif"],
                        display: ["Nunito", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "1rem",
                    },
                },
            },
        };
    </script>
<style type="text/tailwindcss">
        @layer utilities {
            .nav-item {
                @apply flex items-center px-4 py-3 mb-2 rounded-xl transition-colors duration-200 font-bold text-sm;
            }
            .nav-item-active {
                @apply bg-accent text-primary shadow-sm;
            }
            .nav-item-inactive {
                @apply text-primary dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700;
            }
            .form-input {
                @apply w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-accent focus:border-accent shadow-sm transition-shadow dark:text-white dark:placeholder-gray-500 text-primary placeholder-gray-400 font-medium;
            }
            .form-label {
                @apply block mb-2 text-sm font-bold text-primary dark:text-gray-300;
            }
            .section-header {
                @apply flex items-center gap-2 mb-6 pb-2 border-b border-gray-100 dark:border-slate-700 text-primary dark:text-accent;
            }
            .section-title {
                @apply text-lg font-extrabold text-primary dark:text-white;
            }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-100 font-sans transition-colors duration-300 overflow-hidden h-screen flex">
<aside class="w-72 bg-surface-light dark:bg-surface-dark h-full flex flex-col border-r border-gray-100 dark:border-slate-700 shadow-sm relative z-20 hidden md:flex">
<div class="p-6 flex items-center space-x-4 mb-4">
<div class="relative">
<img alt="Avatar Bác sĩ" class="w-12 h-12 rounded-full object-cover ring-2 ring-accent" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBXrbgxSAdX_gtvpl1W5q4Ekf9qRsXvEJjNBRwsjxC-PQ0DVHr0ATmDbg9QWRGQiRnsiyIh2N5_08CpDN2AiVgNsa5ZbEiunSsxiGOP0Xv46BPdC7csTARiMQvTmArI3zBi-cE9XdsCozEFPrGNDX3BRwGNnZ89rAvHrR28kgKVBKIbMeXSSQrbR6tvwRNMhjEDr5j_xIEtujMhggtgROZTc96-8EL4T8S8sLlpfqBRmmlAXwEw5dN5lOIYUINuJAiQKGH98K1BV7jU"/>
<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-surface-dark"></div>
</div>
<div>
<h3 class="text-primary dark:text-accent font-extrabold text-lg">Dr. Test</h3>
<p class="text-xs text-gray-500 dark:text-gray-400 font-semibold">Veterinarian</p>
</div>
</div>
<nav class="flex-1 px-4 overflow-y-auto">
<a class="nav-item nav-item-inactive" th:href="@{/doctor/dashboard}">
<span class="material-icons-round mr-3">dashboard</span>
      Dashboard
    </a>
<a class="nav-item nav-item-inactive" th:href="@{/doctor/work}">
<span class="material-icons-round mr-3">calendar_month</span>
      Appointment Management
    </a>
<a class="nav-item nav-item-inactive" th:href="@{/doctor/pet-passport}">
<span class="material-icons-round mr-3">folder_open</span>
      Medical Records
    </a>
<a class="nav-item nav-item-active" th:href="@{/doctor/customers}">
<span class="material-icons-round mr-3">people_alt</span>
      Customers
    </a>
<a class="nav-item nav-item-inactive" th:href="@{/doctor/reports}">
<span class="material-icons-round mr-3">bar_chart</span>
      Reports
    </a>
<a class="nav-item nav-item-inactive" th:href="@{/doctor/settings}">
<span class="material-icons-round mr-3">settings</span>
      Settings
    </a>
</nav>
<div class="p-4 mt-auto">
<a class="flex items-center px-4 py-3 text-red-500 dark:text-red-400 font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors" th:href="@{/logout}">
<span class="material-icons-round mr-3 transform rotate-180">logout</span>
      Logout
    </a>
</div>
</aside>
<main class="flex-1 h-full overflow-y-auto flex flex-col p-4 lg:p-10 relative bg-background-light dark:bg-background-dark">
<header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
<div>
<h1 class="text-3xl font-extrabold text-primary dark:text-white tracking-tight">Add Customer and Pet</h1>
<p class="text-gray-500 dark:text-gray-400 mt-1 text-sm">Enter detailed information of the customer and new pets</p>
</div>
</header>
<!-- Flash messages -->
<div th:if="${success}" class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 flex items-center gap-2">
  <span class="material-icons-round text-lg">check_circle</span>
  <span th:text="${success}"></span>
</div>
<div th:if="${error}" class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800 flex items-center gap-2">
  <span class="material-icons-round text-lg">error</span>
  <span th:text="${error}"></span>
</div>
<div class="bg-surface-light dark:bg-surface-dark rounded-3xl shadow-sm border border-gray-100 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
<div class="flex-1 overflow-y-auto p-6 md:p-8 lg:p-10">
<form id="customerForm" th:action="@{/doctor/customers}" th:object="${customer}" method="post" class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                    <!-- CSRF token -->
                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <!-- username hidden (optional) - controller will auto-generate if empty -->
                    <input type="hidden" th:field="*{username}" />
<div class="space-y-6">
<div class="section-header">
<span class="material-symbols-outlined text-2xl">person_pin</span>
<h2 class="section-title">Customer Information</h2>
</div>
<div>
                        <label class="form-label" for="customer-name">
                                      Customer Name <span class="text-red-500">*</span>
                                    </label>
                                    <input class="form-input" id="customer-name" th:field="*{fullName}" placeholder="e.g. John Doe" required="" type="text"/>
                                    <span class="text-xs text-red-500" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}">Invalid name</span>
                    </div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
<div>
                                <label class="form-label" for="phone-number">
                                                                Phone Number <span class="text-red-500">*</span>
                                </label>
                                                                <input class="form-input" id="phone-number" th:field="*{phone}" placeholder="e.g. 090xxxxxxx" required="" type="tel"/>
                                                                <span class="text-xs text-red-500" th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}">Invalid phone number</span>
                            </div>
                            <div>
                                <label class="form-label" for="email">
                              Email <span class="text-red-500">*</span>
              </label>
                              <input class="form-input" id="email" th:field="*{email}" placeholder="example@email.com" required type="email"/>
                              <span class="text-xs text-red-500" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">Email không hợp lệ</span>
                            </div>
</div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                          <div>
                            <label class="form-label" for="city">City <span class="text-red-500">*</span></label>
                            <input class="form-input" id="city" th:field="*{city}" placeholder="e.g. Hanoi" required type="text"/>
                            <span class="text-xs text-red-500" th:if="${#fields.hasErrors('city')}" th:errors="*{city}">Invalid city</span>
                          </div>
                          <div>
                            <label class="form-label" for="district">District <span class="text-red-500">*</span></label>
                            <input class="form-input" id="district" th:field="*{district}" placeholder="e.g. Thanh Xuan" required type="text"/>
                            <span class="text-xs text-red-500" th:if="${#fields.hasErrors('district')}" th:errors="*{district}">Invalid district</span>
                          </div>
                        </div>
                        <div>
                          <label class="form-label" for="address">
                                                      Address <span class="text-red-500">*</span>
                                                    </label>
                                                    <textarea class="form-input min-h-[120px] resize-none" id="address" th:field="*{address}" placeholder="e.g. 123 ABC Street, Ward X..." required></textarea>
                                                    <span class="text-xs text-red-500" th:if="${#fields.hasErrors('address')}" th:errors="*{address}">Invalid address</span>
                        </div>
</div>
<div class="space-y-6 relative xl:pl-10 xl:border-l border-gray-100 dark:border-slate-700">
<div class="section-header justify-between">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-2xl">pets</span>
<h2 class="section-title">Pet Information</h2>
</div>
<span class="text-xs font-semibold text-primary/70 bg-primary/5 px-3 py-1 rounded-full">Multiple pets can be added</span>
</div>
<div class="space-y-6" id="pet-list-container">
<div class="p-5 border-2 border-gray-100 dark:border-slate-600 rounded-2xl bg-gray-50/50 dark:bg-slate-800/30 relative group transition-colors hover:border-primary/20">
<div class="absolute -top-3 left-4 px-3 py-0.5 bg-surface-light dark:bg-surface-dark text-xs font-bold text-primary dark:text-accent uppercase tracking-wider border border-gray-200 dark:border-slate-600 rounded-lg shadow-sm z-10">
                Pet #1
              </div>
<button class="absolute -top-3 right-4 p-1 bg-surface-light dark:bg-surface-dark text-gray-400 hover:text-red-500 border border-gray-200 dark:border-slate-600 rounded-full shadow-sm transition-colors z-10" title="Xóa thú cưng này" type="button">
<span class="material-icons-round text-sm block">close</span>
</button>
<div class="flex flex-col sm:flex-row gap-6 mt-2">
<div class="w-full sm:w-32 flex-shrink-0">
<label class="group/img block w-full aspect-square sm:h-32 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-2xl hover-border-accent hover:bg-white dark:hover:bg-slate-800 transition-all cursor-pointer flex flex-col items-center justify-center text-center p-2 bg-white dark:bg-slate-800 relative overflow-hidden">
<img class="hidden absolute inset-0 w-full h-full object-cover rounded-xl" id="preview-0"/>
<span class="material-symbols-outlined text-3xl text-gray-300 group-hover/img:text-accent mb-1 transition-colors preview-icon">add_a_photo</span>
<span class="text-[10px] font-bold text-primary dark:text-gray-300 z-10 uppercase preview-text">Ảnh</span>
<input accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer pet-image-input" type="file" data-pet-index="0"/>
<span class="text-[8px] text-gray-400 mt-1">Max 2MB</span>
</label>
</div>
                        <div class="flex-1 space-y-4">
                            <div>
                                <label class="form-label text-xs uppercase tracking-wide opacity-80" for="pet-name-1">Pet Name <span class="text-red-500">*</span></label>
                                <input class="form-input" id="pet-name-1" th:field="*{pets[0].name}" placeholder="e.g. Milu" type="text"/>
                                <span class="text-xs text-red-500" th:if="${#fields.hasErrors('pets[0].name')}" th:errors="*{pets[0].name}">Invalid pet name</span>
                            </div>
                            <div>
                                <label class="form-label text-xs uppercase tracking-wide opacity-80 mb-2">Species <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="cursor-pointer relative">
                                        <input class="peer sr-only" th:field="*{pets[0].species}" type="radio" value="dog"/>
                                        <div class="flex items-center justify-center gap-2 p-2.5 rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-500 dark:text-gray-400 transition-all hover:border-dog peer-checked:bg-dog peer-checked:text-white peer-checked:border-dog shadow-sm">
                                            <span class="material-symbols-outlined text-lg">sound_detection_dog_barking</span>
                                            <span class="font-bold text-sm">Dog</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input class="peer sr-only" th:field="*{pets[0].species}" type="radio" value="cat"/>
                                        <div class="flex items-center justify-center gap-2 p-2.5 rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-500 dark:text-gray-400 transition-all hover:border-cat peer-checked:bg-cat peer-checked:text-primary peer-checked:border-cat shadow-sm">
                                            <span class="material-symbols-outlined text-lg">pest_control_rodent</span>
                                            <span class="font-bold text-sm">Cat</span>
                                        </div>
                                    </label>
                                </div>
                                <span class="text-xs text-red-500" th:if="${#fields.hasErrors('pets[0].species')}" th:errors="*{pets[0].species}">Please select species</span>
                            </div>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                    <div>
                                        <label class="form-label text-xs uppercase tracking-wide opacity-80" for="breed-1">Breed <span class="text-red-500">*</span></label>
                                        <input class="form-input" id="breed-1" th:field="*{pets[0].breed}" placeholder="e.g. Poodle" type="text"/>
                                        <span class="text-xs text-red-500" th:if="${#fields.hasErrors('pets[0].breed')}" th:errors="*{pets[0].breed}">Invalid breed</span>
                                    </div>
                                    <div>
                                        <label class="form-label text-xs uppercase tracking-wide opacity-80" for="dob-1">Date of Birth <span class="text-red-500">*</span></label>
                                        <input class="form-input" id="dob-1" th:field="*{pets[0].birthDate}" type="date"/>
                                        <span class="text-xs text-red-500" th:if="${#fields.hasErrors('pets[0].birthDate')}" th:errors="*{pets[0].birthDate}">Invalid date of birth (cannot be after today)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
</div>
</div>
</div>
<button class="w-full py-4 border-2 border-dashed border-primary/30 hover:border-primary hover:bg-primary/5 dark:hover:bg-primary/20 rounded-2xl flex flex-col items-center justify-center gap-2 text-primary dark:text-accent font-bold transition-all group active:scale-[0.99]" id="addPetBtn" type="button">
<div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-colors">
<span class="material-icons-round text-2xl">add</span>
</div>
<span>Add another pet</span>
</button>
</div>
</form>
</div>
<div class="px-6 py-5 border-t border-gray-100 dark:border-slate-700 flex justify-end items-center gap-4 bg-gray-50 dark:bg-slate-800/50">
    <a th:href="@{/doctor/customers}" class="px-6 py-2.5 rounded-xl border-2 border-accent text-primary dark:text-accent font-bold hover:bg-accent/10 transition-all active:scale-95">Cancel</a>
    <button type="submit" form="customerForm" class="px-8 py-2.5 rounded-xl bg-accent text-primary font-bold shadow-lg shadow-accent/20 hover:brightness-95 flex items-center gap-2 transition-all active:scale-95">
        <span class="material-icons-round text-xl">save</span>
        Save
      </button>
</div>
</div>
</main>
<div class="fixed bottom-10 right-10 pointer-events-none opacity-5 dark:opacity-0 z-0">
<span class="material-icons-round text-9xl text-primary transform rotate-12">pets</span>
</div>

<script>
  let petCount = 1;
  const petListContainer = document.getElementById('pet-list-container');
  const addPetBtn = document.getElementById('addPetBtn');

  // Xử lý upload ảnh với preview
  function setupImageUploadHandlers() {
    document.querySelectorAll('.pet-image-input').forEach(input => {
      input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // Validate file size (2MB)
          if (file.size > 2 * 1024 * 1024) {
            alert('Kích thước file không được vượt quá 2MB');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(event) {
            const petIndex = e.target.getAttribute('data-pet-index');
            const previewImg = document.querySelector(`#preview-${petIndex}`);
            const icon = e.target.closest('label').querySelector('.preview-icon');
            const text = e.target.closest('label').querySelector('.preview-text');
            
            if (previewImg) {
              previewImg.src = event.target.result;
              previewImg.classList.remove('hidden');
              if (icon) icon.classList.add('hidden');
              if (text) text.classList.add('hidden');
            }
          };
          reader.readAsDataURL(file);
        }
      });
    });
  }

  setupImageUploadHandlers();

  // Add pet
  addPetBtn.addEventListener('click', () => {
    petCount++;
    const petHtml = `
      <div class="p-5 border-2 border-gray-100 dark:border-slate-600 rounded-2xl bg-gray-50/50 dark:bg-slate-800/30 relative group transition-colors hover:border-primary/20 pet-item">
        <div class="absolute -top-3 left-4 px-3 py-0.5 bg-surface-light dark:bg-surface-dark text-xs font-bold text-primary dark:text-accent uppercase tracking-wider border border-gray-200 dark:border-slate-600 rounded-lg shadow-sm z-10">
          Pet #${petCount}
        </div>
        <button class="absolute -top-3 right-4 p-1 bg-surface-light dark:bg-surface-dark text-gray-400 hover:text-red-500 border border-gray-200 dark:border-slate-600 rounded-full shadow-sm transition-colors z-10 pet-delete-btn" type="button">
          <span class="material-icons-round text-sm">close</span>
        </button>
        <div class="flex flex-col sm:flex-row gap-6 mt-2">
          <div class="w-full sm:w-32 flex-shrink-0">
            <label class="group/img block w-full aspect-square sm:h-32 border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-2xl hover:border-accent hover:bg-white dark:hover:bg-slate-800 transition-all cursor-pointer flex flex-col items-center justify-center text-center p-2 bg-white dark:bg-slate-800 relative overflow-hidden">
              <img class="hidden absolute inset-0 w-full h-full object-cover rounded-xl" id="preview-${petCount-1}"/>
              <span class="material-symbols-outlined text-3xl text-gray-300 group-hover/img:text-accent mb-1 transition-colors preview-icon">add_a_photo</span>
              <span class="text-[10px] font-bold text-primary dark:text-gray-300 z-10 uppercase preview-text">Photo</span>
              <input accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer pet-image-input" type="file" data-pet-index="${petCount-1}"/>
              <span class="text-[8px] text-gray-400 mt-1">Max 2MB</span>
            </label>
          </div>
          <div class="flex-1 space-y-4">
            <div>
              <label class="form-label text-xs uppercase tracking-wide opacity-80" for="pet-name-${petCount}">Tên thú cưng <span class="text-red-500">*</span></label>
              <input class="form-input" name="pets[${petCount-1}].name" id="pet-name-${petCount}" placeholder="Ví dụ: Milu" type="text"/>
            </div>
            <div>
              <label class="form-label text-xs uppercase tracking-wide opacity-80 mb-2">Loài <span class="text-red-500">*</span></label>
              <div class="grid grid-cols-2 gap-3">
                <label class="cursor-pointer relative">
                  <input class="peer sr-only" name="pets[${petCount-1}].species" type="radio" value="dog"/>
                  <div class="flex items-center justify-center gap-2 p-2.5 rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-500 dark:text-gray-400 transition-all hover:border-dog peer-checked:bg-dog peer-checked:text-white peer-checked:border-dog shadow-sm">
                    <span class="material-symbols-outlined text-lg">sound_detection_dog_barking</span>
                    <span class="font-bold text-sm">Dog</span>
                  </div>
                </label>
                <label class="cursor-pointer relative">
                  <input class="peer sr-only" name="pets[${petCount-1}].species" type="radio" value="cat"/>
                  <div class="flex items-center justify-center gap-2 p-2.5 rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-500 dark:text-gray-400 transition-all hover:border-cat peer-checked:bg-cat peer-checked:text-primary peer-checked:border-cat shadow-sm">
                    <span class="material-symbols-outlined text-lg">pest_control_rodent</span>
                    <span class="font-bold text-sm">Cat</span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="form-label text-xs uppercase tracking-wide opacity-80" for="breed-${petCount}">Breed <span class="text-red-500">*</span></label>
            <input class="form-input" name="pets[${petCount-1}].breed" id="breed-${petCount}" placeholder="e.g. Poodle" type="text"/>
          </div>
          <div>
            <label class="form-label text-xs uppercase tracking-wide opacity-80" for="dob-${petCount}">Date of Birth <span class="text-red-500">*</span></label>
            <input class="form-input" name="pets[${petCount-1}].birthDate" id="dob-${petCount}" type="date"/>
          </div>
        </div>
      </div>
    `;
    const newPet = document.createElement('div');
    newPet.innerHTML = petHtml;
    petListContainer.insertBefore(newPet, addPetBtn.parentElement);
    attachPetDeleteHandlers();
    setupImageUploadHandlers();
  });

  // Delete pet
  function attachPetDeleteHandlers() {
    document.querySelectorAll('.pet-delete-btn').forEach(btn => {
      btn.onclick = (e) => {
        e.preventDefault();
        const petItem = btn.closest('.pet-item');
        if (petListContainer.querySelectorAll('.pet-item').length > 1) {
          petItem.remove();
        } else {
          alert('There must be at least one pet');
        }
      };
    });
  }

  attachPetDeleteHandlers();

  // Reindex pet field names on form submit to ensure correct indices
  document.getElementById('customerForm').addEventListener('submit', (e) => {
    const pets = Array.from(document.querySelectorAll('.pet-item'));
    pets.forEach((pet, idx) => {
      pet.querySelectorAll('[name^="pets["]').forEach(field => {
        const fieldName = field.name.replace(/pets\[\d+\]/, `pets[${idx}]`);
        field.name = fieldName;
      });
    });
  });
</script>

</body></html>