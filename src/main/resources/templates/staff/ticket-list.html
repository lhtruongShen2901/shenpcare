<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Management - ShenpCare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" rel="stylesheet">
</head>


<body class="bg-[#F8F9FA] font-sans">
<div class="grid grid-cols-[220px_1fr] h-screen">

    <div th:replace="staff/layout/layout-staff :: sidebar(${staff}, null, null, 'tickets')"></div>


<div class="min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="">
            <div class="bg-white border-b  px-8 py-5 flex justify-between items-center shadow-sm">
                <div>
                    <h1 class="text-[#03594D] text-3xl font-black leading-tight tracking-tight">Danh Sach Ticket</h1>
                    <p class="text-sm text-gray-500 mt-1">Các tickets trong hệ thống</p>
                </div>

            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 bg-[#f8f8f6] ">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-2xl shadow p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Ticket tôi mở</p>
                        <p class="text-3xl font-bold text-gray-900" id="myOpenCount" th:text="${myTickets.size()}">0</p>
                    </div>
                    <i class="fas fa-folder-open text-blue-500 text-3xl"></i>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Tất cả ticket được mở</p>
                        <p class="text-3xl font-bold text-gray-900" id="allOpenCount" th:text="${allTickets.size()}">0</p>
                    </div>
                    <i class="fas fa-clipboard-list text-green-500 text-3xl"></i>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Đang xử lý</p>
                        <p class="text-3xl font-bold text-gray-900" id="inProgressCount">0</p>
                    </div>
                    <i class="fas fa-spinner text-yellow-500 text-3xl"></i>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Độ ưu tiên</p>
                        <p class="text-3xl font-bold text-gray-900" id="highPriorityCount">0</p>
                    </div>
                    <i class="fas fa-exclamation-circle text-purple-500 text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Filter & Search -->
        <div class="bg-[#f8f9fa] rounded-2xl shadow mb-6 p-4">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" id="searchInput" placeholder="Search tickets..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tất cả các trạng thái</option>
                    <option value="OPEN">Đang mở</option>
                    <option value="IN_PROGRESS">Đang xử lý</option>
                    <option value="RESOLVED">Đã được giải quyết </option>
                    <option value="CLOSED">Đã đóng</option>
                </select>
                <select id="priorityFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Tất cả độ ưu tiên</option>
                    <option value="LOW">Thấp</option>
                    <option value="MEDIUM">Trung bình</option>
                    <option value="HIGH">Cao</option>
                    <option value="URGENT">Khẩn cấp</option>
                </select>
                <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Các danh mục</option>
                    <option value="SERVICE">Dịch vụ</option>
                    <option value="PRICE">Giá tiền</option>
                    <option value="BOOKING">Đặt hàng</option>
                    <option value="ORDER">Đơn hàng</option>
                    <option value="PET_STATUS">Thú cưng</option>
                </select>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-2xl shadow">
            <div class="border-b bg-[#f8f9fa] border-gray-200">
                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                    <button onclick="switchTab('my')" id="myTab"
                            class="tab-btn border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600">
                        Ticket của tôi (<span id="myTabCount" th:text="${myTickets.size()}">0</span>)
                    </button>
                    <button onclick="switchTab('all')" id="allTab"
                            class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Tất cả tickets (<span id="allTabCount" th:text="${allTickets.size()}">0</span>)
                    </button>
                </nav>
            </div>

            <!-- My Tickets Content -->
            <div id="myTicketsContent" class="p-6">
                <div id="myTicketsList" class="space-y-4">
                    <div th:each="ticket : ${myTickets}"
                         th:attr="data-ticket-id=${ticket.id}"
                         class="ticket-item bg-gray-50 rounded-2xl p-6 border border-gray-200 hover:shadow-md transition-shadow cursor-pointer"
                         th:onclick="'window.location.href=\'/support/tickets/' + ${ticket.id} + '\''">

                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="text-xs font-semibold text-gray-500" th:text="'#' + ${ticket.id}">#001</span>
                                    <span th:class="${ticket.priority == T(g6shenpcare.models.enums.EPriority).URGENT ? 'bg-red-100 text-red-800' :
                                                        ticket.priority == T(g6shenpcare.models.enums.EPriority).HIGH ? 'bg-orange-100 text-orange-800' :
                                                        ticket.priority == T(g6shenpcare.models.enums.EPriority).MEDIUM ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-green-100 text-green-800'}"
                                          class="px-2 py-1 text-xs font-semibold rounded-full"
                                          th:text="${ticket.priority}"></span>
                                    <span th:class="${ticket.status == T(g6shenpcare.models.enums.ETicketStatus).OPEN ? 'bg-blue-100 text-blue-800' :
                                                        ticket.status == T(g6shenpcare.models.enums.ETicketStatus).IN_PROGRESS ? 'bg-purple-100 text-purple-800' :
                                                        ticket.status == T(g6shenpcare.models.enums.ETicketStatus).RESOLVED ? 'bg-green-100 text-green-800' :
                                                        'bg-gray-100 text-gray-800'}"
                                          class="px-2 py-1 text-xs font-semibold rounded-full"
                                          th:text="${ticket.status}"></span>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2" th:text="${ticket.subject}"></h3>
                                <p class="text-sm text-gray-600 line-clamp-2" th:text="${ticket.description}"></p>
                            </div>
                            <div class="ml-4">
                                    <span th:class="${ticket.category == T(g6shenpcare.models.enums.ETicketCategory).SERVICE ? 'bg-indigo-100 text-indigo-800' :
                                                    ticket.category == T(g6shenpcare.models.enums.ETicketCategory).PRICE ? 'bg-pink-100 text-pink-800' :
                                                    ticket.category == T(g6shenpcare.models.enums.ETicketCategory).BOOKING ? 'bg-cyan-100 text-cyan-800' :
                                                    ticket.category == T(g6shenpcare.models.enums.ETicketCategory).ORDER ? 'bg-amber-100 text-amber-800' :
                                                    'bg-teal-100 text-teal-800'}"
                                          class="px-3 py-1 text-xs font-semibold rounded-full"
                                          th:text="${ticket.category}"></span>
                            </div>
                        </div>

                        <div class="flex items-center justify-between text-sm text-gray-500 pt-4 border-t border-gray-200">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <i class="fas fa-user text-gray-400 mr-2"></i>
                                    <span th:text="${ticket.customer.fullName}"></span>
                                </div>
                                <div class="flex items-center" th:if="${ticket.assignedTo != null}">
                                    <i class="fas fa-user-tie text-gray-400 mr-2"></i>
                                    <span th:text="'Assigned to: ' + ${ticket.assignedTo.fullName}"></span>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-gray-400 mr-2"></i>
                                <span th:text="${#temporals.format(ticket.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                            </div>
                        </div>
                    </div>

                    <div th:if="${myTickets.isEmpty()}" class="text-center py-12">
                        <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500">No tickets assigned to you</p>
                    </div>
                </div>
            </div>

            <!-- All Tickets Content -->
            <div id="allTicketsContent" class="p-6 hidden">
                <div id="allTicketsList" class="space-y-4">
                    <div th:each="ticket : ${allTickets}"
                         th:attr="data-ticket-id=${ticket.id}"
                         class="ticket-item bg-gray-50 rounded-lg p-6 border border-gray-200 hover:shadow-md transition-shadow cursor-pointer"
                         th:onclick="'window.location.href=\'/support/tickets/' + ${ticket.id} + '\''">

                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="text-xs font-semibold text-gray-500" th:text="'#' + ${ticket.id}">#001</span>
                                    <span th:class="${ticket.priority == T(g6shenpcare.models.enums.EPriority).URGENT ? 'bg-red-100 text-red-800' :
                                                        ticket.priority == T(g6shenpcare.models.enums.EPriority).HIGH ? 'bg-orange-100 text-orange-800' :
                                                        ticket.priority == T(g6shenpcare.models.enums.EPriority).MEDIUM ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-green-100 text-green-800'}"
                                          class="px-2 py-1 text-xs font-semibold rounded-full"
                                          th:text="${ticket.priority}">MEDIUM</span>
                                    <span th:class="${ticket.status == T(g6shenpcare.models.enums.ETicketStatus).OPEN ? 'bg-blue-100 text-blue-800' :
                                                        ticket.status == T(g6shenpcare.models.enums.ETicketStatus).IN_PROGRESS ? 'bg-purple-100 text-purple-800' :
                                                        ticket.status == T(g6shenpcare.models.enums.ETicketStatus).RESOLVED ? 'bg-green-100 text-green-800' :
                                                        'bg-gray-100 text-gray-800'}"
                                          class="px-2 py-1 text-xs font-semibold rounded-full"
                                          th:text="${ticket.status}">OPEN</span>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2" th:text="${ticket.subject}">Ticket Subject</h3>
                                <p class="text-sm text-gray-600 line-clamp-2" th:text="${ticket.description}">Ticket description...</p>
                            </div>
                            <div class="ml-4">
                                    <span th:class="${ticket.category == T(g6shenpcare.models.enums.ETicketCategory).SERVICE ? 'bg-indigo-100 text-indigo-800' :
                                                    ticket.category == T(g6shenpcare.models.enums.ETicketCategory).PRICE ? 'bg-pink-100 text-pink-800' :
                                                    ticket.category == T(g6shenpcare.models.enums.ETicketCategory).BOOKING ? 'bg-cyan-100 text-cyan-800' :
                                                    ticket.category == T(g6shenpcare.models.enums.ETicketCategory).ORDER ? 'bg-amber-100 text-amber-800' :
                                                    'bg-teal-100 text-teal-800'}"
                                          class="px-3 py-1 text-xs font-semibold rounded-full"
                                          th:text="${ticket.category}">SERVICE</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-between text-sm text-gray-500 pt-4 border-t border-gray-200">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <i class="fas fa-user text-gray-400 mr-2"></i>
                                    <span th:text="${ticket.customer.fullName}">Customer Name</span>
                                </div>
                                <div class="flex items-center" th:if="${ticket.assignedTo != null}">
                                    <i class="fas fa-user-tie text-gray-400 mr-2"></i>
                                    <span th:text="'Assigned to: ' + ${ticket.assignedTo.fullName}">Assigned to</span>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-gray-400 mr-2"></i>
                                <span th:text="${#temporals.format(ticket.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span>
                            </div>
                        </div>
                    </div>

                    <div th:if="${allTickets.isEmpty()}" class="text-center py-12">
                        <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500">Chưa có ticket nào được mở</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script th:inline="javascript">
    let stompClient = null;
    const currentUsername = /*[[${staff.username}]]*/ 'staff';
    const currentUserId = /*[[${staff.userId}]]*/ 0;

    function switchTab(tab) {
        const myTab = document.getElementById('myTab');
        const allTab = document.getElementById('allTab');
        const myContent = document.getElementById('myTicketsContent');
        const allContent = document.getElementById('allTicketsContent');

        if (tab === 'my') {
            myTab.classList.add('border-blue-500', 'text-blue-600');
            myTab.classList.remove('border-transparent', 'text-gray-500');
            allTab.classList.remove('border-blue-500', 'text-blue-600');
            allTab.classList.add('border-transparent', 'text-gray-500');
            myContent.classList.remove('hidden');
            allContent.classList.add('hidden');
        } else {
            allTab.classList.add('border-blue-500', 'text-blue-600');
            allTab.classList.remove('border-transparent', 'text-gray-500');
            myTab.classList.remove('border-blue-500', 'text-blue-600');
            myTab.classList.add('border-transparent', 'text-gray-500');
            allContent.classList.remove('hidden');
            myContent.classList.add('hidden');
        }
    }

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);

            stompClient.subscribe('/user/queue/tickets/opened', function(message) {
                const ticket = JSON.parse(message.body);
                handleNewTicket(ticket);
            });

            stompClient.subscribe('/user/queue/tickets/removed', function(message) {
                const ticketId = JSON.parse(message.body);
                removeTicket(ticketId);
            });
        });
    }

    function handleNewTicket(ticket) {
        const isMyTicket = ticket.assignedTo && ticket.assignedTo.userId === currentUserId;

        removeTicket(ticket.id);

        if (isMyTicket) {
            addTicketToList(ticket, 'myTicketsList');
        }
        addTicketToList(ticket, 'allTicketsList');

        updateCounts();

        showNotification(ticket);
    }

    function removeTicket(ticketId) {
        document.querySelectorAll(`[data-ticket-id="${ticketId}"]`).forEach(el => el.remove());
        updateCounts();
    }

    function addTicketToList(ticket, listId) {
        const list = document.getElementById(listId);
        const emptyState = list.querySelector('.text-center');
        if (emptyState) emptyState.remove();

        const ticketHtml = createTicketHtml(ticket);
        list.insertAdjacentHTML('afterbegin', ticketHtml);
    }

    function createTicketHtml(ticket) {
        const priorityClass = getPriorityClass(ticket.priority);
        const statusClass = getStatusClass(ticket.status);
        const categoryClass = getCategoryClass(ticket.category);

        return `
                <div data-ticket-id="${ticket.id}"
                     class="ticket-item bg-gray-50 rounded-lg p-6 border border-gray-200 hover:shadow-md transition-shadow cursor-pointer animate-fadeIn"
                     onclick="window.location.href='/support/tickets/${ticket.id}'">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="text-xs font-semibold text-gray-500">#${ticket.id}</span>
                                <span class="${priorityClass} px-2 py-1 text-xs font-semibold rounded-full">${ticket.priority}</span>
                                <span class="${statusClass} px-2 py-1 text-xs font-semibold rounded-full">${ticket.status}</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${ticket.subject}</h3>
                            <p class="text-sm text-gray-600 line-clamp-2">${ticket.description}</p>
                        </div>
                        <div class="ml-4">
                            <span class="${categoryClass} px-3 py-1 text-xs font-semibold rounded-full">${ticket.category}</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm text-gray-500 pt-4 border-t border-gray-200">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <i class="fas fa-user text-gray-400 mr-2"></i>
                                <span>${ticket.createdBy.fullName}</span>
                            </div>
                            ${ticket.assignedTo ? `
                            <div class="flex items-center">
                                <i class="fas fa-user-tie text-gray-400 mr-2"></i>
                                <span>Gán cho : ${ticket.assignedTo.fullName}</span>
                            </div>` : ''}
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock text-gray-400 mr-2"></i>
                            <span>${formatDate(ticket.createdAt)}</span>
                        </div>
                    </div>
                </div>
            `;
    }

    function getPriorityClass(priority) {
        const classes = {
            'URGENT': 'bg-red-100 text-red-800',
            'HIGH': 'bg-orange-100 text-orange-800',
            'MEDIUM': 'bg-yellow-100 text-yellow-800',
            'LOW': 'bg-green-100 text-green-800'
        };
        return classes[priority] || 'bg-gray-100 text-gray-800';
    }

    function getStatusClass(status) {
        const classes = {
            'OPEN': 'bg-blue-100 text-blue-800',
            'IN_PROGRESS': 'bg-purple-100 text-purple-800',
            'RESOLVED': 'bg-green-100 text-green-800',
            'CLOSED': 'bg-gray-100 text-gray-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
    }

    function getCategoryClass(category) {
        const classes = {
            'SERVICE': 'bg-indigo-100 text-indigo-800',
            'PRICE': 'bg-pink-100 text-pink-800',
            'BOOKING': 'bg-cyan-100 text-cyan-800',
            'ORDER': 'bg-amber-100 text-amber-800',
            'PET_STATUS': 'bg-teal-100 text-teal-800'
        };
        return classes[category] || 'bg-gray-100 text-gray-800';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function updateCounts() {
        const myTickets = document.querySelectorAll('#myTicketsList .ticket-item');
        const allTickets = document.querySelectorAll('#allTicketsList .ticket-item');

        document.getElementById('myOpenCount').textContent = myTickets.length;
        document.getElementById('allOpenCount').textContent = allTickets.length;
        document.getElementById('myTabCount').textContent = myTickets.length;
        document.getElementById('allTabCount').textContent = allTickets.length;

        let inProgress = 0, highPriority = 0;
        document.querySelectorAll('.ticket-item').forEach(ticket => {
            const badges = ticket.querySelectorAll('.px-2.py-1.text-xs');
            if (badges.length >= 2) {
                const priority = badges[0].textContent.trim();
                const status = badges[1].textContent.trim();

                if (status === 'IN_PROGRESS') inProgress++;
                if (priority === 'HIGH' || priority === 'URGENT') highPriority++;
            }
        });

        document.getElementById('inProgressCount').textContent = inProgress;
        document.getElementById('highPriorityCount').textContent = highPriority;
    }

    function showNotification(ticket) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('New Ticket', {
                body: `${ticket.subject} - ${ticket.priority}`,
                icon: '/favicon.ico'
            });
        }
    }

    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const priority = document.getElementById('priorityFilter').value;
        const category = document.getElementById('categoryFilter').value;

        document.querySelectorAll('.ticket-item').forEach(ticket => {
            const text = ticket.textContent.toLowerCase();

            const badges = ticket.querySelectorAll('.px-2.py-1.text-xs');
            let ticketPriority = '';
            let ticketStatus = '';

            if (badges.length >= 2) {
                ticketPriority = badges[0].textContent.trim();
                ticketStatus = badges[1].textContent.trim();
            }

            const categoryBadge = ticket.querySelector('.ml-4 span');
            const ticketCategory = categoryBadge ? categoryBadge.textContent.trim() : '';

            const matchSearch = !search || text.includes(search);
            const matchStatus = !status || ticketStatus === status;
            const matchPriority = !priority || ticketPriority === priority;
            const matchCategory = !category || ticketCategory === category;

            ticket.style.display = matchSearch && matchStatus && matchPriority && matchCategory ? 'block' : 'none';
        });
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('priorityFilter').addEventListener('change', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        connect();
        updateCounts();

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    });

    const style = document.createElement('style');
    style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fadeIn {
                animation: fadeIn 0.3s ease-out;
            }
            .line-clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>