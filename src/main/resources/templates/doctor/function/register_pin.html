<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Tạo Mã PIN Bảo Mật - ShenPCare</title>
    <!-- CSRF token for AJAX requests (only if CSRF enabled) -->
    <!-- Remove or comment out these lines if CSRF is disabled in Spring Security -->
    <!--
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}" />
    -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24 }
        body { font-family: 'Inter', sans-serif; }
        .pin-input { transition: all 0.2s; }
        .pin-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
        .pin-input.error { border-color: #ef4444; box-shadow: 0 0 0 2px #fecaca; }
    </style>
</head>
<body class="bg-gray-50">
<div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 p-6 fixed h-screen overflow-y-auto shadow-lg">
        <div class="flex items-center gap-3 mb-8">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center shadow-lg">
                <span class="material-symbols-outlined text-white text-xl">security</span>
            </div>
            <h1 class="text-lg font-bold text-gray-900">ShenPCare</h1>
        </div>
        <nav class="space-y-2 mb-8">
            <a th:href="@{/doctor/dashboard}" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors text-gray-700">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="text-sm">Bảng điều khiển</span>
            </a>
            <a th:href="@{/doctor/settings}" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-blue-50 text-blue-600 font-semibold">
                <span class="material-symbols-outlined">settings</span>
                <span class="text-sm">Cài đặt</span>
            </a>
        </nav>
        <div class="pt-6 border-t border-gray-200">
            <a th:href="@{/logout}" class="flex items-center gap-3 px-4 py-2 rounded-lg text-red-600 hover:bg-red-50 transition-colors">
                <span class="material-symbols-outlined">logout</span>
                <span class="text-sm font-medium">Đăng xuất</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 flex-1 p-8">
        <div class="max-w-2xl">
            <!-- Breadcrumb -->
            <div class="mb-6 flex items-center gap-2">
                <a th:href="@{/doctor/settings}" class="flex items-center gap-1 text-blue-600 hover:text-blue-700 font-medium">
                    <span class="material-symbols-outlined text-lg">arrow_back</span>
                    <span class="text-sm">Cài đặt</span>
                </a>
                <span class="text-gray-300">/</span>
                <span class="text-sm text-gray-600">Tạo Mã PIN</span>
            </div>

            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-blue-600 text-2xl">lock</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Tạo Mã PIN Bảo Mật</h1>
                        <p class="text-gray-500 text-sm mt-1">Mã PIN 4 chữ số để xác nhận các hành động nhạy cảm</p>
                    </div>
                </div>
            </div>

            <!-- Main Card -->
            <div class="bg-white rounded-xl border border-gray-200 p-8 shadow-sm">
                <!-- Success Message -->
                <div id="successMsg" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3 animate-in fade-in">
                    <span class="material-symbols-outlined text-lg text-green-600">check_circle</span>
                    <div class="flex-1">
                        <p class="font-semibold text-green-900">Thành công!</p>
                        <p class="text-sm text-green-800">Mã PIN của bạn đã được lưu. Quay về trang cài đặt trong 2 giây...</p>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="errorMsg" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-3 animate-in fade-in">
                    <span class="material-symbols-outlined text-lg text-red-600">error</span>
                    <div class="flex-1">
                        <p class="font-semibold text-red-900">Lỗi</p>
                        <p class="text-sm text-red-800" id="errorText">Vui lòng kiểm tra lại</p>
                    </div>
                </div>

                <!-- Step Indicator -->
                <div class="mb-8 flex gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-sm">1</div>
                            <span class="text-sm font-semibold text-gray-900">Nhập mã PIN</span>
                        </div>
                        <div class="h-1 bg-blue-600 rounded-full"></div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold text-sm">2</div>
                            <span class="text-sm font-semibold text-gray-500">Xác nhận</span>
                        </div>
                        <div class="h-1 bg-gray-200 rounded-full"></div>
                    </div>
                </div>

                <!-- PIN Input Section -->
                <div class="mb-8">
                    <label class="block text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-600">edit_note</span>
                        Nhập mã PIN mới (4 chữ số)
                    </label>
                    <div class="flex gap-3 justify-center bg-gradient-to-b from-gray-50 to-gray-100 p-8 rounded-xl border-2 border-gray-200">
                        <input type="text" id="pin1" maxlength="1" inputmode="numeric" class="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg pin-input focus:outline-none" placeholder="•"/>
                        <input type="text" id="pin2" maxlength="1" inputmode="numeric" class="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg pin-input focus:outline-none" placeholder="•"/>
                        <input type="text" id="pin3" maxlength="1" inputmode="numeric" class="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg pin-input focus:outline-none" placeholder="•"/>
                        <input type="text" id="pin4" maxlength="1" inputmode="numeric" class="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg pin-input focus:outline-none" placeholder="•"/>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Nhập từng chữ số. Trường sẽ tự động chuyển đến chữ số tiếp theo.</p>
                </div>

                <!-- Confirm PIN Section -->
                <div class="mb-8">
                    <label class="block text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-600">verified</span>
                        Xác nhận mã PIN (nhập lại)
                    </label>
                    <div class="flex gap-3 justify-center bg-gradient-to-b from-gray-50 to-gray-100 p-8 rounded-xl border-2 border-gray-200">
                        <input type="text" id="confirm-pin1" maxlength="1" inputmode="numeric" class="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg pin-input focus:outline-none" placeholder="•"/>
                        <input type="text" id="confirm-pin2" maxlength="1" inputmode="numeric" class="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg pin-input focus:outline-none" placeholder="•"/>
                        <input type="text" id="confirm-pin3" maxlength="1" inputmode="numeric" class="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg pin-input focus:outline-none" placeholder="•"/>
                        <input type="text" id="confirm-pin4" maxlength="1" inputmode="numeric" class="w-16 h-16 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg pin-input focus:outline-none" placeholder="•"/>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Nhập lại mã PIN để xác nhận</p>
                </div>

                <!-- Security Tips -->
                <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm font-bold text-blue-900 mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">lightbulb</span>
                        Gợi ý bảo mật
                    </p>
                    <ul class="space-y-2 text-xs text-blue-800">
                        <li class="flex gap-2">
                            <span class="text-blue-600 font-bold">✓</span>
                            <span>Không dùng ngày sinh (01/01, 25/12...) hoặc số điện thoại</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-blue-600 font-bold">✓</span>
                            <span>Tránh dãy liên tiếp (1234, 9876, 0000, 1111...)</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-blue-600 font-bold">✓</span>
                            <span>Lưu giữ PIN cẩn thận. Không chia sẻ với bất kỳ ai</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-blue-600 font-bold">✓</span>
                            <span>Có thể thay đổi PIN bất cứ lúc nào từ trang cài đặt</span>
                        </li>
                    </ul>
                </div>

                <!-- Strength Indicator -->
                <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined">check</span>
                        Độ an toàn của mã PIN
                    </p>
                    <div class="flex gap-1">
                        <div id="strength1" class="h-2 flex-1 bg-gray-300 rounded-full transition-all duration-300"></div>
                        <div id="strength2" class="h-2 flex-1 bg-gray-300 rounded-full transition-all duration-300"></div>
                        <div id="strength3" class="h-2 flex-1 bg-gray-300 rounded-full transition-all duration-300"></div>
                        <div id="strength4" class="h-2 flex-1 bg-gray-300 rounded-full transition-all duration-300"></div>
                    </div>
                    <p class="text-xs text-gray-600 mt-2"><span id="strengthText">Chưa có dữ liệu</span></p>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="button" id="submitBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold px-6 py-3 rounded-lg transition-all active:scale-95 shadow-md flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">save</span>
                        Lưu Mã PIN
                    </button>
                    <a th:href="@{/doctor/settings}" class="px-6 py-3 rounded-lg border border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined">close</span>
                        Hủy
                    </a>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
const pinInputs = [
    document.getElementById('pin1'), 
    document.getElementById('pin2'), 
    document.getElementById('pin3'), 
    document.getElementById('pin4')
];
const confirmInputs = [
    document.getElementById('confirm-pin1'),
    document.getElementById('confirm-pin2'),
    document.getElementById('confirm-pin3'),
    document.getElementById('confirm-pin4')
];

// PIN strength checker
function updateStrength() {
    const pin = pinInputs.map(i => i.value).join('');
    const bars = [
        document.getElementById('strength1'),
        document.getElementById('strength2'),
        document.getElementById('strength3'),
        document.getElementById('strength4')
    ];
    const textEl = document.getElementById('strengthText');
    
    if (!pin || pin.length < 4) {
        bars.forEach(b => { b.className = 'h-2 flex-1 bg-gray-300 rounded-full transition-all duration-300'; });
        textEl.textContent = 'Chưa nhập đủ';
        return;
    }

    let strength = 0;
    
    // Check for repeated patterns
    if (!/^(\d)\1{3}$/.test(pin)) strength++;
    
    // Check for sequential patterns
    if (!/(0123|1234|2345|3456|4567|5678|6789|9876|8765|7654|6543|5432|4321|3210)/.test(pin)) strength++;
    
    // Check for variety (not all even/odd)
    const evens = pin.split('').filter(d => d % 2 === 0).length;
    if (evens > 0 && evens < 4) strength++;
    
    // All unique digits bonus
    if (new Set(pin).size === 4) strength++;
    
    bars.forEach((b, i) => {
        if (i < strength) {
            if (strength === 1) b.className = 'h-2 flex-1 bg-red-500 rounded-full transition-all duration-300';
            else if (strength === 2) b.className = 'h-2 flex-1 bg-yellow-500 rounded-full transition-all duration-300';
            else if (strength >= 3) b.className = 'h-2 flex-1 bg-green-500 rounded-full transition-all duration-300';
        } else {
            b.className = 'h-2 flex-1 bg-gray-300 rounded-full transition-all duration-300';
        }
    });

    if (strength === 1) textEl.textContent = 'Yếu - Rất dễ đoán';
    else if (strength === 2) textEl.textContent = 'Trung bình - Nên cải thiện';
    else if (strength === 3) textEl.textContent = 'Tốt - An toàn';
    else textEl.textContent = 'Xuất sắc - Rất an toàn';
}

// Setup PIN input handlers
function setupPinInputs(inputs) {
    inputs.forEach((input, i) => {
        input.addEventListener('input', e => {
            if (!/^\d*$/.test(e.target.value)) {
                e.target.value = '';
                return;
            }
            if (e.target.value && i < 3) {
                inputs[i + 1].focus();
            }
            updateStrength();
        });
        
        input.addEventListener('keydown', e => {
            if (e.key === 'Backspace') {
                if (!input.value && i > 0) {
                    inputs[i - 1].focus();
                    inputs[i - 1].value = '';
                } else {
                    input.value = '';
                }
                updateStrength();
            }
            if (e.key === 'ArrowRight' && i < inputs.length - 1) {
                inputs[i + 1].focus();
            }
            if (e.key === 'ArrowLeft' && i > 0) {
                inputs[i - 1].focus();
            }
        });
    });
}

setupPinInputs(pinInputs);
setupPinInputs(confirmInputs);

// Auto-focus from pin to confirm when all pins are filled
pinInputs[3].addEventListener('input', () => {
    if (pinInputs.every(i => i.value)) {
        confirmInputs[0].focus();
    }
});

// Submit handler
document.getElementById('submitBtn').addEventListener('click', async () => {
    const pin = pinInputs.map(i => i.value).join('');
    const confirmPin = confirmInputs.map(i => i.value).join('');
    const submitBtn = document.getElementById('submitBtn');

    // Reset messages
    document.getElementById('successMsg').classList.add('hidden');
    document.getElementById('errorMsg').classList.add('hidden');

    // Validation
    if (!/^\d{4}$/.test(pin)) {
        showError('Vui lòng nhập mã PIN đủ 4 chữ số');
        clearInputsError(pinInputs);
        pinInputs[0].focus();
        return;
    }

    if (pin !== confirmPin) {
        showError('Mã PIN xác nhận không khớp. Vui lòng nhập lại.');
        clearInputsError(confirmInputs);
        confirmInputs[0].focus();
        confirmInputs.forEach(i => i.value = '');
        return;
    }

    // Check weak PIN patterns
    if (/^(\d)\1{3}$/.test(pin)) {
        showError('Mã PIN quá đơn giản (0000, 1111, v.v.). Vui lòng chọn mã khác');
        return;
    }

    if (/(0123|1234|2345|3456|4567|5678|6789|9876|8765|7654|6543|5432|4321|3210)/.test(pin)) {
        showError('Mã PIN không được là dãy số liên tiếp (1234, 9876, v.v.)');
        return;
    }

    // Submit
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> Đang lưu...';

    const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    try {
        const res = await fetch('/api/pin/set', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRF-TOKEN': token 
            },
            credentials: 'same-origin',
            body: JSON.stringify({ pin })
        });

        if (res.ok) {
            showSuccess();
            pinInputs.forEach(i => i.value = '');
            confirmInputs.forEach(i => i.value = '');
            setTimeout(() => {
                window.location.href = '/doctor/settings';
            }, 2000);
        } else {
            const data = await res.json().catch(() => ({}));
            showError(data.error || 'Lỗi khi lưu mã PIN. Vui lòng thử lại');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span class="material-symbols-outlined">save</span> Lưu Mã PIN';
        }
    } catch (e) {
        showError('Lỗi kết nối: ' + e.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span class="material-symbols-outlined">save</span> Lưu Mã PIN';
    }
});

function showSuccess() {
    document.getElementById('successMsg').classList.remove('hidden');
    document.getElementById('errorMsg').classList.add('hidden');
}

function showError(msg) {
    document.getElementById('errorText').textContent = msg;
    document.getElementById('errorMsg').classList.remove('hidden');
    document.getElementById('successMsg').classList.add('hidden');
}

function clearInputsError(inputs) {
    inputs.forEach(i => i.classList.remove('error'));
}

// Focus on first input when page loads
window.addEventListener('load', () => {
    pinInputs[0].focus();
});
</script>

</body>
</html>
