<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="admin/layout :: adminHead">
        <title>Quản lý Lịch & Nghỉ Phép</title>
    </head>
    <body class="font-display bg-background-light">

        <div th:replace="admin/layout :: adminShell(~{::section}, 'schedule')">
            <section>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h1 class="text-[#03594D] text-3xl font-black">Lịch & Nhân Sự</h1>
                        <p class="text-gray-500 text-sm mt-1">Quản lý ca làm việc hành chính và duyệt nghỉ phép.</p>
                    </div>

                    <div class="flex flex-wrap gap-3 items-center">
                        <form action="/admin/schedule/view" method="get" class="relative group">
                            <input type="hidden" name="weekOffset" th:value="${weekOffset}">
                            <input type="text" name="keyword" th:value="${keyword}" placeholder="Tìm nhân viên..."
                                   class="pl-9 pr-4 py-2.5 rounded-xl border border-gray-300 text-sm w-48 focus:ring-2 focus:ring-[#03594D] focus:border-transparent shadow-sm">
                            <span class="material-symbols-outlined absolute left-2.5 top-2.5 text-gray-400 text-[18px]">search</span>
                        </form>

                        <div class="flex bg-white rounded-xl border border-gray-300 shadow-sm overflow-hidden">
                            <a th:href="@{/admin/schedule/view(weekOffset=${weekOffset - 1}, keyword=${keyword})}" class="px-3 py-2 border-r hover:bg-gray-50 text-gray-600"><span class="material-symbols-outlined text-sm">chevron_left</span></a>
                            <div class="px-4 py-2 text-sm font-bold text-[#03594D] min-w-[160px] text-center bg-gray-50 flex items-center justify-center gap-2 select-none">
                                <span class="material-symbols-outlined text-[18px]">calendar_today</span>
                                <span id="dateRangeLabel">...</span>
                            </div>
                            <a th:href="@{/admin/schedule/view(weekOffset=${weekOffset + 1}, keyword=${keyword})}" class="px-3 py-2 border-l hover:bg-gray-50 text-gray-600"><span class="material-symbols-outlined text-sm">chevron_right</span></a>
                        </div>

                        <a th:href="@{/admin/schedule/leave-management}" class="px-4 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-xl text-sm font-bold hover:bg-gray-50 shadow-sm flex items-center gap-2 transition-all" title="Cài đặt Quỹ phép & Chính sách">
                            <span class="material-symbols-outlined text-[20px]">settings_account_box</span>
                            Cấu Hình
                        </a>

                        <button onclick="openLeaveModal()" class="px-4 py-2.5 bg-orange-50 text-orange-700 border border-orange-200 rounded-xl text-sm font-bold hover:bg-orange-100 shadow-sm flex items-center gap-2 transition-all">
                            <span class="material-symbols-outlined text-[20px]">event_busy</span>
                            Duyệt Đơn
                            <span th:if="${pendingLeaves != null and !pendingLeaves.isEmpty()}" 
                                  class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full shadow-sm" 
                                  th:text="${pendingLeaves.size()}"></span>
                        </button>

                        <button onclick="openAssignModal()" class="px-5 py-2.5 bg-[#D8E268] text-[#03594D] rounded-xl text-sm font-bold hover:brightness-95 hover:shadow-md shadow-sm flex items-center gap-2 transition-all">
                            <span class="material-symbols-outlined text-[20px]">add_circle</span> Phân công
                        </button>
                    </div>
                </div>

                <div th:if="${message}" class="mb-4 p-4 rounded-xl bg-emerald-50 text-emerald-800 flex items-center gap-3 border border-emerald-100 shadow-sm animate-fade-in-down">
                    <span class="material-symbols-outlined text-xl">check_circle</span> <span th:text="${message}"></span>
                </div>
                <div th:if="${error}" class="mb-4 p-4 rounded-xl bg-red-50 text-red-800 flex items-center gap-3 border border-red-100 shadow-sm animate-fade-in-down">
                    <span class="material-symbols-outlined text-xl">error</span> <span th:text="${error}"></span>
                </div>

                <div class="bg-white border border-[#E3E5D2] rounded-2xl shadow-sm overflow-hidden flex flex-col">
                    <div class="overflow-x-auto custom-scrollbar">
                        <div class="min-w-[1000px]">
                            <div class="grid grid-cols-7 bg-[#F8F9FA] border-b border-[#E3E5D2]">
                                <div th:each="i : ${#numbers.sequence(0, 6)}" class="py-3 px-2 text-center border-r border-[#E3E5D2] last:border-r-0">
                                    <p class="text-xs font-bold text-gray-500 uppercase mb-1" th:text="${i == 6 ? 'Chủ Nhật' : 'Thứ ' + (i + 2)}">Thứ 2</p>
                                    <p class="text-lg font-black text-[#03594D] date-header transition-all" th:id="'header-' + ${i}">...</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-7 bg-white">
                                <div th:each="i : ${#numbers.sequence(0, 6)}" 
                                     class="border-r border-[#E3E5D2] last:border-r-0 p-2 space-y-2 min-h-[500px] h-auto bg-white hover:bg-gray-50/50 transition-colors" 
                                     th:id="'col-' + ${i}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="assignModal" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" onclick="closeAssignModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col animate-fade-in-up">

                        <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-[#03594D] flex items-center gap-2">
                                <span class="material-symbols-outlined">edit_calendar</span> Phân công Lịch
                            </h3>
                            <button onclick="closeAssignModal()" class="text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
                        </div>

                        <form th:action="@{/admin/schedule/assignment/save}" method="post" class="flex-1 flex overflow-hidden">
                            <div class="w-1/3 border-r border-gray-200 flex flex-col bg-gray-50/30">
                                <div class="p-4 border-b border-gray-200 space-y-3">
                                    <label class="text-xs font-bold text-gray-500 uppercase">Lọc nhân viên</label>
                                    <select id="roleFilter" onchange="loadStaffByRole()" class="w-full rounded-xl border-gray-300 text-sm focus:ring-[#03594D]">
                                        <option value="">-- Tất cả --</option>
                                        <option value="DOCTOR">Bác sĩ</option>
                                        <option value="GROOMER">Groomer</option>
                                        <option value="SUPPORT">Lễ tân</option>
                                    </select>
                                    <label class="flex items-center gap-2 cursor-pointer select-none bg-white p-2 rounded border border-gray-200 shadow-sm">
                                        <input type="checkbox" onchange="toggleAllStaff(this)" class="rounded text-[#03594D] focus:ring-[#D8E268]"> 
                                        <span class="text-sm font-bold text-gray-700">Chọn tất cả</span>
                                    </label>
                                </div>
                                <div id="staffListContainer" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
                            </div>

                            <div class="w-2/3 p-8 overflow-y-auto">
                                <div class="mb-6">
                                    <h4 class="text-sm font-bold text-gray-700 uppercase mb-3 flex items-center gap-2">
                                        <span class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs">1</span> Khoảng thời gian
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-xs font-bold text-gray-500">Từ ngày</label><input type="date" name="fromDate" required class="w-full rounded-lg border-gray-300 focus:ring-[#03594D]"></div>
                                        <div><label class="text-xs font-bold text-gray-500">Đến ngày</label><input type="date" name="toDate" required class="w-full rounded-lg border-gray-300 focus:ring-[#03594D]"></div>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-sm font-bold text-gray-700 uppercase flex items-center gap-2">
                                            <span class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs">2</span> Lặp lại thứ
                                        </h4>
                                        <label class="text-xs flex items-center gap-1 cursor-pointer text-[#03594D] font-bold hover:underline">
                                            <input type="checkbox" checked onchange="toggleAllDays(this)" class="rounded text-[#03594D]"> Chọn/Bỏ hết
                                        </label>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <label th:each="day : ${#numbers.sequence(1, 7)}" class="cursor-pointer group">
                                            <input type="checkbox" name="daysOfWeek" th:value="${day}" class="day-cb peer hidden" checked>
                                            <div class="w-10 h-10 rounded-lg border-2 border-gray-200 flex items-center justify-center text-sm font-bold text-gray-500 peer-checked:bg-[#03594D] peer-checked:text-white peer-checked:border-[#03594D] transition-all hover:bg-gray-50">
                                                <span th:text="${day == 7 ? 'CN' : 'T' + (day + 1)}">T2</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-6 p-4 bg-emerald-50 rounded-xl border border-emerald-100 relative overflow-hidden">
                                    <span class="absolute -right-4 -top-4 text-emerald-100 opacity-50"><span class="material-symbols-outlined text-[100px]">schedule</span></span>
                                    <h4 class="text-sm font-bold text-emerald-800 uppercase mb-3 relative z-10 flex items-center gap-2">
                                        <span class="w-6 h-6 rounded-full bg-emerald-200 text-emerald-800 flex items-center justify-center text-xs">3</span> Giờ làm việc
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 relative z-10">
                                        <div><label class="text-xs font-bold text-emerald-700">Bắt đầu</label><input type="time" name="customStartTime" value="08:00" class="w-full rounded-lg border-emerald-300 focus:ring-emerald-500"></div>
                                        <div><label class="text-xs font-bold text-emerald-700">Kết thúc</label><input type="time" name="customEndTime" value="17:00" class="w-full rounded-lg border-emerald-300 focus:ring-emerald-500"></div>
                                    </div>
                                    <p class="text-[11px] text-emerald-600 mt-2 italic relative z-10">
                                        * Mặc định là giờ hành chính. Bạn có thể sửa nếu cần.
                                        <br>
                                        * Hệ thống sẽ <b>bỏ qua</b> các ngày nhân viên đã được duyệt nghỉ phép.
                                    </p>
                                </div>

                                <div class="sticky bottom-0 pt-4 bg-white border-t">
                                    <button type="submit" class="w-full py-3.5 rounded-xl bg-[#03594D] text-white font-bold shadow-lg hover:shadow-xl hover:bg-[#024037] transition-all flex items-center justify-center gap-2">
                                        <span class="material-symbols-outlined">save</span> Lưu & Áp Dụng Lịch
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="leaveModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" onclick="closeLeaveModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden animate-fade-in-up">

                        <div class="flex border-b bg-gray-50">
                            <button onclick="switchTab('create')" id="tabCreate" class="w-1/2 py-4 font-bold text-center border-b-2 border-[#03594D] text-[#03594D] bg-white">
                                <span class="material-symbols-outlined align-middle text-sm mr-1">edit_document</span> Tạo Đơn
                            </button>
                            <button onclick="switchTab('approve')" id="tabApprove" class="w-1/2 py-4 font-bold text-center border-b-2 border-transparent text-gray-500 hover:text-[#03594D] hover:bg-gray-50">
                                <span class="material-symbols-outlined align-middle text-sm mr-1">approval</span> Duyệt Đơn
                                <span th:if="${pendingLeaves != null and !pendingLeaves.isEmpty()}" class="ml-1 bg-red-500 text-white text-[10px] px-1.5 rounded-full" th:text="${pendingLeaves.size()}"></span>
                            </button>
                            <button onclick="closeLeaveModal()" class="absolute right-4 top-4 text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
                        </div>

                        <div id="contentCreate" class="p-8">
                            <form th:action="@{/admin/schedule/leave/create}" method="post" class="space-y-5">

                                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-xs font-bold text-blue-800 uppercase">1. Người xin nghỉ</label>
                                        <button type="button" onclick="showStaffDetail()" class="text-xs flex items-center gap-1 text-blue-600 hover:underline font-bold">
                                            <span class="material-symbols-outlined text-[14px]">visibility</span> Xem chi tiết & Quota
                                        </button>
                                    </div>

                                    <div class="flex gap-3">
                                        <div class="w-1/3">
                                            <select id="leaveRoleFilter" onchange="loadStaffForLeave()" class="w-full rounded-lg border-blue-200 text-sm focus:ring-blue-500 bg-white">
                                                <option value="">-- Chức vụ --</option>
                                                <option value="DOCTOR">Bác sĩ</option>
                                                <option value="GROOMER">Groomer</option>
                                                <option value="SUPPORT">Lễ tân</option>
                                                <option value="STORE">Kho</option>
                                            </select>
                                        </div>
                                        <div class="w-2/3">
                                            <select name="staffId" id="leaveStaffSelect" class="w-full rounded-lg border-blue-200 text-sm focus:ring-blue-500 bg-white" required>
                                                <option value="">-- Chọn nhân viên --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <p class="text-[10px] text-blue-500 mt-2 italic">* Chọn chức vụ để lọc nhanh danh sách nhân viên.</p>
                                </div>

                                <div class="grid grid-cols-2 gap-5">
                                    <div><label class="block text-sm font-bold text-gray-700 mb-1.5">Từ ngày</label><input type="date" name="fromDate" required class="w-full rounded-xl border-gray-300 focus:ring-[#03594D]"></div>
                                    <div><label class="block text-sm font-bold text-gray-700 mb-1.5">Đến ngày</label><input type="date" name="toDate" required class="w-full rounded-xl border-gray-300 focus:ring-[#03594D]"></div>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1.5">Lý do nghỉ</label>
                                    <textarea name="reason" rows="3" class="w-full rounded-xl border-gray-300 focus:ring-[#03594D]" placeholder="VD: Bị ốm, Việc gia đình, Đi du lịch..."></textarea>
                                </div>

                                <button type="submit" class="w-full py-3 rounded-xl bg-orange-500 text-white font-bold shadow hover:bg-orange-600 transition-all flex justify-center items-center gap-2">
                                    <span class="material-symbols-outlined">send</span> Gửi Yêu Cầu
                                </button>
                            </form>
                        </div>

                        <div id="contentApprove" class="hidden p-6 bg-gray-50 h-[450px] overflow-y-auto custom-scrollbar">
                            <div th:if="${pendingLeaves == null or pendingLeaves.isEmpty()}" class="flex flex-col items-center justify-center h-full text-gray-400">
                                <span class="material-symbols-outlined text-5xl mb-2 text-gray-300">task_alt</span>
                                <p>Không có đơn nào cần duyệt.</p>
                            </div>

                            <div th:each="req : ${pendingLeaves}" class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-lg">
                                            <span th:text="${req.staffName != null ? #strings.substring(req.staffName, 0, 1) : '?'}">A</span>                                        </div>
                                        <div>
                                            <p class="font-bold text-gray-800 text-lg" th:text="${req.staffName}"></p>                                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                                <span class="material-symbols-outlined text-[14px]">calendar_month</span>
                                                <span th:text="${req.fromDate}"></span> <span class="text-gray-300">➔</span> <span th:text="${req.toDate}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="px-2.5 py-1 bg-yellow-100 text-yellow-700 text-[10px] font-bold rounded-full border border-yellow-200">PENDING</span>
                                </div>

                                <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-600 italic mb-4 border border-gray-100">
                                    "<span th:text="${req.reason}"></span>"
                                </div>

                                <form th:action="@{/admin/schedule/leave/approve}" method="post" class="flex flex-wrap items-center gap-3 pt-3 border-t border-gray-100">
                                    <input type="hidden" name="requestId" th:value="${req.requestId}">

                                    <div class="flex-1">
                                        <select name="leaveType" class="w-full text-xs border-gray-300 rounded-lg py-2 focus:ring-[#03594D]">
                                            <option value="ANNUAL">Phép năm (Có lương)</option>
                                            <option value="UNPAID">Không lương / Phạt</option>
                                            <option value="SICK">Ốm (BHXH)</option>
                                        </select>
                                    </div>

                                    <button type="submit" class="px-4 py-2 bg-[#03594D] text-white text-xs font-bold rounded-lg hover:bg-[#024037] shadow-sm flex items-center gap-1">
                                        <span class="material-symbols-outlined text-[16px]">check</span> Duyệt
                                    </button>

                                    <button type="submit" th:formaction="@{/admin/schedule/leave/reject}" class="px-4 py-2 bg-white border border-gray-300 text-gray-600 text-xs font-bold rounded-lg hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-colors flex items-center gap-1">
                                        <span class="material-symbols-outlined text-[16px]">close</span> Từ chối
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="staffDetailPopup" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black/20 backdrop-blur-[1px]" onclick="closeStaffDetail()"></div>
                    <div class="relative bg-white rounded-xl shadow-2xl w-80 p-6 animate-fade-in-up border border-gray-200">
                        <button onclick="closeStaffDetail()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined text-lg">close</span></button>

                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2 text-2xl font-bold border-4 border-white shadow-md">
                                <span id="popupAvatar">A</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800" id="popupName">Loading...</h3>
                            <p class="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-0.5 rounded-md uppercase mt-1" id="popupRole">...</p>
                        </div>

                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between border-b pb-2 border-dashed">
                                <span class="text-gray-500">Username:</span>
                                <span class="font-bold text-gray-700" id="popupUsername">...</span>
                            </div>
                            <div class="flex justify-between border-b pb-2 border-dashed">
                                <span class="text-gray-500">Chuyên môn:</span>
                                <span class="font-bold text-gray-700 truncate max-w-[150px]" id="popupSpec">...</span>
                            </div>

                            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-center">
                                <p class="text-xs text-yellow-700 mb-1 font-bold">QUỸ PHÉP NĂM CÒN LẠI</p>
                                <p class="text-2xl font-black text-yellow-600"><span id="popupQuota">0</span> <span class="text-xs font-normal text-yellow-600">ngày</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="editSlotModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm" onclick="closeEditModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden animate-fade-in-up">
                        <div class="bg-[#03594D] px-6 py-4 flex justify-between items-center text-white">
                            <h3 class="font-bold">Chỉnh sửa giờ</h3>
                            <button onclick="closeEditModal()"><span class="material-symbols-outlined text-sm">close</span></button>
                        </div>
                        <form th:action="@{/admin/schedule/update-slot}" method="post" class="p-6 space-y-4">
                            <input type="hidden" name="id" id="editScheduleId">
                            <input type="hidden" name="weekOffset" th:value="${weekOffset}">

                            <div class="text-center mb-4">
                                <p class="text-sm text-gray-500">Nhân viên</p>
                                <p class="text-lg font-bold text-[#03594D]" id="editStaffName">...</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Giờ bắt đầu</label>
                                    <input type="time" name="startTime" id="editStartTime" required class="w-full rounded-lg border-gray-300 focus:ring-[#03594D]">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Giờ kết thúc</label>
                                    <input type="time" name="endTime" id="editEndTime" required class="w-full rounded-lg border-gray-300 focus:ring-[#03594D]">
                                </div>
                            </div>

                            <button type="submit" class="w-full py-2.5 rounded-xl bg-[#03594D] text-white font-bold hover:bg-[#024037]">Cập nhật</button>
                        </form>
                    </div>
                </div>

                <script th:inline="javascript">
                    const mondayStr = /*[[${mondayDate}]]*/ '2024-01-01';
                    const calendarMap = /*[[${calendarMap}]]*/ {};
                    const weekOffset = /*[[${weekOffset}]]*/ 0;

                    document.addEventListener('DOMContentLoaded', () => {
                        // 1. Render Calendar
                        const monday = new Date(mondayStr);
                        let startStr = "", endStr = "";

                        for (let i = 0; i < 7; i++) {
                            let currentDay = new Date(monday);
                            currentDay.setDate(monday.getDate() + i);

                            const dateStr = currentDay.toISOString().split('T')[0];
                            const dd = String(currentDay.getDate()).padStart(2, '0');
                            const mm = String(currentDay.getMonth() + 1).padStart(2, '0');

                            const headerElem = document.getElementById('header-' + i);
                            headerElem.innerText = `${dd}/${mm}`;

                            const today = new Date();
                            if (currentDay.toDateString() === today.toDateString()) {
                                headerElem.classList.add('text-red-600', 'bg-red-50', 'px-3', 'py-0.5', 'rounded-full', 'border', 'border-red-100');
                                headerElem.innerText += " (Nay)";
                            }

                            if (i === 0)
                                startStr = `${dd}/${mm}`;
                            if (i === 6)
                                endStr = `${dd}/${mm}`;

                            const colElem = document.getElementById('col-' + i);
                            let schedules = calendarMap[dateStr] || [];
                            schedules.sort((a, b) => a.startTime.localeCompare(b.startTime));

                            schedules.forEach(s => {
                                let borderClass = 'border-l-orange-500';
                                let bgTimeClass = 'bg-orange-50 text-orange-700';
                                if (s.staff.role === 'DOCTOR') {
                                    borderClass = 'border-l-blue-500';
                                    bgTimeClass = 'bg-blue-50 text-blue-700';
                                } else if (s.staff.role === 'GROOMER') {
                                    borderClass = 'border-l-pink-500';
                                    bgTimeClass = 'bg-pink-50 text-pink-700';
                                }

                                const card = document.createElement('div');
                                card.className = `relative p-2.5 bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all group/card border-l-[4px] mb-2 cursor-pointer`;
                                card.classList.add(borderClass);

                                card.onclick = (e) => {
                                    if (!e.target.closest('button')) {
                                        openEditModal(s.scheduleId, s.startTime.substring(0, 5), s.endTime.substring(0, 5), s.staff.fullName);
                                    }
                                };

                                card.innerHTML = `
                                    <div class="absolute -top-2 -right-2 opacity-0 group-hover/card:opacity-100 transition-opacity z-10 flex gap-1">
                                        <form action="/admin/schedule/delete-slot" method="post" onsubmit="return confirm('Xóa ca này?');">
                                            <input type="hidden" name="id" value="${s.scheduleId}">
                                            <input type="hidden" name="weekOffset" value="${weekOffset}">
                                            <button type="submit" class="w-6 h-6 flex items-center justify-center rounded-full bg-red-500 text-white hover:bg-red-600 shadow-md">
                                                <span class="material-symbols-outlined text-[14px]">close</span>
                                            </button>
                                        </form>
                                    </div>
                                    <div class="flex justify-between items-center mb-1.5">
                                        <span class="text-[11px] font-bold px-2 py-0.5 rounded-md ${bgTimeClass} tracking-wide">
                                            ${s.startTime.substring(0, 5)} - ${s.endTime.substring(0, 5)}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-7 h-7 rounded-full bg-[#03594D] text-[#D8E268] flex items-center justify-center text-[10px] font-bold shrink-0 border-2 border-white shadow-sm">
                                            ${s.staff.fullName.charAt(0)}
                                        </div>
                                        <div class="min-w-0">
                                            <p class="text-xs font-bold text-gray-800 truncate">${s.staff.fullName}</p>
                                        </div>
                                    </div>
                                `;
                                colElem.appendChild(card);
                            });
                        }
                        document.getElementById('dateRangeLabel').innerText = `${startStr} - ${endStr}`;

                        loadStaffByRole();
                        loadStaffForLeave(); // Load default
                    });

                    // --- MODAL LOGIC ---
                    function openAssignModal() {
                        document.getElementById('assignModal').classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                    }
                    function closeAssignModal() {
                        document.getElementById('assignModal').classList.add('hidden');
                        document.body.style.overflow = '';
                    }

                    function openEditModal(id, start, end, name) {
                        document.getElementById('editScheduleId').value = id;
                        document.getElementById('editStartTime').value = start;
                        document.getElementById('editEndTime').value = end;
                        document.getElementById('editStaffName').innerText = name;
                        document.getElementById('editSlotModal').classList.remove('hidden');
                    }
                    function closeEditModal() {
                        document.getElementById('editSlotModal').classList.add('hidden');
                    }

                    function openLeaveModal() {
                        document.getElementById('leaveModal').classList.remove('hidden');
                    }
                    function closeLeaveModal() {
                        document.getElementById('leaveModal').classList.add('hidden');
                    }

                    function switchTab(tab) {
                        if (tab === 'create') {
                            document.getElementById('contentCreate').classList.remove('hidden');
                            document.getElementById('contentApprove').classList.add('hidden');
                            document.getElementById('tabCreate').classList.add('border-[#03594D]', 'text-[#03594D]', 'bg-white');
                            document.getElementById('tabCreate').classList.remove('text-gray-500');
                            document.getElementById('tabApprove').classList.remove('border-[#03594D]', 'text-[#03594D]', 'bg-white');
                            document.getElementById('tabApprove').classList.add('text-gray-500', 'border-transparent');
                        } else {
                            document.getElementById('contentCreate').classList.add('hidden');
                            document.getElementById('contentApprove').classList.remove('hidden');
                            document.getElementById('tabApprove').classList.add('border-[#03594D]', 'text-[#03594D]', 'bg-white');
                            document.getElementById('tabApprove').classList.remove('text-gray-500');
                            document.getElementById('tabCreate').classList.remove('border-[#03594D]', 'text-[#03594D]', 'bg-white');
                            document.getElementById('tabCreate').classList.add('text-gray-500', 'border-transparent');
                        }
                    }

                    // --- FETCH DATA ---

                    // 1. Load Staff cho Assign Modal
                    async function loadStaffByRole() {
                        const role = document.getElementById('roleFilter').value;
                        const container = document.getElementById('staffListContainer');

                        // Lấy nút "Chọn tất cả"
                        const selectAllCb = document.querySelector('#assignModal input[onchange="toggleAllStaff(this)"]');

                        container.innerHTML = '<p class="text-xs text-center py-2 text-gray-400">Đang tải...</p>';

                        // Reset nút chọn tất cả
                        if (selectAllCb) {
                            selectAllCb.checked = false;
                            selectAllCb.disabled = true; // Tạm khóa khi đang tải
                        }

                        try {
                            const res = await fetch(`/admin/schedule/api/staff-by-role?role=${role}`);
                            const data = await res.json();
                            container.innerHTML = '';

                            if (data.length === 0) {
                                container.innerHTML = '<div class="text-center py-4"><span class="material-symbols-outlined text-gray-300 text-3xl">person_off</span><p class="text-xs text-gray-400 mt-1">Không tìm thấy nhân viên</p></div>';
                                // Vẫn khóa nút chọn tất cả nếu không có dữ liệu
                                if (selectAllCb)
                                    selectAllCb.disabled = true;
                                return;
                            }

                            // Có dữ liệu -> Mở khóa nút chọn tất cả
                            if (selectAllCb)
                                selectAllCb.disabled = false;

                            data.forEach(s => {
                                const item = document.createElement('label');
                                item.className = 'flex items-center gap-3 p-2.5 rounded-xl hover:bg-white cursor-pointer transition-all border border-transparent hover:border-gray-200 hover:shadow-sm group';
                                item.innerHTML = `<input type="checkbox" name="staffIds" value="${s.userId}" class="staff-cb w-4 h-4 rounded text-[#03594D] focus:ring-[#D8E268]"> 
                                          <div class="flex-1 min-w-0">
                                              <p class="text-sm font-bold text-gray-700 truncate">${s.fullName}</p>
                                              <p class="text-[10px] text-gray-400">@${s.username}</p>
                                          </div>`;
                                container.appendChild(item);
                            });
                        } catch (e) {
                            console.error(e);
                            container.innerHTML = '<p class="text-xs text-red-400 text-center">Lỗi tải dữ liệu</p>';
                        }
                    }

                    // 2. Load Staff cho Leave Modal (Dropdown)
                    async function loadStaffForLeave() {
                        const role = document.getElementById('leaveRoleFilter').value;
                        const select = document.getElementById('leaveStaffSelect');
                        select.innerHTML = '<option>Loading...</option>';

                        try {
                            // Nếu role rỗng thì API trả về tất cả
                            const res = await fetch(`/admin/schedule/api/staff-by-role?role=${role}`);
                            const data = await res.json();
                            select.innerHTML = '<option value="">-- Chọn nhân viên --</option>';
                            data.forEach(s => {
                                const opt = document.createElement('option');
                                opt.value = s.userId;
                                opt.text = s.fullName;
                                select.appendChild(opt);
                            });
                        } catch (e) {
                            console.error(e);
                        }
                    }

                    // 3. Show Detail Popup
                    async function showStaffDetail() {
                        const staffId = document.getElementById('leaveStaffSelect').value;
                        if (!staffId) {
                            alert("Vui lòng chọn nhân viên trước!");
                            return;
                        }

                        document.getElementById('staffDetailPopup').classList.remove('hidden');

                        try {
                            const res = await fetch(`/admin/schedule/api/staff-detail?id=${staffId}`);
                            const data = await res.json();

                            document.getElementById('popupName').innerText = data.fullName;
                            document.getElementById('popupAvatar').innerText = data.fullName.charAt(0);
                            document.getElementById('popupRole').innerText = data.role;
                            document.getElementById('popupUsername').innerText = data.username;
                            document.getElementById('popupSpec').innerText = data.specialization || 'N/A';

                            const quota = data.quotaTotal;
                            const quotaEl = document.getElementById('popupQuota');
                            quotaEl.innerText = quota;

                            if (quota <= 0) {
                                quotaEl.parentElement.classList.replace('text-yellow-600', 'text-red-600');
                                quotaEl.parentElement.parentElement.classList.replace('bg-yellow-50', 'bg-red-50');
                            } else {
                                quotaEl.parentElement.classList.replace('text-red-600', 'text-yellow-600');
                                quotaEl.parentElement.parentElement.classList.replace('bg-red-50', 'bg-yellow-50');
                            }

                        } catch (e) {
                            console.error(e);
                        }
                    }

                    function closeStaffDetail() {
                        document.getElementById('staffDetailPopup').classList.add('hidden');
                    }

                    function toggleAllStaff(src) {
                        document.querySelectorAll('.staff-cb').forEach(cb => cb.checked = src.checked);
                    }
                    function toggleAllDays(src) {
                        document.querySelectorAll('.day-cb').forEach(cb => cb.checked = src.checked);
                    }
                </script>
            </section>
        </div>
    </body>
</html>