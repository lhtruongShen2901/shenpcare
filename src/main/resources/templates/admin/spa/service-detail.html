<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/layout :: adminHead"><title>Chi tiết Dịch vụ Spa</title></head>
<body class="font-display bg-background-light">
<div th:replace="admin/layout :: adminShell(~{::section}, ${activeMenu})">
<section>
    <div class="mx-auto max-w-6xl">
        <div class="mb-6 flex items-center justify-between">
            <div>
                <a th:href="@{/admin/services}" class="text-sm text-gray-500 hover:text-[#03594D] flex items-center gap-1 mb-2">
                    <span class="material-symbols-outlined text-sm">arrow_back</span> Quay lại danh sách
                </a>
                <h1 class="text-[#03594D] text-3xl font-black" th:text="${isEdit} ? 'Chỉnh sửa Dịch vụ Spa' : 'Thêm Dịch vụ Spa Mới'"></h1>
            </div>
            <div th:if="${isEdit}">
                <form th:action="@{/admin/services/delete}" method="post" onsubmit="return confirm('Bạn có chắc muốn xóa dịch vụ này không?');">
                    <input type="hidden" name="id" th:value="${service.serviceId}">
                    <button type="submit" class="text-red-600 text-sm font-bold bg-red-50 px-4 py-2 rounded-lg hover:bg-red-100 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">delete</span> Xóa
                    </button>
                </form>
            </div>
        </div>

        <form th:action="@{/admin/services/save}" th:object="${service}" method="post" enctype="multipart/form-data" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <input type="hidden" th:field="*{serviceId}"/>
            <input type="hidden" th:field="*{version}"/>
            <input type="hidden" th:field="*{combo}" value="false"/>

            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-[#E3E5D2]">
                    <label class="block text-sm font-bold text-[#03594D] mb-3">Hình ảnh đại diện</label>
                    <div class="relative w-full aspect-square bg-gray-50 rounded-xl border-2 border-dashed hover:border-[#D8E268] cursor-pointer group overflow-hidden">
                        <input type="file" name="imageFile" accept="image/*" onchange="previewImage(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"/>
                        <img id="imagePreview" th:if="*{imageFileId != null}" th:src="@{'/api/files/' + *{imageFileId}}" class="absolute inset-0 w-full h-full object-cover z-10"/>
                        <img id="imagePreview" th:if="*{imageFileId == null}" class="hidden absolute inset-0 w-full h-full object-cover z-10"/>
                        <div id="uploadPlaceholder" th:classappend="*{imageFileId != null} ? 'hidden' : ''" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-0">
                            <span class="material-symbols-outlined text-4xl mb-2">add_photo_alternate</span>
                            <span class="text-xs font-medium">Tải ảnh lên</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-[#E3E5D2] space-y-4">
                    <label class="block">
                        <span class="text-xs font-bold text-gray-500 uppercase">Loại dịch vụ</span>
                        <select th:field="*{serviceType}" class="w-full mt-1 p-2 rounded-lg border bg-gray-50 font-bold text-[#03594D]">
                            <option value="SINGLE">Dịch vụ lẻ</option>
                            <option value="ADDON">Dịch vụ đi kèm</option>
                        </select>
                    </label>
                    <label class="block">
                        <span class="text-xs font-bold text-gray-500 uppercase">Thứ tự hiển thị</span>
                        <input type="number" th:field="*{sortOrder}" class="w-full mt-1 p-2 rounded-lg border">
                    </label>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-sm font-bold text-gray-700">Trạng thái hoạt động</span>
                        <input type="checkbox" th:field="*{active}" class="w-5 h-5 accent-[#03594D]">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-[#E3E5D2]">
                    <h3 class="text-xl font-bold text-[#03594D] mb-6 flex items-center gap-2"><span class="material-symbols-outlined">edit_note</span> Thông tin cơ bản</h3>
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <label class="block"><span class="label">Tên dịch vụ *</span><input type="text" th:field="*{name}" required class="input-field" placeholder="VD: Tắm Gội..."/></label>
                            <label class="block"><span class="label">Danh mục *</span>
                                <select th:field="*{serviceCategoryId}" required class="input-field">
                                    <option th:each="cat : ${categories}" th:value="${cat.serviceCategoryId}" th:text="${cat.name}"></option>
                                </select>
                            </label>
                        </div>

                        <div class="p-5 bg-blue-50 rounded-xl border border-blue-100">
                            <label class="block mb-4">
                                <span class="label text-blue-800">Mô hình tính giá</span>
                                <select id="priceModelSelect" th:field="*{priceModel}" class="w-full mt-1 p-2.5 rounded-lg border border-blue-200 font-bold text-blue-800" onchange="togglePriceUI()">
                                    <option value="FIXED">Giá Cố định</option>
                                    <option value="MATRIX">Giá theo Cân nặng (Matrix)</option>
                                    <option value="PER_UNIT">Giá theo Đơn vị (VD: Kg)</option>
                                </select>
                            </label>
                            <div id="areaFixedPrice" class="grid grid-cols-2 gap-4">
                                <label><span class="label">Đơn giá (VNĐ)</span><input type="number" th:field="*{fixedPrice}" class="input-field font-mono font-bold text-[#03594D]" placeholder="0"></label>
                                <label id="areaUnit"><span class="label">Đơn vị tính</span>
                                    <select th:field="*{priceUnit}" class="input-field"><option value="LẦN">Lần</option><option value="KG">Kg</option><option value="GIỜ">Giờ</option></select>
                                </label>
                            </div>
                            <div id="areaMatrixInfo" class="hidden text-sm text-gray-600 italic mt-2">
                                <span class="material-symbols-outlined text-sm align-middle">info</span> Vui lòng lưu thông tin trước, bảng cấu hình giá sẽ hiện bên dưới.
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-6">
                            <label class="block"><span class="label">Loài áp dụng</span><select th:field="*{targetSpecies}" class="input-field"><option value="BOTH">Cả hai</option><option value="DOG">Chó</option><option value="CAT">Mèo</option></select></label>
                            <label class="block"><span class="label">Thời lượng (Phút) *</span><input type="number" th:field="*{durationMinutes}" required min="0" step="5" class="input-field"/></label>
                            <label class="block"><span class="label">Tags</span><input type="text" th:field="*{tags}" class="input-field" placeholder="SPA, GROOM..."/></label>
                        </div>
                        <label class="block"><span class="label">Mô tả</span><textarea th:field="*{description}" rows="4" class="input-field h-auto py-3"></textarea></label>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="submit" class="px-8 py-3 rounded-xl bg-[#D8E268] text-[#03594D] font-bold shadow-md">Lưu Thông tin</button>
                    </div>
                </div>

                <div id="matrixSection" class="hidden bg-white rounded-2xl p-8 shadow-sm border border-[#E3E5D2]">
                    <h3 class="text-xl font-bold text-[#03594D] mb-6 flex items-center gap-2"><span class="material-symbols-outlined">calculate</span> Bảng giá chi tiết</h3>
                    
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                        <p class="text-xs font-bold text-gray-50 uppercase mb-3">Thêm khoảng giá (Nhập số thập phân dùng dấu phẩy)</p>
                        <div class="grid grid-cols-12 gap-2 items-end">
                            <div class="col-span-2">
                                <label class="sub-label">Loài</label>
                                <select id="mxSpecies" class="sub-input"><option value="DOG">Chó</option><option value="CAT">Mèo</option></select>
                            </div>
                            <div class="col-span-2">
                                <label class="sub-label">Min (Kg)</label>
                                <input type="text" id="mxMin" class="sub-input" placeholder="0,5">
                            </div>
                            <div class="col-span-2">
                                <label class="sub-label">Max (Kg)</label>
                                <input type="text" id="mxMax" class="sub-input" placeholder="5,0">
                            </div>
                            <div class="col-span-2">
                                <label class="sub-label">Lông</label>
                                <select id="mxCoat" class="sub-input"><option value="ALL">Tất cả</option><option value="SHORT">Ngắn</option><option value="LONG">Dài</option></select>
                            </div>
                            <div class="col-span-3">
                                <label class="sub-label">Giá (VNĐ)</label>
                                <input type="number" id="mxPrice" step="1000" class="sub-input font-bold text-[#03594D]">
                            </div>
                            <div class="col-span-1">
                                <button type="button" onclick="addMatrixRow()" class="w-full h-[36px] bg-[#03594D] text-white rounded font-bold hover:bg-[#024038] text-lg">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-hidden border border-gray-200 rounded-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500 font-bold text-xs uppercase border-b">
                                <tr><th class="px-4 py-3">Loài</th><th class="px-4 py-3">Lông</th><th class="px-4 py-3">Cân nặng (Kg)</th><th class="px-4 py-3 text-right">Giá tiền</th><th class="px-4 py-3 text-center">Xóa</th></tr>
                            </thead>
                            <tbody id="matrixBody" class="divide-y divide-gray-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        const currentServiceId = "[[${service.serviceId}]]";

        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = document.getElementById('imagePreview');
                    if(img) { img.src = e.target.result; img.classList.remove('hidden'); }
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function togglePriceUI() {
            const select = document.getElementById('priceModelSelect');
            if(!select) return;
            const model = select.value;
            const areaFixed = document.getElementById('areaFixedPrice');
            const areaUnit = document.getElementById('areaUnit');
            const areaMatrixInfo = document.getElementById('areaMatrixInfo');
            const matrixSection = document.getElementById('matrixSection');

            if (model === 'MATRIX') {
                if(areaFixed) areaFixed.classList.add('hidden');
                if(areaMatrixInfo) areaMatrixInfo.classList.remove('hidden');
                if(matrixSection && currentServiceId && currentServiceId !== 'null') matrixSection.classList.remove('hidden');
            } else {
                if(areaFixed) areaFixed.classList.remove('hidden');
                if(areaMatrixInfo) areaMatrixInfo.classList.add('hidden');
                if(matrixSection) matrixSection.classList.add('hidden');
                if(areaUnit) {
                    if (model === 'FIXED') areaUnit.classList.add('opacity-50', 'pointer-events-none');
                    else areaUnit.classList.remove('opacity-50', 'pointer-events-none');
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            togglePriceUI();
            if(currentServiceId && currentServiceId !== 'null') loadMatrixData();
        });

        // [FIX] URL API CHUẨN: /admin/services/...
        function loadMatrixData() {
            fetch(`/admin/services/${currentServiceId}/matrix`)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('matrixBody');
                    tbody.innerHTML = '';
                    if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400 text-xs">Chưa có dữ liệu</td></tr>'; return; }
                    data.forEach(item => {
                        const price = new Intl.NumberFormat('vi-VN').format(item.price);
                        const min = new Intl.NumberFormat('vi-VN').format(item.minWeight);
                        const max = new Intl.NumberFormat('vi-VN').format(item.maxWeight);
                        
                        tbody.insertAdjacentHTML('beforeend', `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 font-bold text-xs text-gray-600">${item.petSpecies}</td>
                                <td class="px-4 py-3 text-xs">${item.coatLength}</td>
                                <td class="px-4 py-3 text-sm font-mono">${min} - ${max}</td>
                                <td class="px-4 py-3 text-right font-bold text-[#03594D]">${price} ₫</td>
                                <td class="px-4 py-3 text-center"><button type="button" onclick="deleteMatrix(${item.pricingId})" class="text-red-400 hover:text-red-600">×</button></td>
                            </tr>`);
                    });
                });
        }

        function addMatrixRow() {
            let minStr = document.getElementById('mxMin').value.replace(',', '.');
            let maxStr = document.getElementById('mxMax').value.replace(',', '.');
            
            const payload = {
                serviceId: parseInt(currentServiceId),
                petSpecies: document.getElementById('mxSpecies').value,
                coatLength: document.getElementById('mxCoat').value,
                minWeight: parseFloat(minStr) || 0,
                maxWeight: parseFloat(maxStr) || 999,
                price: parseFloat(document.getElementById('mxPrice').value) || 0
            };

            if(payload.price <= 0) { alert("Vui lòng nhập giá tiền"); return; }
            
            // [FIX] URL API CHUẨN
            fetch('/admin/services/matrix/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
                .then(res => { if(res.ok) { loadMatrixData(); document.getElementById('mxPrice').value = ''; } else { alert('Lỗi lưu'); } });
        }

        function deleteMatrix(id) {
            // [FIX] URL API CHUẨN
            if(confirm("Xóa dòng giá này?")) fetch(`/admin/services/matrix/${id}`, {method: 'DELETE'}).then(res => { if(res.ok) loadMatrixData(); });
        }
    </script>
    <style>
        .label { @apply block text-xs font-bold text-gray-500 uppercase mb-1; }
        .input-field { @apply w-full h-11 px-4 rounded-xl border border-gray-200 bg-[#F8F9FA] focus:bg-white focus:ring-2 focus:ring-[#D8E268] outline-none transition-all; }
        .sub-label { @apply text-[10px] text-gray-500 font-bold block mb-1; }
        .sub-input { @apply w-full text-sm h-[36px] px-2 rounded border border-gray-300 outline-none bg-white focus:border-[#03594D]; }
    </style>
</section>
</div>
</body>
</html>